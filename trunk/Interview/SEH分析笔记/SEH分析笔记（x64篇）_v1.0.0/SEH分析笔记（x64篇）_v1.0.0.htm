<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>SEH x64</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
body {
  margin: 5px 5px 5px 5px;
  background-color: #ffffff;
}
/* ========== Text Styles ========== */
hr { color: #000000}
body, table, span.rvts0 /* Normal text */
{
 font-size: 10pt;
 font-family: 'Arial', 'Helvetica', sans-serif;
 font-style: normal;
 font-weight: normal;
 color: #000000;
 text-decoration: none;
}
span.rvts1 /* Heading */
{
 font-size: 12pt;
 font-weight: bold;
 color: #000000;
}
span.rvts2 /* Subheading */
{
 font-weight: bold;
 color: #000080;
}
span.rvts3 /* Keywords */
{
 font-style: italic;
 color: #800000;
}
a.rvts4, span.rvts4 /* Jump 1 */
{
 color: #0000ff;
 text-decoration: underline;
}
a.rvts5, span.rvts5 /* Jump 2 */
{
 color: #008000;
 text-decoration: underline;
}
span.rvts6 /* Font Style */
{
 font-size: 8pt;
}
span.rvts7
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
}
span.rvts8
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
}
span.rvts9
{
 font-family: 'Consolas';
 color: #000000;
}
span.rvts10
{
 font-family: 'Consolas';
 color: #000000;
 background-color: #ffffff;
}
span.rvts11
{
 font-family: 'Consolas';
 color: #000000;
 background-color: #ffffff;
}
span.rvts12
{
 font-family: 'Consolas';
 color: #000000;
}
a.rvts13, span.rvts13
{
 font-family: 'Consolas';
 color: #0000ff;
 text-decoration: underline;
}
a.rvts14, span.rvts14
{
 font-family: 'Consolas';
 text-decoration: none;
}
span.rvts15
{
 font-family: 'Consolas';
}
span.rvts16
{
 font-family: 'Consolas';
 color: #0000ff;
 text-decoration: underline;
}
span.rvts17
{
 font-family: 'Consolas';
}
span.rvts18
{
 font-family: 'Consolas';
}
span.rvts19
{
 font-family: 'Consolas';
}
span.rvts20
{
 font-family: 'Consolas';
 color: #ff8000;
 background-color: #ffffff;
}
span.rvts21
{
 font-family: 'Consolas';
 color: #000080;
 background-color: #ffffff;
}
span.rvts22
{
 font-family: 'Consolas';
 color: #0000ff;
 background-color: #ffffff;
}
span.rvts23
{
 font-family: 'Consolas';
 font-weight: bold;
}
span.rvts24
{
 font-family: 'Consolas';
 color: #8000ff;
 background-color: #ffffff;
}
span.rvts25
{
 font-family: 'Consolas';
 color: #008000;
 background-color: #ffffff;
}
span.rvts26
{
 font-family: 'Consolas';
 color: #804000;
 background-color: #ffffff;
}
span.rvts27
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
 background-color: #ffffff;
}
span.rvts28
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
 background-color: #ffffff;
}
span.rvts29
{
 font-family: 'Consolas';
 color: #0080ff;
 background-color: #ffffff;
}
span.rvts30
{
 font-family: 'Consolas';
 color: #008000;
 background-color: #ffffff;
}
span.rvts31
{
 font-family: 'Consolas';
 color: #8080ff;
 background-color: #ffffcc;
}
span.rvts32
{
 font-family: 'Consolas';
 color: #ff0000;
 background-color: #ffffff;
}
span.rvts33
{
 font-family: 'Consolas';
 text-decoration: underline;
}
span.rvts34
{
 font-family: 'Consolas';
 font-weight: bold;
}
span.rvts35
{
 font-family: 'Consolas';
 color: #0000ff;
}
span.rvts36
{
 font-family: 'Consolas';
 color: #ff6600;
}
span.rvts37
{
 font-family: 'Consolas';
 color: #808080;
 background-color: #ffffff;
}
span.rvts38
{
 font-family: 'Consolas';
 color: #ff6600;
 background-color: #ffffff;
}
/* ========== Para Styles ========== */
p,ul,ol /* Paragraph Style */
{
 text-align: left;
 text-indent: 0px;
 padding: 0px 0px 0px 0px;
 margin: 0px 0px 0px 0px;
}
.rvps1 /* Centered */
{
 text-align: center;
}
--></style>
</head>
<body>
<p><br></p>
<p><span class=rvts7> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts7>SEH</span><span class=rvts8>分析笔记（</span><span class=rvts7>X64</span><span class=rvts8>篇）</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.0</span></p>
<p><span class=rvts7> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>boxcounter</span></p>
<p><span class=rvts9><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>历史：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.0, 2011-11-4</span><span class=rvts12>：最初版本。</span></p>
<p><span class=rvts9><br></span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>[</span><span class=rvts12>不介意转载，但请注明出处</span><span class=rvts9> </span><a class=rvts13 href="http://www.boxcounter.com/">www.boxcounter.com</a><span class=rvts9> </span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts12>附件里有本文的原始稿，一样的内容，更好的高亮和排版。</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts12>本文的部分代码可能会因为论坛的自动换行变得很乱，需要的朋友手动复制到自己的代码编辑器就可以正常显示了</span><span class=rvts9>]</span></p>
<p><span class=rvts9><br></span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts12>在之前的《</span><span class=rvts9>SEH</span><span class=rvts12>分析笔记（</span><span class=rvts9>X86</span><span class=rvts12>篇）》中，我借助</span><span class=rvts9> wrk1.2 </span><span class=rvts12>介绍了</span><span class=rvts9> x86 </span><span class=rvts12>下</span><span class=rvts9> windows </span><span class=rvts12>系统内核中的</span><span class=rvts9> SEH </span><span class=rvts12>实现。这次我们来看看</span><span class=rvts9> x64 </span><span class=rvts12>位</span><span class=rvts9> windows </span><span class=rvts12>系统内核中</span><span class=rvts9> SEH </span><span class=rvts12>的实现。</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts12>本文需要大家熟悉</span><span class=rvts9> x64 </span><span class=rvts12>位系统的一些特性，比如调用约定、</span><span class=rvts9>Prolog </span><span class=rvts12>和</span><span class=rvts9> Epilog</span><span class=rvts12>。可以通过这几篇文章熟悉一下</span><span class=rvts9>:</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><a class=rvts13 href="http://msdn.microsoft.com/en-us/library/ms235286.aspx">Overview of x64 Calling Conventions</a><a class=rvts14 href="http://msdn.microsoft.com/en-us/library/ms235286.aspx">,</a><span class=rvts15> MSDN</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><a class=rvts13 href="http://blogs.msdn.com/b/oldnewthing/archive/2004/01/14/58579.aspx">The history of calling conventions, part 5: amd64</a><span class=rvts15> , The Old New Thing</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><a class=rvts13 href="http://msdn.microsoft.com/en-us/magazine/cc300794.aspx">Everything You Need To Know To Start Programming 64-Bit Windows Systems</a><span class=rvts15>, Matt Pietrek</span></p>
<p><span class=rvts16><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>首先回顾一下前一篇文章。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>在</span><span class=rvts15> x86 windows </span><span class=rvts17>中，函数通过以下几个步骤来参与</span><span class=rvts15> SEH </span><span class=rvts17>：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts17>在自身的栈空间中分配并初始化一个</span><span class=rvts15> EXCEPTION_REGISTRATION(_RECORD) </span><span class=rvts17>结构体。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts17>将该</span><span class=rvts15> EXCEPTION_REGISTRATION(_RECORD) </span><span class=rvts17>挂入当前线程的异常链表。</span></p>
<p><span class=rvts16><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>当某函数触发异常时，系统首先会通过调用</span><span class=rvts15> KiDispatchException </span><span class=rvts17>来给内核调试器一个机会，如果内核调试器没有处理该异常，则该机会被转给</span><span class=rvts15> RtlDispatchException</span><span class=rvts17>，这个函数就开始分发该异常。分发过程为：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>从当前线程的异常链表头开始遍历，对于每一个</span><span class=rvts15> SEH </span><span class=rvts17>注册信息（即</span><span class=rvts15> EXCEPTION_REGISTRATION(_RECORD)</span><span class=rvts17>），调用其</span><span class=rvts15> Handler</span><span class=rvts17>。根据</span><span class=rvts15> Handler </span><span class=rvts17>的返回值做相应的后续处理：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts17>返回</span><span class=rvts15> </span><span class=rvts18>ExceptionContinueExecution</span><span class=rvts19>，表示</span><span class=rvts18> Handler </span><span class=rvts19>已经修复了异常触发点，从异常触发点继续执行。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. </span><span class=rvts19>返回</span><span class=rvts18> ExceptionContinueSearch</span><span class=rvts19>，表示该</span><span class=rvts18> Handler </span><span class=rvts19>没有处理该异常，继续遍历异常链表。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. Handler </span><span class=rvts19>没有修复异常触发点，但是却能处理该异常（某个</span><span class=rvts18> __except </span><span class=rvts19>过滤代码返回</span><span class=rvts18> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts19>）。这种情况下，处理完该异常后就从异常解决代码（</span><span class=rvts18>__except </span><span class=rvts19>代码块）继续执行，</span><span class=rvts18>Handler </span><span class=rvts19>不会返回。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>以上是简略的</span><span class=rvts18> x86 SEH </span><span class=rvts19>流程，其中省略了很多细节，比如展开、错误处理、</span><span class=rvts18>ExceptionNestedException </span><span class=rvts19>和</span><span class=rvts18> ExceptionCollidedUnwind </span><span class=rvts19>等等。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>之所以在这里重温这个流程，是因为</span><span class=rvts18> x64 </span><span class=rvts19>中</span><span class=rvts18> SEH </span><span class=rvts19>的流程总体思路也是如此，只是细节上做了一些修改。但这并不表示熟悉</span><span class=rvts18> x86 SEH </span><span class=rvts19>就能很轻松的掌握</span><span class=rvts18> x64 SEH</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>本文分为四个部分：“异常注册”、“异常分发”、“展开、解决”和“</span><span class=rvts18>ExceptionNestedException </span><span class=rvts19>和</span><span class=rvts18> ExceptionCollidedUnwind</span><span class=rvts19>”。依然以</span><span class=rvts18> MSC </span><span class=rvts19>的增强版为分析对象。分析环境为：</span><span class=rvts10>WDK 7600.16385.1</span><span class=rvts11>，内置的</span><span class=rvts10> cl </span><span class=rvts11>的版本是</span><span class=rvts10>15.00.30729.207</span><span class=rvts11>，</span><span class=rvts10>link </span><span class=rvts11>的版本是</span><span class=rvts10>9.00.30729.207</span><span class=rvts11>，测试虚拟机系统为</span><span class=rvts10> amd64 WinXP + wrk1.2</span><span class=rvts11>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>在讲述之前，需要先定义几个名词，以简化后续的讲述。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RVA </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>熟悉</span><span class=rvts18> PE </span><span class=rvts19>格式的朋友都懂的，表示某个绝对地址相对于所在模块的基地址的偏移。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_POINT </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>异常触发点。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_FILTER </span><span class=rvts19>——</span><span class=rvts18> __except </span><span class=rvts19>小括号内的异常过滤代码。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_HANDLER </span><span class=rvts19>——</span><span class=rvts18> __except </span><span class=rvts19>大括号内的异常解决代码。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>FINALLY_HANDLER </span><span class=rvts19>——</span><span class=rvts18> __finally </span><span class=rvts19>大括号内的代码。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>以下面的伪码为例，</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>1</span><span class=rvts10>&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>2</span><span class=rvts10>&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>3</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>4</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>5</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>*((</span><span class=rvts10>ULONG</span><span class=rvts21>*)</span><span class=rvts22>NULL</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts21>=</span><span class=rvts10> 0</span><span class=rvts21>;</span><span class=rvts10> </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>6</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>7</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>((</span><span class=rvts10>STATUS_INVALID_PARAMETER </span><span class=rvts21>==</span><span class=rvts10> GetExceptionCode</span><span class=rvts21>())</span><span class=rvts10> </span><span class=rvts21>?</span><span class=rvts10> EXCEPTION_CONTINUE_SEARCH </span><span class=rvts21>:</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>8</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>9</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>...</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>10</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>11</span><span class=rvts10> </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>12</span><span class=rvts10> __finally</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>13</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>14</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>...</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>15</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_POINT </span><span class=rvts19>指的是行</span><span class=rvts18>5</span><span class=rvts19>中的代码。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_FILTER </span><span class=rvts19>指的是行</span><span class=rvts18>7</span><span class=rvts19>中的“</span><span class=rvts18>(STATUS_INVALID_PARAMETER == GetExceptionCode()) ? EXCEPTION_CONTINUE_SEARCH : EXCEPTION_EXECUTE_HANDLER</span><span class=rvts19>”。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPT_HANDLER </span><span class=rvts19>指的是行</span><span class=rvts18>8</span><span class=rvts19>到行</span><span class=rvts18>10</span><span class=rvts19>中所有的代码。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>FINALLY_HANDLER </span><span class=rvts19>指的是行</span><span class=rvts18>13</span><span class=rvts19>到行</span><span class=rvts18>15</span><span class=rvts19>中所有的代码。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts23>一、异常注册</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>在</span><span class=rvts18> x64 windows </span><span class=rvts19>中，异常注册信息发生了巨大的改变。</span><span class=rvts18>x86 </span><span class=rvts19>中异常注册信息是在函数执行过程中在栈中分配并初始化的。</span><span class=rvts18>x64 </span><span class=rvts19>中变成这样：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>异常注册信息不再是动态创建，而是编译过程中生成，链接时写入</span><span class=rvts18> PE+ </span><span class=rvts19>头中的</span><span class=rvts18> ExceptionDirectory</span><span class=rvts19>（参考</span><span class=rvts18> winnt.h </span><span class=rvts19>中</span><span class=rvts18> IMAGE_RUNTIME_FUNCTION_ENTRY </span><span class=rvts19>的定义）。</span><span class=rvts18>ExceptionDirectory </span><span class=rvts19>里包含几乎所有函数的栈操作、异常处理等信息。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>来看看新异常注册信息的数据结构：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _RUNTIME_FUNCTION </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG BeginAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG EndAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG UnwindData</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PRUNTIME_FUNCTION</span><span class=rvts21>;</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>enum</span><span class=rvts10> _UNWIND_OP_CODES </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_PUSH_NONVOL </span><span class=rvts21>=</span><span class=rvts10> </span><span class=rvts20>0</span><span class=rvts21>,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_ALLOC_LARGE</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_ALLOC_SMALL</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SET_FPREG</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 3</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SAVE_NONVOL</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 4</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SAVE_NONVOL_FAR</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>// 5</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SPARE_CODE1</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 6</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SPARE_CODE2</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 7</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SAVE_XMM128</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 8</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_SAVE_XMM128_FAR</span><span class=rvts21>,</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>// 9</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UWOP_PUSH_MACHFRAME&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>// 10</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> UNWIND_OP_CODES</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PUNWIND_OP_CODES</span><span class=rvts21>;</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>union</span><span class=rvts10> _UNWIND_CODE </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>struct</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UCHAR CodeOffset</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UCHAR UnwindOp </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>4</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UCHAR OpInfo </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>4</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>};</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; USHORT FrameOffset</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> UNWIND_CODE</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PUNWIND_CODE</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNW_FLAG_NHANDLER 0x0</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNW_FLAG_EHANDLER 0x1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNW_FLAG_UHANDLER 0x2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNW_FLAG_CHAININFO 0x4</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _UNWIND_INFO </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR Version </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>3</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR Flags </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>5</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR SizeOfProlog</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR CountOfCodes</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR FrameRegister </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>4</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UCHAR FrameOffset </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts20>4</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; UNWIND_CODE UnwindCode</span><span class=rvts21>[</span><span class=rvts20>1</span><span class=rvts21>];</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>// The unwind codes are followed by an optional DWORD aligned field that</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>// contains the exception handler address or a function table entry if</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>// chained unwind information is specified. If an exception handler address</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>// is specified, then it is followed by the language specified exception</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>// handler data.</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp; union {</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct {</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG ExceptionHandler;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG ExceptionData[];</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RUNTIME_FUNCTION FunctionEntry;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//&nbsp; };</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>//</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> UNWIND_INFO</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PUNWIND_INFO</span><span class=rvts21>;</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _SCOPE_TABLE </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG Count</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>struct</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG BeginAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG EndAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG HandlerAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG JumpTarget</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span><span class=rvts10> ScopeRecord</span><span class=rvts21>[</span><span class=rvts20>1</span><span class=rvts21>];</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> SCOPE_TABLE</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PSCOPE_TABLE</span><span class=rvts21>;</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>x64 </span><span class=rvts11>中，</span><span class=rvts10>MSC </span><span class=rvts11>为几乎所有的函数都登记了完备的信息，用来在展开过程中完整的回滚函数所做的栈、寄存器操作。登记的信息包括：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数是否使用了</span><span class=rvts10> SEH</span><span class=rvts11>、</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数使用的是什么组合的</span><span class=rvts10> SEH</span><span class=rvts11>（</span><span class=rvts10>__try/__except</span><span class=rvts11>？</span><span class=rvts10>__try/__finally</span><span class=rvts11>？）、</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数申请了多少栈空间、</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数保存了哪些寄存器、</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数是否建立了栈帧，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>等等，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>同时也记录了这些操作的顺序（以保证回滚的时候不会乱套）。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>这些信息就存储在</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>之中。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNWIND_INFO </span><span class=rvts11>相当于</span><span class=rvts10> x86 </span><span class=rvts11>下的</span><span class=rvts10> EXCEPTION_REGISTRATION</span><span class=rvts11>。它的成员分别是：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Version </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>结构体的版本。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Flags </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>标志位，可以有这么几种取值：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNW_FLAG_NHANDLER (0x0): </span><span class=rvts11>表示既没有</span><span class=rvts10> EXCEPT_FILTER </span><span class=rvts11>也没有</span><span class=rvts10> EXCEPT_HANDLER</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNW_FLAG_EHANDLER (0x1): </span><span class=rvts11>表示该函数有</span><span class=rvts10> EXCEPT_FILTER &amp; EXCEPT_HANDLER</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNW_FLAG_UHANDLER (0x2): </span><span class=rvts11>表示该函数有</span><span class=rvts10> FINALLY_HANDLER</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNW_FLAG_CHAININFO (0x4): </span><span class=rvts11>表示该函数有多个</span><span class=rvts10> UNWIND_INFO</span><span class=rvts11>，它们串接在一起（所谓的</span><span class=rvts10> chain</span><span class=rvts11>）。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SizeOfProlog </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>表示该函数的</span><span class=rvts10> Prolog </span><span class=rvts11>指令的大小，单位是</span><span class=rvts10> byte</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>CountOfCodes </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>表示当前</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>包含多少个</span><span class=rvts10> UNWIND_CODE </span><span class=rvts11>结构。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>FrameRegister </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>如果函数建立了栈帧，它表示栈帧的索引（相对于</span><span class=rvts10> CONTEXT::RAX </span><span class=rvts11>的偏移，详情参考</span><span class=rvts10> RtlVirtualUnwind </span><span class=rvts11>源码）。否则该成员的值为</span><span class=rvts10>0</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>FrameOffset </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>表示</span><span class=rvts10> FrameRegister </span><span class=rvts11>距离函数最初栈顶（刚进入函数，还没有执行任何指令时的栈顶）的偏移，单位也是</span><span class=rvts10> byte</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UnwindCode </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>是一个</span><span class=rvts10> UNWIND_CODE </span><span class=rvts11>类型的数组。元素数量由</span><span class=rvts10> CountOfCodes </span><span class=rvts11>决定。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>需要说明几点：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1. </span><span class=rvts11>如果</span><span class=rvts10> Flags </span><span class=rvts11>设置了</span><span class=rvts10> UNW_FLAG_EHANDLER </span><span class=rvts11>或</span><span class=rvts10> UNW_FLAG_UHANDLER</span><span class=rvts11>，那么在最后一个</span><span class=rvts10> UNWIND_CODE </span><span class=rvts11>之后存放着</span><span class=rvts10> ExceptionHandler</span><span class=rvts11>（相当于</span><span class=rvts10> x86 EXCEPTION_REGISTRATION::handler</span><span class=rvts11>）和</span><span class=rvts10> ExceptionData</span><span class=rvts11>（相当于</span><span class=rvts10> x86 EXCEPTION_REGISTRATION::scopetable</span><span class=rvts11>）。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2. UnwindCode </span><span class=rvts11>数组详细记录了函数修改栈、保存非易失性寄存器的指令。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3. MSDN </span><span class=rvts11>中有</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>和</span><span class=rvts10> UNWIND_CODE </span><span class=rvts11>的详细说明，推荐阅读。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>那</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>是如何与其描述的函数关联起来的呢？答案是：通过一个</span><span class=rvts10> RUNTIME_FUNCTION </span><span class=rvts11>结构体。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RUNTIME_FUNCTION::BeginAddress </span><span class=rvts11>同</span><span class=rvts10> RUNTIME_FUNCTION::EndAddress </span><span class=rvts11>一起以</span><span class=rvts10> RVA </span><span class=rvts11>形式描述了函数的范围。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RUNTIME_FUNCTION::UnwindData </span><span class=rvts11>就是</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>了，它也是一个</span><span class=rvts10> RVA </span><span class=rvts11>值。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>PE+ </span><span class=rvts11>中的</span><span class=rvts10> ExceptionDirectory </span><span class=rvts11>中存放着所有函数的</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts11>，按</span><span class=rvts10> RUNTIME_FUNCTION::BeginAddress </span><span class=rvts11>升序排列。一旦触发异常，系统可以通过</span><span class=rvts10> EXCEPT_POINT </span><span class=rvts11>的</span><span class=rvts10> RVA </span><span class=rvts11>在</span><span class=rvts10> ExceptionDirectory </span><span class=rvts11>中二分查找到</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts11>，进而找到</span><span class=rvts10> UNWIND_INFO</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>前面有提到，</span><span class=rvts10>MSC </span><span class=rvts11>为几乎所有的函数都登记了完毕的信息，那是不是有一些特殊函数没有登记信息呢？</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>是的。</span><span class=rvts10>x64 </span><span class=rvts11>新增了一个概念，叫做“叶函数”。熟悉数据结构的朋友可能第一时间就联想到“叶节点”。没错，“叶函数”的含义跟“叶节点”很类似，叶函数不会有子函数，也就是说它不会再调用任何函数。另外</span><span class=rvts10> x64 </span><span class=rvts11>对这个概念额外加了一些要求：不修改栈指针（比如分配栈空间）、没有使用</span><span class=rvts10> SEH</span><span class=rvts11>。总结下来就是：既不调用函数、又没有修改栈指针，也没有使用</span><span class=rvts10> SEH </span><span class=rvts11>的函数就叫做“叶函数”。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>叶函数可以没有登记信息，原因很简单，它根本就没信息需要登记</span><span class=rvts10>~</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>还有一个</span><span class=rvts10> SCOPE_TABLE </span><span class=rvts11>结构，熟悉</span><span class=rvts10> x86 SEH </span><span class=rvts11>的朋友应该很眼熟</span><span class=rvts10> :-)</span><span class=rvts11>，它等同于</span><span class=rvts10> x86 SEH </span><span class=rvts11>中的</span><span class=rvts10> REGISTRATIOIN_RECORD::scopetable </span><span class=rvts11>的类型。其成员有：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Count </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>表示</span><span class=rvts10> ScopeRecord </span><span class=rvts11>数组的大小。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ScopeRecord </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>等同于</span><span class=rvts10> x86 </span><span class=rvts11>中的</span><span class=rvts10> scopetable_entry </span><span class=rvts11>成员。其中，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>BeginAddress </span><span class=rvts11>和</span><span class=rvts10> EndAddress </span><span class=rvts11>表示某个</span><span class=rvts10> __try </span><span class=rvts11>保护域的范围。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>HandlerAddress </span><span class=rvts11>和</span><span class=rvts10> JumpTarget </span><span class=rvts11>表示</span><span class=rvts10> EXCEPTION_FILTER</span><span class=rvts11>、</span><span class=rvts10>EXCEPT_HANDLER </span><span class=rvts11>和</span><span class=rvts10> FINALLY_HANDLER</span><span class=rvts11>。具体对应情况为：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>对于</span><span class=rvts10> __try/__except </span><span class=rvts11>组合，</span><span class=rvts10>HandlerAddress </span><span class=rvts11>代表</span><span class=rvts10> EXCEPT_FILTER</span><span class=rvts11>，</span><span class=rvts10>JumpTarget </span><span class=rvts11>代表</span><span class=rvts10> EXCEPT_HANDLER</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>对于</span><span class=rvts10> __try/__finally </span><span class=rvts11>组合，</span><span class=rvts10>HandlerAddress </span><span class=rvts11>代表</span><span class=rvts10> FINALLY_HANDLER</span><span class=rvts11>，</span><span class=rvts10>JumpTarget </span><span class=rvts11>等于</span><span class=rvts10> 0</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>这四个域通常都是</span><span class=rvts10> RVA</span><span class=rvts11>，但当</span><span class=rvts10> EXCEPT_FILTER </span><span class=rvts11>简单地返回或等于</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER </span><span class=rvts11>时，</span><span class=rvts10>HandlerAddress </span><span class=rvts11>可能直接等于</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts11>，而不再是一个</span><span class=rvts10> RVA</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>我们可以通过</span><span class=rvts10> windbg </span><span class=rvts11>中的</span><span class=rvts10> .fnent </span><span class=rvts11>命令来查看某个函数的异常注册信息。比如，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1&nbsp;&nbsp; kd&gt; .fnent passThrough!SehTest</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2&nbsp;&nbsp; Debugger function entry 00000000`00778210 for:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3&nbsp;&nbsp; d:\workspace\code\mycode\r0\passthrough\passthrough.c(51)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>4&nbsp;&nbsp; (fffffadf`f140f020)&nbsp;&nbsp; PassThrough!SehTest&nbsp;&nbsp; |&nbsp; (fffffadf`f140f0c0)&nbsp;&nbsp; PassThrough!Caller2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>5&nbsp;&nbsp; Exact matches:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest (void)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>7&nbsp;&nbsp; </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>8&nbsp;&nbsp; BeginAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`00001020</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>9&nbsp;&nbsp; EndAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`000010b2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>10&nbsp; UnwindInfoAddress = 00000000`00002668</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>11&nbsp; </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>12&nbsp; Unwind info at fffffadf`f1410668, 10 bytes</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>13&nbsp;&nbsp;&nbsp; version 1, flags 1, prolog 4, codes 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>14&nbsp;&nbsp;&nbsp; handler routine: PassThrough!_C_specific_handler (fffffadf`f140f4ce), data 3</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>15&nbsp;&nbsp;&nbsp; 00: offs 4, unwind op 2, op info 4</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UWOP_ALLOC_SMALL.</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>行</span><span class=rvts10>8</span><span class=rvts11>到行</span><span class=rvts10>10</span><span class=rvts11>描述的是</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>行</span><span class=rvts10>12</span><span class=rvts11>到行</span><span class=rvts10>15</span><span class=rvts11>描述的是</span><span class=rvts10> UNWIND_INFO</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>对于叶函数，输出是这样的，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>kd&gt; .fnent passthrough!LeafTest</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>No function entry for fffffadf`f240c080</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>到这里，异常注册就讲完了，我们认识了相关的数据结构和定位方法。下面我们进入异常分发流程。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts27>二、异常分发</span></p>
<p><span class=rvts28><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>x64 </span><span class=rvts11>异常分发过程使用的仍然是</span><span class=rvts10> KiDispatchException</span><span class=rvts11>、</span><span class=rvts10>RtlDispatchException</span><span class=rvts11>、</span><span class=rvts10>RtlpExecuteHandlerForException </span><span class=rvts11>等函数。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>其中，</span><span class=rvts10>KiDispatchException </span><span class=rvts11>中有关内核异常部分的代码完全没有变化，这里我偷懒直接拷贝《</span><span class=rvts10>SEH</span><span class=rvts11>分析笔记（</span><span class=rvts10>X86</span><span class=rvts11>篇）》中的部分描述，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>原型：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>VOID</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>KiDispatchException (</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PKEXCEPTION_FRAME ExceptionFrame,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PKTRAP_FRAME TrapFrame,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN KPROCESSOR_MODE PreviousMode,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN BOOLEAN FirstChance</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>对于内核异常，它的处理步骤如下：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>如果</span><span class=rvts10> FirstChance </span><span class=rvts11>为</span><span class=rvts10> TRUE</span><span class=rvts11>，那么</span><span class=rvts10>,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1. </span><span class=rvts11>首先将该异常传达给内核调试器（</span><span class=rvts10>KD</span><span class=rvts11>），如果</span><span class=rvts10> KD </span><span class=rvts11>处理了该异常，那么函数返回。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2. KD </span><span class=rvts11>没有处理，调用</span><span class=rvts10> RtlDispatchException </span><span class=rvts11>进行异常分发。如果分发成功，</span><span class=rvts10>RtlDispatchExcetpion </span><span class=rvts11>返回</span><span class=rvts10> TRUE</span><span class=rvts11>，或者根本不返回。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3. RtlDispatchException </span><span class=rvts11>分发失败，那么再给</span><span class=rvts10> KD </span><span class=rvts11>一次处理机会，如果还是没有处理，那么</span><span class=rvts10> BUGCHECK</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>如果</span><span class=rvts10> FirstChance </span><span class=rvts11>为</span><span class=rvts10> FALSE</span><span class=rvts11>，那么将该异常传达给</span><span class=rvts10> KD</span><span class=rvts11>，如果</span><span class=rvts10> KD </span><span class=rvts11>没有处理，那么</span><span class=rvts10> BUGCHECK</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>它的源码实现位于</span><span class=rvts10> $WRK-v1.2\base\ntos\ke\amd64\exceptn.c:430</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlDispatchException </span><span class=rvts11>发生了一些改变。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>从之前描述的异常注册信息的数据结构可以发现，</span><span class=rvts10>x64 </span><span class=rvts11>中已经不存在异常注册链这个概念了（虽然</span><span class=rvts10> _NT_TIB </span><span class=rvts11>结构体中还保留了</span><span class=rvts10> ExceptionList </span><span class=rvts11>域）。那</span><span class=rvts10> x64 </span><span class=rvts11>中</span><span class=rvts10> RtlDispatchException </span><span class=rvts11>是如何遍历异常注册信息的呢？前面虽然有提到如何通过</span><span class=rvts10> EXCEPT_POINT </span><span class=rvts11>找到</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>结构，但是假如这个</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>没有处理该异常，如何继续遍历呢？</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>在解答这个问题之前，我们先来认识一个新函数和相关的数据结构，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNWIND_HISTORY_TABLE_SIZE 12</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _UNWIND_HISTORY_TABLE_ENTRY </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG64 ImageBase</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRUNTIME_FUNCTION FunctionEntry</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> UNWIND_HISTORY_TABLE_ENTRY</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PUNWIND_HISTORY_TABLE_ENTRY</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNWIND_HISTORY_TABLE_NONE 0</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNWIND_HISTORY_TABLE_GLOBAL 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>#define UNWIND_HISTORY_TABLE_LOCAL 2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _UNWIND_HISTORY_TABLE </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG Count</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UCHAR Search</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG64 LowAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG64 HighAddress</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UNWIND_HISTORY_TABLE_ENTRY Entry</span><span class=rvts21>[</span><span class=rvts10>UNWIND_HISTORY_TABLE_SIZE</span><span class=rvts21>];</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> UNWIND_HISTORY_TABLE</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PUNWIND_HISTORY_TABLE</span><span class=rvts21>;</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>PRUNTIME_FUNCTION</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlLookupFunctionEntry (</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN ULONG64 ControlPc,</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; OUT PULONG64 ImageBase,</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN OUT PUNWIND_HISTORY_TABLE HistoryTable OPTIONAL</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlLookupFunctionEntry </span><span class=rvts11>的功能是查找指定地址所在函数的</span><span class=rvts10> RUNTIME_FUNCTION </span><span class=rvts11>和所在模块的基地址。它的参数分为为，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ControlPc </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>需要查找的指令地址，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ImageBase </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>返回的模块基地址，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>HistoryTable </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>用于加速查找。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>工作流程：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlLookupFunctionEntry </span><span class=rvts19>在搜索的过程会根据是否传入</span><span class=rvts18> HistoryTable </span><span class=rvts19>而采取不同的搜索方法：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>如果传入</span><span class=rvts18> HistoryTable</span><span class=rvts19>，则根据</span><span class=rvts18> HistoryTable-&gt;</span><span class=rvts10>Search </span><span class=rvts11>表示的搜索方式</span><span class=rvts19>在表中进行搜索：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>如果搜索方式为</span><span class=rvts18> UNWIND_HISTORY_TABLE_NONE</span><span class=rvts19>，那么不在</span><span class=rvts18> HistoryTable </span><span class=rvts19>中进行搜索。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>如果搜索方式为</span><span class=rvts18> UNWIND_HISTORY_TABLE_GLOBAL</span><span class=rvts19>，则首先在全局表</span><span class=rvts18> RtlpUnwindHistoryTable </span><span class=rvts19>开始搜索，如果搜索到，则结束搜索，函数返回。否则再在</span><span class=rvts18> HistoryTable </span><span class=rvts19>中搜索。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>如果搜索方式为</span><span class=rvts18> UNWIND_HISTORY_TABLE_LOCAL</span><span class=rvts19>，那么在</span><span class=rvts18> HistoryTable </span><span class=rvts19>中搜索。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>如果上述过程中没有搜索到需要的结果，那么找到模块基地址，从模块的</span><span class=rvts18> PE+ </span><span class=rvts19>头结构中解析出</span><span class=rvts18> RUNTIME_FUNCTION</span><span class=rvts19>。如果搜索方式为</span><span class=rvts18> UNWIND_HISTORY_TABLE_NONE</span><span class=rvts19>，还会将解决加入到</span><span class=rvts18> HistoryTable</span><span class=rvts19>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>之前的描述中</span><span class=rvts10> RtlDispatchException </span><span class=rvts11>定位</span><span class=rvts10> EXCEPT_POINT </span><span class=rvts11>所对应的</span><span class=rvts10> RUNTIME_FUNCTION </span><span class=rvts11>就是通过调用</span><span class=rvts10> RtlLookupFunctionEntry </span><span class=rvts11>实现的。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>回到刚才的问题，如何推动遍历呢？为了解决这个问题，</span><span class=rvts10>x64 </span><span class=rvts11>又引进了一个新函数。现在我们有请</span><span class=rvts10> x64 SEH </span><span class=rvts11>核心成员</span><span class=rvts10> RtlVirtualUnwind </span><span class=rvts11>登场</span><span class=rvts10>~</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>先来看看它的原型：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>PEXCEPTION_ROUTINE</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlVirtualUnwind (</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN ULONG HandlerType,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN ULONG64 ImageBase,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN ULONG64 ControlPc,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PRUNTIME_FUNCTION FunctionEntry,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PCONTEXT ContextRecord,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; OUT PVOID *HandlerData,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; OUT PULONG64 EstablisherFrame,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PKNONVOLATILE_CONTEXT_POINTERS ContextPointers OPTIONAL</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>它的主要功能是：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>根据传入的</span><span class=rvts18> ControlPc </span><span class=rvts19>和</span><span class=rvts18> ContextRecord </span><span class=rvts19>等参数虚拟（模拟）展开该函数，并返回该函数的一些信息，比如</span><span class=rvts18> HandlerData</span><span class=rvts19>（</span><span class=rvts18>SCOPE_TABLE</span><span class=rvts19>）、</span><span class=rvts18>EstablisherFrame</span><span class=rvts19>（</span><span class=rvts18>rsp </span><span class=rvts19>或</span><span class=rvts18> </span><span class=rvts19>栈帧）。</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>流程是：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. </span><span class=rvts19>通过</span><span class=rvts18> FunctionEntry </span><span class=rvts19>和</span><span class=rvts18> ImageBase </span><span class=rvts19>找到</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>。根据</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>中记录的信息，查找</span><span class=rvts18> EstablisherFrame</span><span class=rvts19>（即栈帧或者</span><span class=rvts18> rsp</span><span class=rvts19>）。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. </span><span class=rvts19>根据</span><span class=rvts18> ControlPc </span><span class=rvts19>分如下两种情况展开：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>a. ControlPc &gt;= EpilogOffset</span><span class=rvts19>，即</span><span class=rvts18> ControlPc </span><span class=rvts19>在</span><span class=rvts18> Epilog </span><span class=rvts19>之中。那么把剩余的</span><span class=rvts18> Epilog </span><span class=rvts19>指令模拟执行完毕即可。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>所谓模拟是指，如果下一条</span><span class=rvts18> EpiLog </span><span class=rvts19>指令是“</span><span class=rvts18>sub rsp, 0x32</span><span class=rvts19>”，那么将</span><span class=rvts18> ContextRecord-&gt;rsp </span><span class=rvts19>减去</span><span class=rvts18>0x32</span><span class=rvts19>。并不是真正执行</span><span class=rvts18> sub </span><span class=rvts19>指令。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>b. ControlPc &lt; EpilogOffset</span><span class=rvts19>，那么把</span><span class=rvts18> Prolog </span><span class=rvts19>反向模拟回滚一遍即可。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>所谓反向回滚是指，如果</span><span class=rvts18> Prolog </span><span class=rvts19>的指令是</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; mov&nbsp;&nbsp; [RSP + 8], RCX</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; push R15</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; push R14</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; push R13 </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>那么反向回滚就是</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop ContextRecord-&gt;R13 </span><span class=rvts19>（实际上是从</span><span class=rvts18> ContextRecord-&gt;Rsp </span><span class=rvts19>指向的内存中取出值存入</span><span class=rvts18> ContextRecord-&gt;R13</span><span class=rvts19>，然后</span><span class=rvts18> ContextRecord-&gt;Rsp </span><span class=rvts19>加上</span><span class=rvts18>8</span><span class=rvts19>。并不是真正执行</span><span class=rvts18> pop</span><span class=rvts19>）</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop ContextRecord-&gt;R14</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop ContextRecord-&gt;R15</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov ContextRecord-&gt;RCX, [ContextRecord-&gt;RSP+8]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>然后把</span><span class=rvts18> ContextRecord-&gt;Rip </span><span class=rvts19>修改为</span><span class=rvts18> ControlPc </span><span class=rvts19>所在函数的返回地址，即父函数中的某一处</span><span class=rvts18> call </span><span class=rvts19>的下一条指令。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>这样，</span><span class=rvts18>ContextRecord </span><span class=rvts19>就被恢复成父函数在调用</span><span class=rvts18> ControlPc </span><span class=rvts19>所在函数之后的状态了。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. </span><span class=rvts19>如果</span><span class=rvts18> HandlerType </span><span class=rvts19>包含</span><span class=rvts18> UNW_FLAG_EHANDLER </span><span class=rvts19>或</span><span class=rvts18> UNW_FLAG_UHANDLER</span><span class=rvts19>，那么将</span><span class=rvts18> UNWIND_INFO::ExceptionData </span><span class=rvts19>赋给传出参数</span><span class=rvts18> HandlerData</span><span class=rvts19>，并返回</span><span class=rvts18> UNWIND_INFO::ExceptionRoutine</span><span class=rvts19>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>对于</span><span class=rvts18> MSC </span><span class=rvts19>编译器生成的模块，</span><span class=rvts18>UNWIND_INFO::ExceptionRoutine </span><span class=rvts19>一般指向</span><span class=rvts18> nt!__C_specific_handler</span><span class=rvts19>。</span><span class=rvts18>UNWIND_INFO::ExceptionData </span><span class=rvts19>指向</span><span class=rvts18> ControlPc </span><span class=rvts19>所在函数的</span><span class=rvts18> SCOPE_TABLE</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlVirtualUnwind </span><span class=rvts19>的实现源码位于</span><span class=rvts18> $WRK-v1.2\base\ntos\rtl\amd64\exdsptch.c:1202</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlVirtualUnwind </span><span class=rvts19>返回后，</span><span class=rvts18>RtlDispatchException </span><span class=rvts19>就可以根据</span><span class=rvts18> ContextRecord-&gt;Rip </span><span class=rvts19>找到父函数对应的</span><span class=rvts18> RUNTIME_FUNCTION</span><span class=rvts19>，进而找到</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>。就这样推动整个遍历过程。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>这是一般情况，对于没有</span><span class=rvts10> UNWIND_INFO </span><span class=rvts11>的叶函数呢？</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>对于叶函数，</span><span class=rvts18>RtlLookupFunctionEntry </span><span class=rvts19>返回</span><span class=rvts18> NULL</span><span class=rvts19>，于是</span><span class=rvts18> RtlDispatchException </span><span class=rvts19>知道这是个叶函数，就找到该叶函数的父函数，从父函数继续遍历。也就是完全无视叶函数，因为叶函数对整个异常处理过程没有任何影响。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlDispatchException </span><span class=rvts11>调用</span><span class=rvts10> UNWIND_INFO::ExceptionHandler </span><span class=rvts11>依然是通过</span><span class=rvts10> RtlpExecuteHandlerForException</span><span class=rvts11>，其函数原型没有变化：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>EXCEPTION_DISPOSITION</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlpExecuteHandlerForException (</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PVOID EstablisherFrame,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PCONTEXT ContextRecord,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PVOID DispatcherContext</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>该函数的实现源码位于</span><span class=rvts10> $\WRK-v1.2\base\ntos\rtl\amd64\xcptmisc.asm:84</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlpExecuteHandlerForException </span><span class=rvts11>的逻辑较</span><span class=rvts10> x86 </span><span class=rvts11>版本没什么大变化，内部注册了一个异常处理函数</span><span class=rvts10> RtlpExceptionHandler</span><span class=rvts11>。</span><span class=rvts10>RtlpExceptionHandler </span><span class=rvts11>相当于</span><span class=rvts10> x86 </span><span class=rvts11>中的</span><span class=rvts10> nt!ExecuteHandler2</span><span class=rvts11>，其内部会返回</span><span class=rvts10> ExceptionNestedException </span><span class=rvts11>或</span><span class=rvts10> ExceptionContinueSearch</span><span class=rvts11>。它的实现源码位于</span><span class=rvts10> $\WRK-v1.2\base\ntos\rtl\amd64\xcptmisc.asm:26</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>需要一提的是，最后一个参数</span><span class=rvts10> DispatchContext </span><span class=rvts11>的类型是</span><span class=rvts10> DISPATCHER_CONTEXT</span><span class=rvts11>，相对于</span><span class=rvts10> x86 </span><span class=rvts11>版本，它扩充了很多，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts22>typedef</span><span class=rvts10> </span><span class=rvts24>struct</span><span class=rvts10> _DISPATCHER_CONTEXT </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG64 ControlPc</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG64 ImageBase</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PRUNTIME_FUNCTION FunctionEntry</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG64 EstablisherFrame</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG64 TargetIp</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PCONTEXT ContextRecord</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PEXCEPTION_ROUTINE LanguageHandler</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PVOID HandlerData</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PUNWIND_HISTORY_TABLE HistoryTable</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG ScopeIndex</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ULONG Fill0</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span><span class=rvts10> DISPATCHER_CONTEXT</span><span class=rvts21>,</span><span class=rvts10> </span><span class=rvts21>*</span><span class=rvts10>PDISPATCHER_CONTEXT</span><span class=rvts21>;</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>成员分别为：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ControlPc </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>异常触发点。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ImagePase </span><span class=rvts11>——</span><span class=rvts10> ControlPc </span><span class=rvts11>所在模块的基地址。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>FunctionEntry </span><span class=rvts11>——</span><span class=rvts10> ControlPc </span><span class=rvts11>所在函数的</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>EstablisherFrame </span><span class=rvts11>——</span><span class=rvts10> ControlPc </span><span class=rvts11>所在函数的栈帧（如果建立了栈帧）或</span><span class=rvts10> RSP</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>TargetIp </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>解决异常的</span><span class=rvts10> EXCEPT_HANDLER </span><span class=rvts11>地址，该成员只在展开的过程中被使用。</span><span class=rvts10>RtlpExecuteHandlerForException </span><span class=rvts11>没有使用它。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ContextRecord </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>供展开过程中使用，只有当展开过程中触发新异常（返回</span><span class=rvts10> ExceptionCollidedUnwind</span><span class=rvts11>）时，才会被</span><span class=rvts10> RtlDispatchException </span><span class=rvts11>真正的使用到（参考</span><span class=rvts10> RtlDispatchException </span><span class=rvts11>处理</span><span class=rvts10> ExceptionCollidedUnwind </span><span class=rvts11>的代码）。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>LanguageHandler </span><span class=rvts11>——</span><span class=rvts10> ControlPc </span><span class=rvts11>所在函数的</span><span class=rvts10> UNWIND_INFO::ExceptionRoutine</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>HandlerData </span><span class=rvts11>——</span><span class=rvts10> ControlPc </span><span class=rvts11>所在函数的</span><span class=rvts10> UNWIND_INFO::ExceptionData</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ScopeIndex </span><span class=rvts11>——</span><span class=rvts10> UNWIND_INFO::ExceptionData </span><span class=rvts11>中</span><span class=rvts10> SCOPE_TABLE::ScopeRecord </span><span class=rvts11>的索引，通常设置为</span><span class=rvts10>0</span><span class=rvts11>（注：请不要与</span><span class=rvts10> x86 </span><span class=rvts11>中运行时不断改变的</span><span class=rvts10> EXCEPTION_REGISTRATION::trylevel </span><span class=rvts11>相混淆，</span><span class=rvts10>ScopeIndex </span><span class=rvts11>不会在在函数执行过程中改变）</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Fill0 </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>未用。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>再看一下它的</span><span class=rvts10> .fnent </span><span class=rvts11>输出，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1&nbsp; kd&gt; .fnent nt!RtlpExecuteHandlerForException</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2&nbsp; Debugger function entry 00000000`01458210 for:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3&nbsp; (fffff800`008bd950)&nbsp;&nbsp; nt!RtlpExecuteHandlerForException&nbsp;&nbsp; |&nbsp; (fffff800`008bd970)&nbsp;&nbsp; nt!RtlpUnwindHandler</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>4&nbsp; Exact matches:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlpExecuteHandlerForException (void)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>6&nbsp; </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>7&nbsp; BeginAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`000bd950</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>8&nbsp; EndAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`000bd963</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>9&nbsp; UnwindInfoAddress = 00000000`000dfeb8</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>10 </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>11 Unwind info at fffff800`008dfeb8, 10 bytes</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>12&nbsp;&nbsp; version 1, flags 3, prolog 4, codes 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>13&nbsp;&nbsp; handler routine: nt!RtlpExceptionHandler (fffff800`008bd920), data 0</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>14&nbsp;&nbsp; 00: offs 4, unwind op 2, op info 4</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UWOP_ALLOC_SMALL.</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>行</span><span class=rvts10>12</span><span class=rvts11>中显示</span><span class=rvts10> flags </span><span class=rvts11>等于</span><span class=rvts10>3</span><span class=rvts11>，即</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UNW_FLAG_EHANDLER (0x1) | UNW_FLAG_UHANDLER (0x2)</span><span class=rvts11>，说明行</span><span class=rvts10>13</span><span class=rvts11>中显示的异常处理函数</span><span class=rvts10> nt!RtlpExceptionHandler </span><span class=rvts11>既负责解决异常，也负责展开。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlpExecuteHandlerForException </span><span class=rvts11>会调用</span><span class=rvts10> DISPATCHER_CONTEXT::LanguageHandler</span><span class=rvts11>。对于</span><span class=rvts10> MSC </span><span class=rvts11>编译得到的模块，它是</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts11>，我们来看看这个函数，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>原型：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>EXCEPTION_DISPOSITION </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>__C_specific_handler (</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD pExceptionRecord,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PVOID pEstablisherFrame,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PCONTEXT pContext,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN OUT PVOID pDispatcherContext</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>反汇编码：</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts21>&gt;</span><span class=rvts10> uf nt!__C_specific_handler</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42d0</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>10h</span><span class=rvts21>],</span><span class=rvts10>rdx </span><span class=rvts25>; </span><span class=rvts30>在栈上保存</span><span class=rvts25> pEstablisherFrame</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42d5</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rsp</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42d8</span><span class=rvts10> </span><span class=rvts22>sub</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>88h</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42df</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>8</span><span class=rvts21>],</span><span class=rvts10>rbx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42e3</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>10h</span><span class=rvts21>],</span><span class=rvts10>rbp</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42e7</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rbp = pDispatcherContext-&gt;ControlPc</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42ea</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>18h</span><span class=rvts21>],</span><span class=rvts10>rsi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42ee</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>rdi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42f2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>28h</span><span class=rvts21>],</span><span class=rvts10>r12</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42f6</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>+</span><span class=rvts20>38h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; r12 = pDispatcherContext-&gt;HandlerData</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42fa</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>30h</span><span class=rvts21>],</span><span class=rvts10>r13</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a42fe</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>38h</span><span class=rvts21>],</span><span class=rvts10>r14</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4302</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r14</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>+</span><span class=rvts20>8</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r14 = pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4306</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>40h</span><span class=rvts21>],</span><span class=rvts10>r15</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a430a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,</span><span class=rvts10>r9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r13 = pDispatcherContext</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a430d</span><span class=rvts10> </span><span class=rvts22>sub</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>r14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_OffsetInFunc = pDispatcherContext-&gt;ControlPc - pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4310</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>byte</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>],</span><span class=rvts20>66h</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; pExceptionRecord-&gt;ExceptionFlags, EXCEPTION_UNWIND (0x66)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4314</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,</span><span class=rvts10>rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rsi = pEstablisherFrame</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4317</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15</span><span class=rvts21>,</span><span class=rvts10>rcx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r15 = pExceptionRecord</span></p>
<p><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a431a</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xf5</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43c5</span><span class=rvts21>)</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>-------------------------------------------------------------------</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x50</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4320</span><span class=rvts10> movsxd&nbsp; rdi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; l_ScopeIndex (rdi) = pDispatcherContext-&gt;ScopeIndex</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4324</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>58h</span><span class=rvts21>],</span><span class=rvts10>rcx </span><span class=rvts25>; [rax-58h] = pExceptionRecord</span><span class=rvts30>，供给</span><span class=rvts25> GetExceptionCode(Information) </span><span class=rvts30>使用</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4328</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>50h</span><span class=rvts21>],</span><span class=rvts10>r8&nbsp; </span><span class=rvts25>; [rax-50h] = pContext</span><span class=rvts30>，供给</span><span class=rvts25> GetExceptionCode(Information) </span><span class=rvts30>使用</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a432c</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r12</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_ScopeIndex, pDispatcherContext-&gt;HandlerData-&gt;Count</span></p>
<p><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4330</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = l_ScopeIndex</span></p>
<p><span class=rvts21>:&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4333</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4436</span><span class=rvts21>)</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x69</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4339</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>这里</span><span class=rvts25> *2</span><span class=rvts30>，下面紧接着</span><span class=rvts25> *8</span><span class=rvts30>，目的是跳过指定数目的</span><span class=rvts25> ScopeRecord</span><span class=rvts30>（大小为</span><span class=rvts25>16</span><span class=rvts30>字节）</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a433c</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,[</span><span class=rvts10>r12</span><span class=rvts21>+</span><span class=rvts10>rax</span><span class=rvts21>*</span><span class=rvts20>8</span><span class=rvts21>+</span><span class=rvts20>0Ch</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = &amp;(pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].HandlerAddress)</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x71</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> ControlPc </span><span class=rvts30>处于哪个</span><span class=rvts25> __try </span><span class=rvts30>保护域，之步骤一</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4341</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>-</span><span class=rvts20>8</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; eax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].BeginAddress</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4344</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_OffsetInFunc, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].BeginAddress</span></p>
<p><span class=rvts21>::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4347</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xdd</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43ad</span><span class=rvts21>)</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x79</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> ControlPc </span><span class=rvts30>处于哪个</span><span class=rvts25> __try </span><span class=rvts30>保护域，之步骤二</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4349</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>-</span><span class=rvts20>4</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; eax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a434c</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_OffsetInFunc, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress</span></p>
<p><span class=rvts21>:::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a434f</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xdd</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43ad</span><span class=rvts21>)</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x81</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>判断是否是</span><span class=rvts25> __try/__finally</span><span class=rvts30>（</span><span class=rvts25>JumpTarget </span><span class=rvts30>为</span><span class=rvts25> NULL</span><span class=rvts30>）。如果是，那么跳转到下一个</span><span class=rvts25> ScopeRecord </span><span class=rvts30>继续遍历。</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4351</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>],</span><span class=rvts20>0</span><span class=rvts10> </span><span class=rvts25>; cmp pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget, NULL</span></p>
<p><span class=rvts21>::::&lt;</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4355</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xdd</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43ad</span><span class=rvts21>)</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x87</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>到这里，已经找到与异常地址最匹配的</span><span class=rvts25> __try/__except</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4357</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; eax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].HandlerAddress</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4359</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts20>1</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].HandlerAddress, EXCEPTION_EXECUTE_HANDLER (0x1)</span></p>
<p><span class=rvts21>:::::&lt;</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a435c</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xa3</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4373</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>如果返回</span><span class=rvts25> EXCEPTION_EXECUTE_HANDLER </span><span class=rvts30>则跳转</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x8e</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>是</span><span class=rvts25> __try/__except</span><span class=rvts30>，且过滤域并不是</span><span class=rvts25> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts30>，执行</span><span class=rvts25> HandlerAddress </span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>（注：</span><span class=rvts25>HandlerAddress </span><span class=rvts30>指向的函数仍有可能会返回</span><span class=rvts25> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts30>）</span><span class=rvts25> </span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a435e</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>30h</span><span class=rvts21>]</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4363</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>r14 </span><span class=rvts25>; rax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].HandlerAddress + pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4366</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rsi </span><span class=rvts25>; rdx = pEstablisherFrame</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4369</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rax&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>调用</span><span class=rvts25> EXCEPT_FILTER</span></p>
<p><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a436b</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts31>eax</span></p>
<p><span class=rvts21>::::::&lt;</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a436d</span><span class=rvts10> </span><span class=rvts22>js</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xee</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43be</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>返回</span><span class=rvts25> EXCEPTION_CONTINUE_EXECUTION (-1) </span><span class=rvts30>则跳转</span></p>
<p><span class=rvts21>:::::::</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::::::</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x9f</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:::::::</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a436f</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts31>eax</span></p>
<p><span class=rvts21>:::::::&lt;:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4371</span><span class=rvts10> </span><span class=rvts22>jle</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xdd</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43ad</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>返回</span><span class=rvts25> EXCEPTION_CONTINUE_SEARCH (0) </span><span class=rvts30>则跳转</span></p>
<p><span class=rvts21>:::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xa3</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>返回的是</span><span class=rvts25> EXCEPTION_EXECUTE_HANDLER</span></p>
<p><span class=rvts21>:::::&gt;:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4373</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; ecx = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4376</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8d</span><span class=rvts21>,</span><span class=rvts20>1</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a437c</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rsi </span><span class=rvts25>; rdx = pEstablisherFrame</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a437f</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>r14 </span><span class=rvts25>; rcx = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget + pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4382</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!_NLG_Notify </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008b1460</span><span class=rvts21>)</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4387</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r13</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = pDispatcherContext-&gt;HistoryTable</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a438b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edx</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; edx = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a438e</span><span class=rvts10> movsxd&nbsp; r9</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r15</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r9 = pExceptionRecord-&gt;ExceptionCode</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4391</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>28h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_6 = pDispatcherContext-&gt;HistoryTable</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4396</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r13</span><span class=rvts21>+</span><span class=rvts20>28h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = pDispatcherContext-&gt;ContextRecord</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a439a</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>r14 </span><span class=rvts25>; rdx = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget + pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a439d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,</span><span class=rvts10>r15&nbsp; </span><span class=rvts25>; r8 = pExceptionRecord</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43a0</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>rsi </span><span class=rvts25>; rcx = pEstablisherFrame</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43a3</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_5 = pDispatcherContext-&gt;ContextRecord</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43a8</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891e80</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>这里不会返回</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; RtlUnwindEx(pEstablisherFrame, </span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget + pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pExceptionRecord,</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pExceptionRecord-&gt;ExceptionCode</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pDispatcherContext-&gt;ContextRecord,</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pDispatcherContext-&gt;HistoryTable)</span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xdd</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::&gt;&gt;&gt;</span><span class=rvts10> </span><span class=rvts21>:&gt;:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43ad</span><span class=rvts10> </span><span class=rvts22>inc</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_ScopeIndex += 1</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43af</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts20>10h</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>调整到下一个</span><span class=rvts25> ScopeRecord::HandlerAddress</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43b3</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r12</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; cmp l_ScopeIndex, pDispatcherContext-&gt;HandlerData-&gt;Count</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43b7</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x71</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4341</span><span class=rvts21>)</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xe9</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; pDispatcherContext-&gt;HandlerData </span><span class=rvts30>遍历完毕</span></p>
<p><span class=rvts21>::&lt;</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43b9</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4436</span><span class=rvts21>)</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xee</span><span class=rvts21>:</span></p>
<p><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43be</span><span class=rvts10> </span><span class=rvts22>xor</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts31>eax</span><span class=rvts10> </span><span class=rvts25>; eax = ExceptionContinueExecution</span></p>
<p><span class=rvts21>:::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43c0</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x16b</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a443b</span><span class=rvts21>)</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>-------------------------------------------------------------------------------------</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0xf5</span><span class=rvts21>:</span></p>
<p><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>设置了</span><span class=rvts25> EXCEPTION_UNWIND</span><span class=rvts30>，当前是展开过程</span></p>
<p><span class=rvts21>&gt;:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43c5</span><span class=rvts10> movsxd&nbsp; rdi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; l_ScopeIndex (rdi) = pDispatcherContext-&gt;ScopeIndex</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43c9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r9</span><span class=rvts21>+</span><span class=rvts20>20h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rsi = pDispatcherContext-&gt;TargetIp</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43cd</span><span class=rvts10> </span><span class=rvts22>sub</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,</span><span class=rvts10>r14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rsi = pDispatcherContext-&gt;TargetIp - pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43d0</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r12</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_ScopeIndex, pDispatcherContext-&gt;HandlerData-&gt;Count</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43d4</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = l_ScopeIndex</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43d7</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4436</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x109</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43d9</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a43dc</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,[</span><span class=rvts10>r12</span><span class=rvts21>+</span><span class=rvts10>rax</span><span class=rvts21>*</span><span class=rvts20>8</span><span class=rvts21>+</span><span class=rvts20>8</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = &amp;(pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x111</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> ControlPc </span><span class=rvts30>处于哪个</span><span class=rvts25> __try </span><span class=rvts30>保护域，之步骤一</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43e1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>-</span><span class=rvts20>4</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; eax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].BeginAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43e4</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; cmp l_OffsetInFunc, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].BeginAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43e7</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x15a</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a442a</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x119</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> ControlPc </span><span class=rvts30>处于哪个</span><span class=rvts25> __try </span><span class=rvts30>保护域，之步骤二</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43e9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; ecx = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43eb</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rcx </span><span class=rvts25>; cmp l_OffsetInFunc, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43ee</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x15a</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a442a</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x120</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>到这里，已经找到与异常地址匹配的最内层（如果有多层）</span><span class=rvts25> __try/__except</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43f0</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; cmp pDispatcherContext-&gt;TargetIp - pDispatcherContext-&gt;ImageBase, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].BeginAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43f3</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x131</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4401</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x125</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43f5</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,</span><span class=rvts10>rcx </span><span class=rvts25>; cmp pDispatcherContext-&gt;TargetIp - pDispatcherContext-&gt;ImageBase, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].EndAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43f8</span><span class=rvts10> </span><span class=rvts22>ja</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x131</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4401</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x12a</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>如果标记了</span><span class=rvts25> EXCEPTION_TARGET_UNWIND</span><span class=rvts30>，说明是最后一个需要局部展开的函数。但是该次局部展开只展开到</span><span class=rvts25> EXCEPT_HANDLER</span><span class=rvts30>（不包含</span><span class=rvts25> EXCEPT_HANDLER</span><span class=rvts30>），所以需要判断</span><span class=rvts25> TargetIp</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43fa</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>byte</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r15</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>],</span><span class=rvts20>20h</span><span class=rvts10> </span><span class=rvts25>; test pExceptionRecord-&gt;ExceptionFlags, EXCEPTION_TARGET_UNWIND (0x20)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::::&lt;</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a43ff</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4436</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>:::::::::</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x131</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::&gt;&gt;:</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4401</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>+</span><span class=rvts20>8</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; eax = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4404</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts31>eax</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span><span class=rvts30>，即是否是</span><span class=rvts25> __try/__finally</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:&lt;</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4406</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x13f</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a440f</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>如果是</span><span class=rvts25> __try/__finally </span><span class=rvts30>则跳转</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x138</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4408</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; cmp pDispatcherContext-&gt;TargetIp, pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[l_ScopeIndex].JumpTarget</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>::&lt;</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a440b</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a4436</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x13d</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::&lt;:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a440d</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x15a</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a442a</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::::</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::::</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x13f</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:::::</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>注意这里是先修改</span><span class=rvts25> pDispatcherContext-&gt;ScopeIndex</span><span class=rvts30>，然后调用</span><span class=rvts25> EXCEPT_HANDLER</span><span class=rvts30>。这样如果</span><span class=rvts25> EXCEPT_HANDLER </span><span class=rvts30>触发异常，后续展开就会跳过这个</span><span class=rvts25> EXCEPT_HANDLER</span><span class=rvts30>。</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:&gt;:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a440f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>98h</span><span class=rvts21>]</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4417</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>1</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; eax = l_ScopeIndex + 1</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a441a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>cl</span><span class=rvts21>,</span><span class=rvts20>1</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a441c</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r13</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>],</span><span class=rvts31>eax</span><span class=rvts10> </span><span class=rvts25>; pDispatcherContext-&gt;ScopeIndex = eax</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4420</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8d</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; r8d = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[i].HandlerAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4424</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,</span><span class=rvts10>r14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r8 = pDispatcherContext-&gt;HandlerData-&gt;ScopeRecord[i].HandlerAddress + pDispatcherContext-&gt;ImageBase</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4427</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; r8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>调用</span><span class=rvts25> __finally </span><span class=rvts30>处理块，会返回（注：对于</span><span class=rvts25> __try/__finally</span><span class=rvts30>，</span><span class=rvts25>HandlerAddress </span><span class=rvts30>保存的是</span><span class=rvts25> __finally </span><span class=rvts30>代码块的</span><span class=rvts25> RVA</span><span class=rvts30>）</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::::</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:::</span><span class=rvts10> nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x15a</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::&gt;&gt;</span><span class=rvts10>&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:&gt;:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a442a</span><span class=rvts10> </span><span class=rvts22>inc</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_ScopeIndex += 1</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a442c</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts20>10h</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>调整到下一个</span><span class=rvts25> ScopeRecord::HandlerAddress</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4430</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edi</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r12</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; cmp l_ScopeIndex, pDispatcherContext-&gt;HandlerData-&gt;Count</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>&lt;</span><span class=rvts10> fffff800`</span><span class=rvts20>008a4434</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x111</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008a43e1</span><span class=rvts21>)</span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp; </span></p>
<p><span class=rvts10> </span><span class=rvts21>::::</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10> </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x166</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>&gt;&gt;:&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4436</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts20>1</span><span class=rvts10> </span><span class=rvts25>; eax = ExceptionContinueSearch (0n1)</span></p>
<p><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>:</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__C_specific_handler</span><span class=rvts21>+</span><span class=rvts20>0x16b</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a443b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4440</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r14</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4445</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>58h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a444a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>60h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a444f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>68h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4454</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>70h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4459</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>78h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a445e</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>80h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a4466</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>88h</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008a446d</span><span class=rvts10> ret</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>nt!__C_specific_handler </span><span class=rvts11>相当于</span><span class=rvts10> x86 </span><span class=rvts11>中的</span><span class=rvts10> nt!_except_handler3</span><span class=rvts11>。从上面的反汇编代码也可以看出它的逻辑跟</span><span class=rvts10> nt!_except_handler3 </span><span class=rvts11>基本上一致。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>函数代码不长。主要分为两个大分支，一个分支处理异常，一个分支处理展开（我用横线分隔开了）。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>异常解决的代码负责遍历</span><span class=rvts10> SCOPE_TABLE</span><span class=rvts11>，依次调用</span><span class=rvts10> SCOPE_TABLE::ScopeRecord.HandlerAddress </span><span class=rvts11>代表的</span><span class=rvts10> EXCEPT_FILTER</span><span class=rvts11>，并针对返回值做出相应的处理：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1. </span><span class=rvts11>返回</span><span class=rvts10> EXCEPTION_CONTINUE_EXECUTION</span><span class=rvts11>，说明异常已经被</span><span class=rvts10> EXCEPT_FILTER </span><span class=rvts11>修复。返回</span><span class=rvts10> ExceptionContinueExecution</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2. </span><span class=rvts11>返回</span><span class=rvts10> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts11>，继续遍历下一个</span><span class=rvts10> ScopeRecord</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3. </span><span class=rvts11>返回</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts11>，说明当前</span><span class=rvts10> ScopeRecord.JumpTarget </span><span class=rvts11>代表的</span><span class=rvts10> EXCEPT_HANDLER </span><span class=rvts11>可以处理该异常。那么调用</span><span class=rvts10> RtlUnwindEx </span><span class=rvts11>进行展开。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>熟悉</span><span class=rvts10> x86 </span><span class=rvts11>的朋友可能会疑惑：在</span><span class=rvts10> x86 </span><span class=rvts11>中</span><span class=rvts10> nt!_except_handler3 </span><span class=rvts11>先进行全局展开，然后对本函数自身进行不完全的局部展开，最后执行</span><span class=rvts10> EXCEPT_HANDLER</span><span class=rvts11>。而在</span><span class=rvts10> nt!__C_specific_handler </span><span class=rvts11>中却找不到执行</span><span class=rvts10> EXCEPT_HANDLER </span><span class=rvts11>的指令，这是怎么回事？</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>实际上，</span><span class=rvts10>x64 </span><span class=rvts11>对这个流程做了一些调整，</span><span class=rvts10>EXCEPT_HANDLER </span><span class=rvts11>不是由</span><span class=rvts10> nt!__C_specific_handler </span><span class=rvts11>直接调用，而是作为参数传给</span><span class=rvts10> RtlUnwindEx</span><span class=rvts11>，</span><span class=rvts10>RtlUnwindEx </span><span class=rvts11>处理完展开之后才执行</span><span class=rvts10> EXCEPT_HANDLER</span><span class=rvts11>。后续我们在讲展开的时候会看到具体的方法。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>__C_specific_handler </span><span class=rvts11>的展开分支，是对</span><span class=rvts10> SCOPE_TABLE </span><span class=rvts11>进行展开，逻辑很简单，不多讲了。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>更详细的信息，请参考上面反汇编代码中我附的注释。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>另外还需要说一下</span><span class=rvts10> SCOPE_TABLE</span><span class=rvts11>。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>在</span><span class=rvts10> x86 </span><span class=rvts11>中，遍历</span><span class=rvts10> scopetable </span><span class=rvts11>时是通过运行时动态改变的</span><span class=rvts10> EXCEPTION_REGISTRATION::trylevel </span><span class=rvts11>来确定应该首先遍历哪一个</span><span class=rvts10> scopetable_entry</span><span class=rvts11>。而</span><span class=rvts10> x64 </span><span class=rvts11>中没有等同于</span><span class=rvts10> trylevel </span><span class=rvts11>的数据，有的朋友可能会说“</span><span class=rvts10>SCOPE_TABLE </span><span class=rvts11>中不是有每个</span><span class=rvts10> __try </span><span class=rvts11>保护域的范围</span><span class=rvts10> RVA </span><span class=rvts11>吗？通过范围不就可以确定在哪个</span><span class=rvts10> __try </span><span class=rvts11>中触发了异常吗？”。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>我们可以先试试这种方法，以下面这段伪码为例，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>1</span><span class=rvts10> VOID SehTest</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>2</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>3</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __try </span><span class=rvts25>// 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>4</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>5</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>6</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>7</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>8</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>9</span><span class=rvts10> </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>10</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try </span><span class=rvts25>// 2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>11</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>12</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try </span><span class=rvts25>// 3</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>13</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>14</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>...</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>15</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>16</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>17</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>18</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>19</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>20</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>21</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>22</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>23</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>24</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try </span><span class=rvts25>// 4</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>25</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>26</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>27</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __finally</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>28</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>29</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>30</span><span class=rvts21>}</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>上述伪码中总共有</span><span class=rvts10>4</span><span class=rvts11>个</span><span class=rvts10> __try</span><span class=rvts11>，按照</span><span class=rvts10> x86 </span><span class=rvts11>中的方法，</span><span class=rvts10>SCOPE_TABLE </span><span class=rvts11>的内容应该是顺序排列的，像这样：</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::Count </span><span class=rvts11>等于</span><span class=rvts10>4</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0] </span><span class=rvts11>表示行</span><span class=rvts10>3</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1] </span><span class=rvts11>表示行</span><span class=rvts10>10</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2] </span><span class=rvts11>表示行</span><span class=rvts10>12</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3] </span><span class=rvts11>表示行</span><span class=rvts10>24</span><span class=rvts11>开始的</span><span class=rvts10> __try/__finally</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>假设行</span><span class=rvts10>14</span><span class=rvts11>处触发了异常，遍历过程应该是这样，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>首先检查</span><span class=rvts10> ScopeRecord[0]</span><span class=rvts11>，发现其范围不包含</span><span class=rvts10> EXCEPT_POINT</span><span class=rvts11>，继续下一个，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>开始检查</span><span class=rvts10> ScopeRecord[1]</span><span class=rvts11>，范围匹配了。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>那是不是该把异常交给</span><span class=rvts10> ScopeRecord[1] </span><span class=rvts11>处理呢？</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>不是！从伪码中可以很明显的看出，行</span><span class=rvts10>14</span><span class=rvts11>触发的异常应该首先由行</span><span class=rvts10>12</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，即</span><span class=rvts10> ScopeRecord[1] </span><span class=rvts11>处理。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>可见这种方法是行不通的。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>MSC </span><span class=rvts11>通过调整</span><span class=rvts10> SCOPE_TABLE::ScopeRecord </span><span class=rvts11>的排列顺序来解决这个问题：</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::Count </span><span class=rvts11>等于</span><span class=rvts10>4</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0] </span><span class=rvts11>表示行</span><span class=rvts10>3</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1] </span><span class=rvts11>表示行</span><span class=rvts32>12</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2] </span><span class=rvts11>表示行</span><span class=rvts10>10</span><span class=rvts11>开始的</span><span class=rvts10> __try/__except</span><span class=rvts11>，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3] </span><span class=rvts11>表示行</span><span class=rvts10>24</span><span class=rvts11>开始的</span><span class=rvts10> __try/__finally</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>即对于嵌套的</span><span class=rvts10> __try/__except/__finally</span><span class=rvts11>，</span><span class=rvts10>ScopeRecord </span><span class=rvts11>的排列顺序是，最内层的</span><span class=rvts10> __try </span><span class=rvts11>排在前面，其次是次内层的，依次排到最外层。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>这样就能正确的遍历</span><span class=rvts10> SCOPE_TABLE </span><span class=rvts11>了。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>再用伪码完整的展示一下</span><span class=rvts10> SCOPE_TABLE </span><span class=rvts11>的布置，</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::Count = 4</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0].BeginAddress = RVA_L4; </span><span class=rvts11>（行</span><span class=rvts10>4</span><span class=rvts11>的</span><span class=rvts10> RVA</span><span class=rvts11>）</span><span class=rvts10> // </span><span class=rvts11>第一个</span><span class=rvts10> __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0].EndAddress = RVA_L5;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0].HandlerAddress = RVA_L6_EXCEPT_FILTER; </span><span class=rvts11>（行</span><span class=rvts10>6 __except </span><span class=rvts11>过滤代码首地址的</span><span class=rvts10> RVA</span><span class=rvts11>）</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[0].JumpTarget = RVA_L7; </span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1].BeginAddress = RVA_L13;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span class=rvts11>第三个</span><span class=rvts10> __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1].EndAddress = RVA_L15;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1].HandlerAddress = RVA_L16_EXCEPT_FILTER; </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[1].JumpTarget = RVA_L7; </span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2].BeginAddress = RVA_L11;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span class=rvts11>第二个</span><span class=rvts10> __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2].EndAddress = RVA_L19;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2].HandlerAddress = RVA_L20_EXCEPT_FILTER;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[2].JumpTarget = RVA_L21; </span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3].BeginAddress = RVA_L25;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span class=rvts11>第四个</span><span class=rvts10> __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3].EndAddress = RVA_L26;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3].HandlerAddress = RVA_L28;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>SCOPE_TABLE::ScopeRecord[3].JumpTarget = 0; </span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>我们再模拟一下</span><span class=rvts10> nt!__C_specific_handler </span><span class=rvts11>是如何遍历</span><span class=rvts10> SCOPE_TABLE </span><span class=rvts11>的：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1. </span><span class=rvts11>首先通过传入参数中的</span><span class=rvts10> pDispatcherContext-&gt;ControlPc </span><span class=rvts11>和</span><span class=rvts10> pDispatcherContext-&gt;ImageBase </span><span class=rvts11>计算出异常触发点的</span><span class=rvts10> RVA</span><span class=rvts11>（简称</span><span class=rvts10> E_RVA</span><span class=rvts11>）。参见</span><span class=rvts10> fffff800`008a430d </span><span class=rvts11>处的指令。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2. </span><span class=rvts11>通过</span><span class=rvts10> pDispatcherContext-&gt;ScopeIndex </span><span class=rvts11>确认是否需要遍历。如果需要遍历，则从它指定的</span><span class=rvts10> ScopeRecord </span><span class=rvts11>开始遍历。</span><span class=rvts10>pDispatcherContext-&gt;ScopeIndex </span><span class=rvts11>一般都为</span><span class=rvts10>0</span><span class=rvts11>，只有返回</span><span class=rvts10> ExceptionCollidedUnwind </span><span class=rvts11>时，</span><span class=rvts10>RtlDispatchException </span><span class=rvts11>才可能将它设置为其他值。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>3. </span><span class=rvts11>通过比较</span><span class=rvts10> E_RVA </span><span class=rvts11>和</span><span class=rvts10> ScopeRecord[?].BeginAddress</span><span class=rvts11>、</span><span class=rvts10>ScopeRecord[?].EndAddress </span><span class=rvts11>来找到正确的处理函数，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>首先</span><span class=rvts10> ScopeRecord[0] </span><span class=rvts11>范围不匹配，遍历下一个，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>然后</span><span class=rvts10> ScopeRecord[1]</span><span class=rvts11>，发现范围匹配，并且是</span><span class=rvts10> __try/__except </span><span class=rvts11>组合。于是调用</span><span class=rvts10> ScopeRecord[1].HandlerAddress</span><span class=rvts11>，假设它返回的是</span><span class=rvts10> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts11>，那么继续遍历下一个，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>这次是</span><span class=rvts10> ScopeRecord[2]</span><span class=rvts11>，发现范围匹配，并且是</span><span class=rvts10> __try/__except </span><span class=rvts11>组合。于是调用</span><span class=rvts10> ScopeRecord[2].HandlerAddress</span><span class=rvts11>，假设它返回的是</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts11>，那么说明找到了解决方案。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>4. </span><span class=rvts11>调用</span><span class=rvts10> RtlUnwindEx</span><span class=rvts11>，把</span><span class=rvts10> ScopeRecord[2].JumpTarget </span><span class=rvts11>对应的绝对地址作为</span><span class=rvts10> TargetIp </span><span class=rvts11>参数传给它。</span><span class=rvts10>RtlUnwindEx </span><span class=rvts11>全局展开完毕后执行</span><span class=rvts10> TargetIp</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>到这里，异常分发就大致讲述完毕。接下来是关于展开和解决的内容。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts27>三、展开、解决</span></p>
<p><span class=rvts28><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>x64 </span><span class=rvts11>中展开使用的函数有</span><span class=rvts10> RtlVirtualUnwind</span><span class=rvts11>、</span><span class=rvts10>RtlUnwindEx </span><span class=rvts11>和</span><span class=rvts10> RtlpExecuteHandlerForUnwind</span><span class=rvts11>。其中</span><span class=rvts10> RtlVirtualUnwind </span><span class=rvts11>已经讲了，我们来看看余下的两个。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>首先是</span><span class=rvts10> RtlUnwindEx</span><span class=rvts11>，原型如下：</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>VOID</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>RtlUnwindEx (</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PVOID TargetFrame OPTIONAL,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PVOID TargetIp OPTIONAL,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord OPTIONAL,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PVOID ReturnValue,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PCONTEXT OriginalContext,</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; IN PUNWIND_HISTORY_TABLE HistoryTable OPTIONAL</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>参数分别是：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>TargetFrame </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>目标帧，即最后一个需要展开的帧。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>TargetIp </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>前面有讲过，它就是</span><span class=rvts10> ScopeRecord[?].JumpTarget </span><span class=rvts11>代表的地址，即</span><span class=rvts10> EXCEPT_HANDLER</span><span class=rvts11>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ExceptionRecord </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>异常信息。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ReturnValue </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>传递给</span><span class=rvts10> TargetIp </span><span class=rvts11>的返回值，分析过程中没发现它有什么用处。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>OriginalContext </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>虽然被声明为</span><span class=rvts10> IN</span><span class=rvts11>，但是实际上</span><span class=rvts10> RtlUnwindEx </span><span class=rvts11>并没有使用它内部的数据，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>HistoryTable </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>用于加速查找</span><span class=rvts10> RUNTIME_FUNCTION</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>主要功能是：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>从</span><span class=rvts33>自身</span><span class=rvts19>开始展开，到</span><span class=rvts18> TargetFrame </span><span class=rvts19>停止。然后跳转到</span><span class=rvts18> TargetIp </span><span class=rvts19>继续执行。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>流程：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. </span><span class=rvts19>申请一个类型为</span><span class=rvts18> CONTEXT </span><span class=rvts19>的局部变量</span><span class=rvts18> l_Context</span><span class=rvts19>，调用</span><span class=rvts18> RtlCaptureContext </span><span class=rvts19>将当前自身的环境复制到</span><span class=rvts18> l_Context</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. </span><span class=rvts19>通过</span><span class=rvts18> RtlVirtualUnwind </span><span class=rvts19>对</span><span class=rvts18> l_Context </span><span class=rvts19>进行模拟展开，推动遍历。对每个遍历到的</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>，检查</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>是否包含</span><span class=rvts18> UNW_FLAG_UHANDLER</span><span class=rvts19>。如果包含，则调用</span><span class=rvts18> UNWIND_INFO::ExceptionHandler </span><span class=rvts19>进行局部展开。否则继续遍历下一个。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>循环本步骤，直到展开到</span><span class=rvts18> TargetFrame</span><span class=rvts19>，即到达解决异常的</span><span class=rvts18> EXCEPT_HANDLER </span><span class=rvts19>所在的函数（简称为</span><span class=rvts18> ExceptionHandlerFunc</span><span class=rvts19>）了。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. </span><span class=rvts19>这时</span><span class=rvts18> l_Context </span><span class=rvts19>内已经是从</span><span class=rvts18> RtlUnwindEx </span><span class=rvts19>完整展开到</span><span class=rvts18> EXCEPT_HANDLER </span><span class=rvts19>的环境了。即此时</span><span class=rvts18> l_Context </span><span class=rvts19>已经是</span><span class=rvts18> ExceptionHandlerFunc </span><span class=rvts19>的执行环境了。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>调用</span><span class=rvts18> RtlRestoreContext</span><span class=rvts19>，用</span><span class=rvts18> l_Context </span><span class=rvts19>替换当前线程的执行环境，于是就跳转到</span><span class=rvts18> EXCEPT_HANDLER </span><span class=rvts19>继续执行。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>这样就完美的从触发异常的环境跳到了新的环境中。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>这个过程有点类似这种手法：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. </span><span class=rvts19>将某台机器的系统</span><span class=rvts18> ghost </span><span class=rvts19>到一个</span><span class=rvts18> bak.gho </span><span class=rvts19>文件。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. </span><span class=rvts19>把</span><span class=rvts18> bak.gho </span><span class=rvts19>恢复到一台临时机器，然后对这台临时机器做一些调整。调整完毕后制作一个临时机器的</span><span class=rvts18> bak_mod.gho</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. </span><span class=rvts19>将</span><span class=rvts18> bak_mod.gho </span><span class=rvts19>恢复到原来那台机器。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>这个流程很重要，我手绘了一副图帮助理解，</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>伪码：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>__try</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>{</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; ExRaiseStatus(STATUS_INVALID_PARAMETER);</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>}</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>__except(EXCEPTION_EXECUTE_HANDLER)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>{</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>}</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>图：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. </span><span class=rvts19>异常解决流程，从</span><span class=rvts18> EXCEPT_POINT </span><span class=rvts19>到</span><span class=rvts18> RtlUnwindEx</span><span class=rvts19>，途中已经找到能够解决该异常的</span><span class=rvts18> EXCEPT_HANDLER </span><span class=rvts19>了（以参数</span><span class=rvts18> TargetIp </span><span class=rvts19>表示），当前线程状态为</span><span class=rvts18> ThreadContext</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlRaiseStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>调</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlDispatchException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>用</span><span class=rvts18> |-&gt; ThreadContext &amp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlpExecuteHandlerForException&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>方</span><span class=rvts18> |&nbsp;&nbsp; TargetIp = ExceptionHandler</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | __C_specific_handler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>向</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. RtlUnwindEx </span><span class=rvts19>将当前自身状态复制到</span><span class=rvts18> ThreadContext_Copy </span><span class=rvts19>中</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlRaiseStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>调</span><span class=rvts18> |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlRaiseStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>调</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlDispatchException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>用</span><span class=rvts18> |-&gt; ThreadContext &amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlDispatchException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>用</span><span class=rvts18> |-&gt; ThreadContext_Copy &amp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlpExecuteHandlerForException&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>方</span><span class=rvts18> |&nbsp;&nbsp; TargetIp = ExceptionHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlpExecuteHandlerForException&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>方</span><span class=rvts18> |&nbsp;&nbsp; TargetIp = ExceptionHandler</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | __C_specific_handler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>向</span><span class=rvts18> |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | __C_specific_handler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>向</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. </span><span class=rvts19>用</span><span class=rvts18> ThreadContext_Copy </span><span class=rvts19>进行展开，一直展开到异常触发点停止。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | .....&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlRaiseStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>调</span><span class=rvts18> |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlRaiseStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ^</span><span class=rvts19>展</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlDispatchException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>用</span><span class=rvts18> |-&gt; ThreadContext&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlDispatchException&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>开</span><span class=rvts18> |-&gt; ThreadContext_Copy &amp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlpExecuteHandlerForException&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>方</span><span class=rvts18> |&nbsp;&nbsp; TargetIp = ExceptionHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlpExecuteHandlerForException&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>方</span><span class=rvts18> |&nbsp;&nbsp; TargetIp = ExceptionHandler</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | __C_specific_handler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>向</span><span class=rvts18> |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | __C_specific_handler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span><span class=rvts19>向</span><span class=rvts18> |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>4. </span><span class=rvts19>将</span><span class=rvts18> ThreadContext_Copy.Rip </span><span class=rvts19>设置为</span><span class=rvts18> TargetIp</span><span class=rvts19>，以</span><span class=rvts18> ThreadContext_Copy </span><span class=rvts19>为参数调用</span><span class=rvts18> RtlpRestoreContext</span><span class=rvts19>。跳转到</span><span class=rvts18> TargetIp </span><span class=rvts19>继续执行。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; | EXCEPT_HANDLER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-&gt; ThreadContext (ThreadContext.Rip = TargetIp)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; +---------------------------------------+</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>这样就完成了展开和执行</span><span class=rvts18> EXCEPT_HANDLER </span><span class=rvts19>的工作。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlpExecuteHandlerForUnwind </span><span class=rvts19>没有什么改变，原型依旧：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EXCEPTION_DISPOSITION</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlpExecuteHandlerForUnwind (</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord,</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN PVOID EstablisherFrame,</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN OUT PCONTEXT ContextRecord,</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; IN OUT PVOID DispatcherContext</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>它会注册一个异常处理函数</span><span class=rvts18> RtlpUnwindHandle</span><span class=rvts19>，当触发新异常时</span><span class=rvts18> RtlpUnwindHandler </span><span class=rvts19>会返回</span><span class=rvts18> ExceptionCollidedUnwind</span><span class=rvts19>。关于</span><span class=rvts18> ExceptionCollidedUnwind</span><span class=rvts19>，我们后面还会详细讲述。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlpExecuteHandlerForUnwind </span><span class=rvts19>的实现源码位于</span><span class=rvts18> $\WRK-v1.2\base\ntos\rtl\amd64\xcptmisc.asm:199</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>RtlpUnwindHandle </span><span class=rvts19>的实现源码位于</span><span class=rvts18> $\WRK-v1.2\base\ntos\rtl\amd64\xcptmisc.asm:136</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>到这里，我们讲完了展开的逻辑。接下来我们要讲述两个比较特殊的返回值：</span><span class=rvts18> </span><span class=rvts10>ExceptionNestedException </span><span class=rvts19>和</span><span class=rvts18> ExceptionCollidedUnwind</span><span class=rvts11>。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts27>四、</span><span class=rvts28>ExceptionNestedException </span><span class=rvts27>和</span><span class=rvts28> </span><span class=rvts34>ExceptionCollidedUnwind</span></p>
<p><span class=rvts34><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>之所以专门讲述这两个返回值，是因为在分析过程中，我感觉常规情况的</span><span class=rvts18> SEH </span><span class=rvts19>流程理解起来并不困难，难理解的是这两种不一般的情况。它们不一般之处在于：在处理异常的过程中又触发了新的异常。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>先来讲一下这两个返回值的含义：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ExceptionNestedException </span><span class=rvts11>——</span><span class=rvts10> </span><span class=rvts11>在异常分发过程中触发新的异常，比如执行</span><span class=rvts10> EXCEPT_FILTER </span><span class=rvts11>时触发异常。</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>ExceptionCollidedUnwind </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>在展开过程中触发新的异常，比如执行</span><span class=rvts18> FINALLY_HANDLER </span><span class=rvts19>时触发异常。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>首先来讲讲</span><span class=rvts18> </span><span class=rvts10>ExceptionNestedException</span><span class=rvts11>，以如下伪码为例：</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>1</span><span class=rvts10>&nbsp; VOID SehTest</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>2</span><span class=rvts10>&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>3</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>4</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>5</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExRaiseStatus</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>6</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>7</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>ExRaiseStatus</span><span class=rvts21>(),</span><span class=rvts10> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_FILTER_1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>8</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_HANDLER_1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>9</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>10</span><span class=rvts10> </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>11</span><span class=rvts10> </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>12</span><span class=rvts10> VOID Caller</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>13</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>14</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>15</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>16</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SehTest</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>17</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>18</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_FILTER_2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>19</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_HANDLER_2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>20</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>21</span><span class=rvts10> </span><span class=rvts21>}</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>上述代码会两次触发异常，第一次是行</span><span class=rvts18>5</span><span class=rvts19>的</span><span class=rvts18> ExRaiseStatus</span><span class=rvts19>，第二次是行</span><span class=rvts18>7</span><span class=rvts19>的</span><span class=rvts18> ExRaiseStatus</span><span class=rvts19>。为了方便区分，我将它们分别标记为</span><span class=rvts18> EXCEPT_POINT#1</span><span class=rvts19>、</span><span class=rvts18>EXCEPT_POINT#2</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>我们来看一下这两个异常的处理流程：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. ExRaiseStatus#1 </span><span class=rvts19>会创建保存</span><span class=rvts18> EXCEPT_POINT#1 </span><span class=rvts19>触发时的状态</span><span class=rvts18> Context#1</span><span class=rvts19>，并构建一个</span><span class=rvts18> EXCEPTION_RECORD</span><span class=rvts19>，然后将他们作为参数来调用</span><span class=rvts18> RtlDispatchException#1</span><span class=rvts19>。（注：这种方式的的触发点是</span><span class=rvts18> ExRaiseStatus </span><span class=rvts19>内部，而非</span><span class=rvts18> SehTest </span><span class=rvts19>的第</span><span class=rvts18>5</span><span class=rvts19>行。即</span><span class=rvts18>Context#1 </span><span class=rvts19>记录的异常触发点是</span><span class=rvts18> ExRaiseStatus#1 </span><span class=rvts19>内部）</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. RtlDispatchException#1 </span><span class=rvts19>根据</span><span class=rvts18> Context#1 </span><span class=rvts19>首先找到</span><span class=rvts18> EXCEPT_POINT#1 </span><span class=rvts19>所在函数</span><span class=rvts18> ExRaiseStatus#1 </span><span class=rvts19>的</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是继续遍历。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. RtlDispatchException#1 </span><span class=rvts19>遍历到</span><span class=rvts18> SehTest</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_EHANDLER</span><span class=rvts19>，于是调用其</span><span class=rvts18> UNWIND_INFO::ExceptionHandler</span><span class=rvts19>，即</span><span class=rvts18> __C_specific_handler$2</span><span class=rvts19>。</span><span class=rvts18>__C_specific_handler$2 </span><span class=rvts19>遍历</span><span class=rvts18> SehTest </span><span class=rvts19>的</span><span class=rvts18> SCOPE_TABLE</span><span class=rvts19>，发现唯一的一个</span><span class=rvts18> ScopeRecord</span><span class=rvts19>。于是执行</span><span class=rvts18> ScopeRecord[0].HandlerAddress</span><span class=rvts19>，即行</span><span class=rvts18>7</span><span class=rvts19>的</span><span class=rvts18> SehTest::EXCEPT_FILTER_1#1</span><span class=rvts19>。此时的调用栈如下（竖线后的内容为函数的</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>和</span><span class=rvts18> UNWIND_INFO::ExceptionHandler</span><span class=rvts19>，其中</span><span class=rvts18> Flags </span><span class=rvts19>缩写为</span><span class=rvts18> E</span><span class=rvts19>、</span><span class=rvts18>U</span><span class=rvts19>、</span><span class=rvts18>N</span><span class=rvts19>）：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(1)&nbsp; Caller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; __C_specific_handler$1</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(2)&nbsp; SehTest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; </span><span class=rvts35>__C_specific_handler$2</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(3)&nbsp; ExRaiseStatus#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(4)&nbsp; RtlDispatchException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(5)&nbsp; RtlpExecuteHandlerForException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler$5</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(6)&nbsp; </span><span class=rvts35>__C_specific_handler$2</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(7)&nbsp; EXCEPT_FILTER_1#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>4. EXCEPT_FILTER#1 </span><span class=rvts19>触发</span><span class=rvts18> EXCEPT_POINT#2</span><span class=rvts19>。同步骤</span><span class=rvts18>1</span><span class=rvts19>类似，</span><span class=rvts18>ExRaiseStatus </span><span class=rvts19>会调用</span><span class=rvts18> RtlDispatchException#2</span><span class=rvts19>，这个过程中同样会创建保存</span><span class=rvts18> EXCEPT_POINT#2 </span><span class=rvts19>的状态，我们称之为</span><span class=rvts18> Context#2</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>5. RtlDispatchException#2 </span><span class=rvts19>根据</span><span class=rvts18> Context#2 </span><span class=rvts19>找到了</span><span class=rvts18> EXCEPT_POINT#2 </span><span class=rvts19>所在函数</span><span class=rvts18> ExRaiseStatus#2</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是继续遍历。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>6. RtlDispatchException#2 </span><span class=rvts19>遍历到</span><span class=rvts18> EXCEPT_FILTER_1#1</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是继续遍历。（注：</span><span class=rvts18>EXCEPT_FILTER </span><span class=rvts19>虽然代码形式上从属于</span><span class=rvts18> SehTest </span><span class=rvts19>函数，但实际上它是一个单独的函数，有自己的</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>，跟</span><span class=rvts18> SEH </span><span class=rvts19>的</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>并不是同一个）</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>7. RtlDispatchException#2 </span><span class=rvts19>遍历到</span><span class=rvts18> __C_specific_handler$2</span><span class=rvts19>、</span><span class=rvts18>RltpExecuteHandlerForException#1</span><span class=rvts19>、</span><span class=rvts18>RtlDispatchException#1</span><span class=rvts19>、</span><span class=rvts18>ExRaiseStatus#1</span><span class=rvts19>，这些函数要么被标记为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，要么</span><span class=rvts18> UNWIND_INFO::ExceptionHandler </span><span class=rvts19>返回</span><span class=rvts18> ExcetpionNestedException</span><span class=rvts19>，结果都是继续遍历，所以不再一一讲述。继续遍历下一个。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>8. RtlDispatchException#2 </span><span class=rvts19>遍历到</span><span class=rvts18> SehTest</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_EHANDLER</span><span class=rvts19>，于是调用其</span><span class=rvts18> UNWIND_INFO::ExceptionRoutine</span><span class=rvts19>，即</span><span class=rvts18> __C_specific_handler$2</span><span class=rvts19>，发现范围匹配，于是调用</span><span class=rvts18> EXCEPT_FILTER_1#1</span><span class=rvts19>，于是又触发异常，这次是</span><span class=rvts18> #3 </span><span class=rvts19>异常。此时的调用栈如下：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(1)&nbsp; Caller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; __C_specific_handler$1</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(2)&nbsp; SehTest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; </span><span class=rvts35>__C_specific_handler$2</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(3)&nbsp; ExRaiseStatus#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(4)&nbsp; RtlDispatchException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(5)&nbsp; RtlpExecuteHandlerForException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler$5</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(6)&nbsp; </span><span class=rvts35>__C_specific_handler$2</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(7)&nbsp; EXCEPT_FILTER_1#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(8)&nbsp; ExRaiseStatus#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(9)&nbsp; RtlDispatchException#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(10) RtlpExecuteHandlerForException#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler$10</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(11) </span><span class=rvts35>__C_specific_handler$2</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(12) EXCEPT_FILTER_1#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>(13) ExRaiseStatus#3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>9. #3 </span><span class=rvts19>异常的处理流程同</span><span class=rvts18> #2 </span><span class=rvts19>的处理流程类似，也会再遍历到</span><span class=rvts18> __C_specific_handler$2</span><span class=rvts19>，也会再调用</span><span class=rvts18> EXCEPT_FILTER_1</span><span class=rvts19>，于是会触发</span><span class=rvts18> #4 </span><span class=rvts19>异常、</span><span class=rvts18>#5 </span><span class=rvts19>异常等等。最终内核栈溢出，</span><span class=rvts18>BSOD</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>以上就是</span><span class=rvts18> </span><span class=rvts10>ExceptionNestedException </span><span class=rvts11>的</span><span class=rvts19>产生</span><span class=rvts11>以及处理的流程。过程中还有一些细节操作，为了描述简洁，我没有在上述过程中一一讲述。</span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>再来看看</span><span class=rvts10> </span><span class=rvts18>ExceptionCollidedUnwind</span><span class=rvts19>。它比</span><span class=rvts18> </span><span class=rvts10>ExceptionNestedException </span><span class=rvts11>更复杂一些，我们以如下伪码为例，</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>1</span><span class=rvts10>&nbsp; VOID SehTest</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>2</span><span class=rvts10>&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>3</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>4</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>5</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExRaiseStatus</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>6</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts20> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>7</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>8</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span><span class=rvts10> </span><span class=rvts25>// FINALLY_HANDLER_1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>9</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExRaiseStatus</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>10</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>11</span><span class=rvts10> </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>12</span><span class=rvts10> </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>13</span><span class=rvts10> VOID Caller</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>14</span><span class=rvts10> </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>15</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>16</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>17</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SehTest</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>18</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>19</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_FILTER_2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>20</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span><span class=rvts10> </span><span class=rvts25>// EXCEPT_HANDLER_2</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>21</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>22</span><span class=rvts10> </span><span class=rvts21>}</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>伪码中也有两处触发异常的地方，第一次在行</span><span class=rvts18>5</span><span class=rvts19>，第二次在行</span><span class=rvts18>9</span><span class=rvts19>。也分别标记为</span><span class=rvts18> EXCEPT_POINT#1 </span><span class=rvts19>和</span><span class=rvts18> EXCEPT_POINT#2</span><span class=rvts19>。处理流程：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. ExRaiseStatus#1 </span><span class=rvts19>创建保存</span><span class=rvts18> EXCEPT_POINT#1 </span><span class=rvts19>的状态</span><span class=rvts18> Context#1</span><span class=rvts19>，并构建一个</span><span class=rvts18> EXCEPTION_RECORD</span><span class=rvts19>，然后将他们作为参数来调用</span><span class=rvts18> RtlDispatchException#1</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. RtlDispatchException#1 </span><span class=rvts19>根据</span><span class=rvts18> Context#1 </span><span class=rvts19>开始遍历：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>首先遍历到</span><span class=rvts18> EXCEPT_POINT#1 </span><span class=rvts19>所在函数</span><span class=rvts18> ExRaiseStatus</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是遍历下一个。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18> SehTest</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_UHANDLER</span><span class=rvts19>，于是继续遍历下一个。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18> Caller</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_EHANDLER</span><span class=rvts19>，于是调用其</span><span class=rvts18> UNWIND_INFO::ExceptionRoutine </span><span class=rvts19>即</span><span class=rvts18> __C_specific_handler</span><span class=rvts19>。</span><span class=rvts18>__C_specific_handler </span><span class=rvts19>发现可以处理该异常，于是以</span><span class=rvts18> EXCEPT_HANDLER_2 </span><span class=rvts19>为</span><span class=rvts18> TargetIp </span><span class=rvts19>参数调用</span><span class=rvts18> RtlUnwindEx</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. RtlUnwindEx </span><span class=rvts19>从自身开始展开，展开到</span><span class=rvts18> SehTest</span><span class=rvts19>，执行</span><span class=rvts18> FINALLY_HANDLER_1 </span><span class=rvts19>时触发新异常。此时调用栈为：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (1)&nbsp; Caller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; </span><span class=rvts35>__C_specific_handler$1</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (2)&nbsp; SehTest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | U&nbsp; &amp; </span><span class=rvts36>__C_specific_handler$2</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (3)&nbsp; ExRaiseStatus#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (4)&nbsp; RtlDispatchException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (5)&nbsp; RtlpExecuteHandlerForException#1&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler$5</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (6)&nbsp; </span><span class=rvts35>__C_specific_handler$1</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (7)&nbsp; RtlUnwindEx#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (8)&nbsp; RtlpExecuteHandlerForUnwind#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | EU &amp; RtlpUnwindHandler$8</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (9)&nbsp; </span><span class=rvts36>__C_specific_handler$2</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (10) FINALLY_HANDLER_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (11) ExRaiseStatus#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts19>需要说明的是，调用栈</span><span class=rvts18>(7) RtlUnwindEx </span><span class=rvts19>创建并初始化了一个</span><span class=rvts18> DISPATCHER_CONTEXT </span><span class=rvts19>变量（后续称之为</span><span class=rvts18> pDispatcherContextForUnwind</span><span class=rvts19>），并作为参数传递给调用栈</span><span class=rvts18>(8) RltpExecuteHandlerForUnwind</span><span class=rvts19>，后者在调用</span><span class=rvts18>(9) __C_specific_handler$2 </span><span class=rvts19>之前</span><span class=rvts11>将</span><span class=rvts10> pDispatcherContextForUnwind </span><span class=rvts19>保存在自己的栈中。此时</span><span class=rvts18> pDispatcherContextForUnwind </span><span class=rvts19>的内容表示的是调用栈</span><span class=rvts18>(2) SehTest </span><span class=rvts19>的情况。后续步骤会用到这个</span><span class=rvts18> pDispatcherContextForUnwind</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>4. (11) ExRaiseStatus#2 </span><span class=rvts19>将</span><span class=rvts18> EXCEPT_POINT#2 </span><span class=rvts19>触发时的状态保存到</span><span class=rvts18> Context#2</span><span class=rvts19>，然后调用</span><span class=rvts18> RtlDispatchException#2 </span><span class=rvts19>进行</span><span class=rvts18> EXCEPT_POINT#2 </span><span class=rvts19>的分发。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>5. RtlDispatchException#2 </span><span class=rvts19>根据</span><span class=rvts18> Context#2 </span><span class=rvts19>开始遍历，</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>首先遍历到</span><span class=rvts18> EXCEPT_POINT#2 </span><span class=rvts19>所在函数</span><span class=rvts18> ExRaiseStatus#2</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是遍历下一个。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18> FINALLY_HANDLER_1</span><span class=rvts19>（同前面提到的</span><span class=rvts18> EXCEPT_FILTER </span><span class=rvts19>一样，</span><span class=rvts18>FINALLY_HANDLER </span><span class=rvts19>实际上也是一个单独的函数，有自己的</span><span class=rvts18> RUNTIME_FUNCTION </span><span class=rvts19>和</span><span class=rvts18> UNWIND_INFO</span><span class=rvts19>），发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>UNW_FLAG_NHANDLER</span><span class=rvts19>，于是遍历下一个。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; </span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18>(9) __C_specific_handler$2</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>为</span><span class=rvts18> UNW_FLAG_NHANDLER</span><span class=rvts19>，于是继续遍历。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18>(8) RtlpExecuteHandlerForUnwind#1</span><span class=rvts19>，发现其</span><span class=rvts18> UNWIND_INFO::Flags </span><span class=rvts19>包含</span><span class=rvts18> UNW_FLAG_EHANDLER</span><span class=rvts19>。于是调用其</span><span class=rvts18> UNWIND_INFO::ExceptionRoutine </span><span class=rvts19>即</span><span class=rvts18> RtlpUnwindHandler$8</span><span class=rvts19>。</span><span class=rvts18>RtlpUnwindHandler$8 </span><span class=rvts19>会取出步骤</span><span class=rvts18>3</span><span class=rvts19>中所提到的</span><span class=rvts18> pDispatcherContextForUnwind</span><span class=rvts19>，将其内容拷贝到自己的传出参数（参考</span><span class=rvts18> RtlpUnwindHandler </span><span class=rvts19>的函数原型）</span><span class=rvts18>pDispatcherContext </span><span class=rvts19>中，然后返回</span><span class=rvts18> ExceptionCollidedUnwind</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>6. RtlDispatchException#2 </span><span class=rvts19>收到</span><span class=rvts18> ExceptionCollidedUnwind </span><span class=rvts19>后，从传回来的</span><span class=rvts18> pDispatchContext </span><span class=rvts19>中取出诸如</span><span class=rvts18> ControlPc</span><span class=rvts19>、</span><span class=rvts18>EstablisherFrame </span><span class=rvts19>等值（如步骤</span><span class=rvts18>3</span><span class=rvts19>所说，此时这些值反应的是</span><span class=rvts18>(2) SehTest </span><span class=rvts19>的状态），用这些值来继续遍历。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>首先遍历到</span><span class=rvts18>(2) SehTest</span><span class=rvts19>，调用</span><span class=rvts18> RtlpExecuteHandlerForException#2</span><span class=rvts19>，进而调用</span><span class=rvts18> __C_specific_handler$2</span><span class=rvts19>，但是发现</span><span class=rvts18> pDispatcherContext-&gt;ScopeIndex</span><span class=rvts19>（步骤</span><span class=rvts18>(9)</span><span class=rvts19>中在调用</span><span class=rvts18>(10) FINALLY_HANDLER_1 </span><span class=rvts19>之前</span><span class=rvts18>+1</span><span class=rvts19>了，参考</span><span class=rvts18> __C_specific_handler </span><span class=rvts19>反汇编码）等于</span><span class=rvts18> pDispatcherContext-&gt;HandlerData-&gt;Count</span><span class=rvts19>。于是继续遍历。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>然后遍历到</span><span class=rvts18>(1) Caller</span><span class=rvts19>，调用</span><span class=rvts18> RtlpExecuteHandlerForException#2</span><span class=rvts19>，进而调用</span><span class=rvts18> __C_specific_handler$1</span><span class=rvts19>，发现它可以处理</span><span class=rvts18> #2 </span><span class=rvts19>异常，于是以</span><span class=rvts18> EXCEPT_HANDLER#2 </span><span class=rvts19>为</span><span class=rvts18> TargetIp </span><span class=rvts19>参数调用</span><span class=rvts18> RtlUnwindEx</span><span class=rvts19>。此时调用栈如下：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (1)&nbsp; Caller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | E&nbsp; &amp; </span><span class=rvts35>__C_specific_handler$1</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (2)&nbsp; SehTest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | U&nbsp; &amp; </span><span class=rvts36>__C_specific_handler$2</span><span class=rvts19>，但没有</span><span class=rvts18> EXCEPT_HANDLER</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (3)&nbsp; ExRaiseStatus#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (4)&nbsp; RtlDispatchException#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (5)&nbsp; RtlpExecuteHandlerForException#1&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler$6</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (6)&nbsp; </span><span class=rvts35>__C_specific_handler$1</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (7)&nbsp; RtlUnwindEx#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (8)&nbsp; RtlpExecuteHandlerForUnwind#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | EU &amp; RtlpUnwindHandler$8</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (9)&nbsp; </span><span class=rvts36>__C_specific_handler$2</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (10) FINALLY_HANDLER#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (11) ExRaiseStatus#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (12) RtlDispatchException#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (13) RtlpExecuteHandlerForException#2&nbsp;&nbsp;&nbsp; | EU &amp; RtlpExceptionHandler</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (14)</span><span class=rvts35> __C_specific_handler$1</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp; (15) RtlUnwindEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | N</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>7. (17) RtlUnwindEx </span><span class=rvts19>展开完毕后，通过</span><span class=rvts18> RtlRestoreContext </span><span class=rvts19>跳转到</span><span class=rvts18> EXCEPT_HANDLER#2 </span><span class=rvts19>继续执行。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>在上述过程中，我们可以发现，遍历过程中</span><span class=rvts18> RtlDispatchException </span><span class=rvts19>等系统函数被频繁遍历到。于是就有了前面提到的全局展开历史表</span><span class=rvts18> RtlpUnwindHistoryTable</span><span class=rvts19>，这个表中存放着</span><span class=rvts18> RtlDispatchException</span><span class=rvts19>、</span><span class=rvts18>RtlUnwindEx </span><span class=rvts19>等函数的</span><span class=rvts18> RUNTIME_FUNCTION </span><span class=rvts19>和</span><span class=rvts18> ImageBase </span><span class=rvts19>信息，这样就不用每次都去解析</span><span class=rvts18> PE+ </span><span class=rvts19>中的</span><span class=rvts18> ExceptionDirectory</span><span class=rvts19>，实现了加速。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>到这里，我们就讲完了</span><span class=rvts18> x64 SEH </span><span class=rvts19>的实现。可以发现，</span><span class=rvts18>x64 </span><span class=rvts19>和</span><span class=rvts18> x86 </span><span class=rvts19>的</span><span class=rvts18> SEH </span><span class=rvts19>思想或者说框架是一样的：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. RtlDispatchException </span><span class=rvts19>和</span><span class=rvts18> RtlUnwindEx </span><span class=rvts19>都对异常注册信息进行遍历。前者是为了分发异常而遍历，后者是为了展开而遍历。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. MSC </span><span class=rvts19>提供的异常处理函数按照“异常解决”和“展开”两个分支，对</span><span class=rvts18> SCOPE_TABLE/scopetable </span><span class=rvts19>进行遍历。前者是为了找到</span><span class=rvts18> EXCEPT_FILTER &amp; EXCEPT_HANDLER</span><span class=rvts19>，后者是为了找到</span><span class=rvts18> FINALLY_HANDLER</span><span class=rvts19>。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>3. RtlDispatchException </span><span class=rvts19>和</span><span class=rvts18> RtlUnwindEx </span><span class=rvts19>借助</span><span class=rvts18> MSC </span><span class=rvts19>提供的异常处理函数这个桥梁，配合处理异常。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>主要的改变有两点：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>1. RtlDispatchException </span><span class=rvts19>和</span><span class=rvts18> RtlUnwindEx </span><span class=rvts19>通过调用</span><span class=rvts18> RtlVirtualUnwind </span><span class=rvts19>推动遍历。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>2. </span><span class=rvts19>所有的非叶函数都参与到</span><span class=rvts18> SEH</span><span class=rvts19>，尽管大部分的函数都没有使用到</span><span class=rvts18> SEH</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>以上我们主要讲述的是</span><span class=rvts18> x64 SEH </span><span class=rvts19>的内部实现。对于使用者，也有一个好消息，我们来看看，</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>C </span><span class=rvts19>代码：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>VOID SehTest</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExRaiseStatus</span><span class=rvts21>(</span><span class=rvts10>STATUS_INVALID_PARAMETER</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __try \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>((</span><span class=rvts10>STATUS_INVALID_PARAMETER </span><span class=rvts21>==</span><span class=rvts10> GetExceptionCode</span><span class=rvts21>())</span><span class=rvts10> </span><span class=rvts21>?</span><span class=rvts10> EXCEPTION_CONTINUE_SEARCH </span><span class=rvts21>:</span><span class=rvts10> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __except \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __finally \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>反汇编码：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>kd</span><span class=rvts21>&gt;</span><span class=rvts10> uf passthrough!SehTest</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>PassThrough!SehTest</span><span class=rvts21>:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100020 </span><span class=rvts22>sub</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>38h</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100024 </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>0C000000Dh</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100029 </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>PassThrough!_imp_ExRaiseStatus </span><span class=rvts21>(</span><span class=rvts10>fffffadf`f1101050</span><span class=rvts21>)]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f110002f </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,[</span><span class=rvts10>PassThrough! ?? </span><span class=rvts21>::</span><span class=rvts10>FNODOBFM</span><span class=rvts21>::</span><span class=rvts10>`string' (fffffadf`f1100500)]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100036 </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edx</span><span class=rvts21>,</span><span class=rvts20>39h</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f110003b </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,[</span><span class=rvts10>PassThrough! ?? </span><span class=rvts21>::</span><span class=rvts10>FNODOBFM</span><span class=rvts21>::</span><span class=rvts10>`string' (fffffadf`f1100540)]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100042 </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PassThrough!DbgPrint </span><span class=rvts21>(</span><span class=rvts10>fffffadf`f11004a6</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100047 </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest</span><span class=rvts21>+</span><span class=rvts20>0x42</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffffadf`f1100062</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>PassThrough!SehTest</span><span class=rvts21>+</span><span class=rvts20>0x42</span><span class=rvts21>:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100062 </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,[</span><span class=rvts10>PassThrough! ?? </span><span class=rvts21>::</span><span class=rvts10>FNODOBFM</span><span class=rvts21>::</span><span class=rvts10>`string' (fffffadf`f1100500)]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100069 </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>edx</span><span class=rvts21>,</span><span class=rvts20>42h</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f110006e </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,[</span><span class=rvts10>PassThrough! ?? </span><span class=rvts21>::</span><span class=rvts10>FNODOBFM</span><span class=rvts21>::</span><span class=rvts10>`string' (fffffadf`f1100570)]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f1100075 </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PassThrough!DbgPrint </span><span class=rvts21>(</span><span class=rvts10>fffffadf`f11004a6</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f110007a </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>38h</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>fffffadf`f110007e ret</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>我们发现</span><span class=rvts18> SehTest </span><span class=rvts19>内部完全没有任何</span><span class=rvts18> SEH </span><span class=rvts19>的踪迹，不像</span><span class=rvts18> x86 </span><span class=rvts19>那样会有创建、销毁</span><span class=rvts18> EXCEPTION_REGISTRATION_RECORD </span><span class=rvts19>和调整</span><span class=rvts18> EXCEPTION_REGISTRATION_RECORD::trylevel </span><span class=rvts19>等操作。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>这样的好处就是使用者无需再担心性能损耗，可以放心大胆的使用</span><span class=rvts18> SEH </span><span class=rvts19>机制了。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts23>附录一</span></p>
<p><span class=rvts34><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>为了方便自己分析，我写了一个简单的</span><span class=rvts18> windbg </span><span class=rvts19>扩展，提供了几个</span><span class=rvts18> x64 seh </span><span class=rvts19>常用功能：</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>!boxr.unwindinfo&nbsp;&nbsp;&nbsp; module-name&nbsp;&nbsp;&nbsp; unwindinfo_addr</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>功能：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>用于查询指定</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>结构的详细信息。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>参数说明：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>module-name </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>待查询的</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>结构对应函数的模块名</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>unwindinfo_addr </span><span class=rvts19>——</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>结构的绝对地址</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>!boxr.rtfn&nbsp;&nbsp;&nbsp; option&nbsp;&nbsp;&nbsp; module&nbsp;&nbsp;&nbsp; runtimefunction_addr</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>功能：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>用于查询指定</span><span class=rvts18> RUNTIME_FUNCTION </span><span class=rvts19>结构的详细信息。（</span><span class=rvts18>rtfn </span><span class=rvts19>表示</span><span class=rvts18> RunTime_FunctioN</span><span class=rvts19>）</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>参数说明：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>option </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>参数选项，目前支持两种：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>/a </span><span class=rvts19>表示</span><span class=rvts18> module </span><span class=rvts19>参数为模块基地址</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>/n </span><span class=rvts19>表示</span><span class=rvts18> module </span><span class=rvts19>参数为模块名称</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>module </span><span class=rvts19>——</span><span class=rvts18> RUNTIME_FUNCTION </span><span class=rvts19>结构对应函数所在的模块，具体形式根据</span><span class=rvts18> option </span><span class=rvts19>而定。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>runtimefunction_addr </span><span class=rvts19>——</span><span class=rvts18> </span><span class=rvts19>需要查询的</span><span class=rvts18> RUNTIME_FUNCTION </span><span class=rvts19>结构体的绝对地址。支持</span><span class=rvts18> @rax </span><span class=rvts19>操作方式，但不支持复杂的组合，比如</span><span class=rvts18> @rax+8</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>使用的方法是：用</span><span class=rvts18> .extpath+ </span><span class=rvts19>命令将</span><span class=rvts18> boxr.dll </span><span class=rvts19>所在的目录添加到</span><span class=rvts18> windbg </span><span class=rvts19>的搜索路径中，然后就可以使用了。需要卸载时就</span><span class=rvts18> .unload</span><span class=rvts19>。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>简单说明一下这两个命令。</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>比如我们要查看下面这个函数的</span><span class=rvts18> UNWIND_INFO </span><span class=rvts19>信息：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>VOID SehTest</span><span class=rvts21>()</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __try \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __except \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CollidedUnwind</span><span class=rvts21>();</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __except \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __except \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __finally \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __try \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __try \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __finally \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; __except</span><span class=rvts21>(</span><span class=rvts10>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts21>)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>{</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts21>(</span><span class=rvts37>"%u [%s] __except \n"</span><span class=rvts21>,</span><span class=rvts10> __LINE__</span><span class=rvts21>,</span><span class=rvts10> __FILE__</span><span class=rvts21>);</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts22>return</span><span class=rvts21>;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>}</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts11>操作步骤：</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>1. </span><span class=rvts11>使用</span><span class=rvts10> .fnent </span><span class=rvts11>命令获得</span><span class=rvts10> SehTest </span><span class=rvts11>的基本信息，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>kd&gt; .fnent passthrough!SehTest</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Debugger function entry 00000000`00758210 for:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>(fffffadf`f135d080)&nbsp;&nbsp; PassThrough!SehTest&nbsp;&nbsp; |&nbsp; (fffffadf`f135d180)&nbsp;&nbsp; PassThrough!LeafTest</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Exact matches:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PassThrough!SehTest (void)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>BeginAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`00001080</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>EndAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 00000000`00001175</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UnwindInfoAddress = 00000000`000026b8</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Unwind info at </span><span class=rvts38>fffffadf`f135e6b8</span><span class=rvts10>, 10 bytes</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp; version 1, flags 3, prolog 4, codes 1</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp; handler routine: PassThrough!_C_specific_handler (fffffadf`f135d5de), data 6</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp; 00: offs 4, unwind op 2, op info 4</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>UWOP_ALLOC_SMALL.</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>2. </span><span class=rvts11>使用</span><span class=rvts10> !boxr.unwindinfo </span><span class=rvts11>查询详细信息，</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>kd&gt; !boxr.unwindinfo passthrough </span><span class=rvts38>fffffadf`f135e6b8</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>_UNWIND_INFO for fffffadff135e6b8 </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>Flags:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; EU</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ExceptionRoutine:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; PassThrough!_C_specific_handler (fffffadf`f135d5de)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>ScopeTable:</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; Count: 6</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ScopeRecord[0]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (fffffadff135e6c8)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BeginAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0x4 (fffffadf`f135d084)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EndAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0x1e (fffffadf`f135d09e)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HandlerAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest$filt$0 (fffffadf`f135d8a0)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JumpTarget: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0x1e (fffffadf`f135d09e)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; [</span><span class=rvts11>省略中间</span><span class=rvts10>3</span><span class=rvts11>个</span><span class=rvts10> ScopeRecord </span><span class=rvts11>成员</span><span class=rvts10>]</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp; ScopeRecord[5]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (fffffadff135e718)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BeginAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0x8b (fffffadf`f135d10b)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EndAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0xd7 (fffffadf`f135d157)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HandlerAddress: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest$filt$5 (fffffadf`f135d960)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JumpTarget: </span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest+0xd7 (fffffadf`f135d157)</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>!boxr.rtfn </span><span class=rvts19>的用法也类似，比如：</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>kd&gt; !box.rtfn /n passThrough @rax</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>_RUNTIME_FUNCTION for fffffadff1113000 </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>BeginAddress:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; PassThrough!CollidedUnwind (fffffadf`f1110020)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>EndAddress:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; PassThrough!CollidedUnwind+0x38 (fffffadf`f1110058)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>UnwindData:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; fffffadff1111688</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>_UNWIND_INFO for fffffadff1111688 </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>Flags:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; U</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>ExceptionRoutine:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; PassThrough!_C_specific_handler (fffffadf`f11104ee)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>ScopeTable:</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; Count: 1</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp; ScopeRecord[0]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (fffffadff1111698)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BeginAddress: </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!CollidedUnwind+0x4 (fffffadf`f1110024)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EndAddress: </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!CollidedUnwind+0x10 (fffffadf`f1110030)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HandlerAddress: </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!CollidedUnwind$fin$0 (fffffadf`f1110750)</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JumpTarget: </span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>需要说明的是，我写这个扩展的目的仅仅是为了分析</span><span class=rvts18> x64 SEH </span><span class=rvts19>过程中能轻松的查看相关数据结构的详细信息，所以并没有在这个扩展上花很多时间。其代码是从</span><span class=rvts18> MS </span><span class=rvts19>例子代码的基础上增加了我需要的功能。应该有一些</span><span class=rvts18> BUG</span><span class=rvts19>，但是对我来说不重要，已经满足我的需要了。源码也放在附件里，方便分析的朋友根据自己的需要进行修改。</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>另外有一个疑问：我编译的</span><span class=rvts18> x64 wrk1.2 </span><span class=rvts19>内核无法对</span><span class=rvts18> .c</span><span class=rvts19>代码进行源码调试，对</span><span class=rvts18> .asm </span><span class=rvts19>代码倒是可以，这是为什么？我看了一下编译选项，没看出什么猫腻。有经验的朋友分享一下吧，感谢</span><span class=rvts18> :-)</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts23>附录二</span><span class=rvts34> RtlUnwindEx </span><span class=rvts23>的反汇编代码和注释</span></p>
<p><span class=rvts34><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>由于无法源码调试，只好把它反汇编出来加上注释……</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RtlUnwindEx </span><span class=rvts21>(</span></p>
<p><span class=rvts25>/* rcx&nbsp;&nbsp;&nbsp; */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PVOID pEstablisherFrame OPTIONAL</span><span class=rvts21>,</span></p>
<p><span class=rvts25>/* rdx&nbsp;&nbsp;&nbsp; */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PVOID pJumpTargetIp OPTIONAL</span><span class=rvts21>,</span></p>
<p><span class=rvts25>/* r8&nbsp;&nbsp;&nbsp;&nbsp; */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD pExceptionRecord OPTIONAL</span><span class=rvts21>,</span></p>
<p><span class=rvts25>/* r9&nbsp;&nbsp;&nbsp;&nbsp; */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PVOID ReturnValue</span><span class=rvts21>,</span></p>
<p><span class=rvts25>/* rsp+28 */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PCONTEXT pOriginalContext</span><span class=rvts21>,</span></p>
<p><span class=rvts25>/* rsp+30 */</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; IN PUNWIND_HISTORY_TABLE pHistoryTable OPTIONAL</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>);</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts21>&gt;</span><span class=rvts10> uf nt!RtlUnwindEx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e70</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>r9</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e75</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>18h</span><span class=rvts21>],</span><span class=rvts10>r8</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e7a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>10h</span><span class=rvts21>],</span><span class=rvts10>rdx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e7f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rsp</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e82</span><span class=rvts10> </span><span class=rvts22>sub</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>678h</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e89</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>8</span><span class=rvts21>],</span><span class=rvts10>rbx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e8d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>10h</span><span class=rvts21>],</span><span class=rvts10>rbp</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e91</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>18h</span><span class=rvts21>],</span><span class=rvts10>rsi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e95</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A0h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rsi = pOriginalContext</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891e9d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>rdi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ea1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>28h</span><span class=rvts21>],</span><span class=rvts10>r12</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ea5</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>40h</span><span class=rvts21>],</span><span class=rvts10>r15</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ea9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rcx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891eac</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15</span><span class=rvts21>,</span><span class=rvts10>rdx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891eaf</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rsp+40 </span><span class=rvts30>为</span><span class=rvts25> l_HighLimit</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891eb4</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rsp+50 </span><span class=rvts30>为</span><span class=rvts25> l_LowLimit</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891eb9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>r8</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ebc</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,</span><span class=rvts10>rsi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ebf</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,[</span><span class=rvts10>rax</span><span class=rvts21>-</span><span class=rvts20>518h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r12 = &amp;l_Context</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ec6</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlpGetStackLimits </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00890da0</span><span class=rvts21>)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ecb</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>rsi</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ece</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlCaptureContext </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008bd150</span><span class=rvts21>)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ed3</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = pHistoryTable</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891edb</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax</span></p>
<p><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ede</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x74</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891ee4</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x70</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ee0</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>byte</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rax</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>],</span><span class=rvts20>1</span><span class=rvts10> </span><span class=rvts25>; pHistoryTable-&gt;Search = UNWIND_HISTORY_TABLE_GLOBAL</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x74</span><span class=rvts21>:</span></p>
<p><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ee4</span><span class=rvts10> </span><span class=rvts22>xor</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts31>ecx</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ee6</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rbx </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> pExceptionRecord </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ee9</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0xbc</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891f2c</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x7b</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; pExceptionRecord </span><span class=rvts30>等于</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891eeb</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsi</span><span class=rvts21>+</span><span class=rvts20>0F8h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891ef2</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0C0h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rbx = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891efa</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0C0h</span><span class=rvts21>],</span><span class=rvts20>0C0000027h</span><span class=rvts10> </span><span class=rvts25>; l_ExceptionRecord.ExceptionCode = STATUS_UNWIND (0xC0000027)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f05</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0D0h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; l_ExceptionRecord.ExceptionAddress = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f0d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A8h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = pHistoryTable</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f15</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>690h</span><span class=rvts21>],</span><span class=rvts10>rbx&nbsp; </span><span class=rvts25>; [r8-home] = &amp;l_ExceptionRecord ????</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f1d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0C8h</span><span class=rvts21>],</span><span class=rvts10>rcx&nbsp; </span><span class=rvts25>; l_ExceptionRecord.ExceptionRecord = NULL</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f25</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0D8h</span><span class=rvts21>],</span><span class=rvts31>ecx</span><span class=rvts10>&nbsp; </span><span class=rvts25>; l_ExceptionRecord.NumberParameters = 0</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0xbc</span><span class=rvts21>:</span></p>
<p><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f2c</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rbx = &amp;[rcx-home]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f34</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>esi</span><span class=rvts21>,</span><span class=rvts20>2</span><span class=rvts10> </span><span class=rvts25>; l_ExceptionFlags(esi) = EXCEPTION_UNWINDING (2)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f39</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>6</span><span class=rvts10> </span><span class=rvts25>; ecx = EXCEPTION_EXIT_UNWIND (6)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f3e</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rbp </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> pEstablisherFrame </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f41</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>648h</span><span class=rvts21>],</span><span class=rvts10>r13 </span><span class=rvts25>; </span><span class=rvts30>保存</span><span class=rvts25> r13 </span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f49</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>640h</span><span class=rvts21>],</span><span class=rvts10>r14 </span><span class=rvts25>; </span><span class=rvts30>保存</span><span class=rvts25> r14</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f51</span><span class=rvts10> </span><span class=rvts22>cmove</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts31>esi</span><span class=rvts21>,</span><span class=rvts31>ecx</span><span class=rvts10> </span><span class=rvts25>; if (NULL == pEstablisherFrame) { l_ExceptionFlags = EXCEPTION_EXIT_UNWIND (6) }</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f54</span><span class=rvts10> </span><span class=rvts22>xchg</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ax</span><span class=rvts21>,</span><span class=rvts31>ax</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f58</span><span class=rvts10> </span><span class=rvts22>xchg</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ax</span><span class=rvts21>,</span><span class=rvts31>ax</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00891f5c</span><span class=rvts10> </span><span class=rvts22>xchg</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ax</span><span class=rvts21>,</span><span class=rvts31>ax</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0xf0</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> fffff800`</span><span class=rvts20>00891f60</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>0F8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r13 = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f67</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>60h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rdx = &amp;l_pImageBase</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f6c</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r8 = pHistoryTable</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f6f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>r13</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f72</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>68h</span><span class=rvts21>],</span><span class=rvts10>r13</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f77</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlLookupFunctionEntry </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00890e60</span><span class=rvts21>)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_pFunctionEntry = RtlLookupFunctionEntry(pOriginalContext-&gt;Rip, </span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_pImageBase,</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pHistoryTable)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f7c</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> l_pFunctionEntry (eax) </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f7f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r14</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; r14 = l_pFunctionEntry</span></p>
<p><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f82</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3ab</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>0089221b</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x118</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f88</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rdi </span><span class=rvts25>; rdx = pOriginalContext</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f8b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>r12 </span><span class=rvts25>; rcx = &amp;l_Context</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f8e</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlpCopyContext </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891080</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; RtlpCopyContext(&amp;l_Context, pOriginalContext)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f93</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>60h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rdx = l_pImageBase</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891f98</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>38h</span><span class=rvts21>],</span><span class=rvts20>0</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; _ARG_8 = 0</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fa1</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = &amp;[rcx-home]</span><span class=rvts30>，这里被用作局部变量</span><span class=rvts25> l_pEstablisherFrame </span><span class=rvts30>空间</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fa9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r9</span><span class=rvts21>,</span><span class=rvts10>r14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r9 = l_pFunctionEntry</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fac</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,</span><span class=rvts10>r13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r8 = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891faf</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>30h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG7 = &amp;l_pEstablisherFrame</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fb4</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>58h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = &amp;l_pHandlerData</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fb9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>2</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; ecx = UNW_FLAG_UHANDLER (2)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fbe</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>28h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_6 = &amp;l_pHandlerData</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fc3</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>r12 </span><span class=rvts25>; _ARG_5 = &amp;l_Context</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fc8</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlVirtualUnwind </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891380</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_pExceptionRoutine = RtlVirtualUnwind(UNW_FLAG_UHANDLER,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_pImageBase,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pOriginalContext-&gt;Rip,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_pFunctionEntry,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_Context,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_pHandlerData,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_pEstablisherFrame,</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL);</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fcd</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = l_pEstablisherFrame</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fd5</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rcx = l_pExceptionRoutine</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fd8</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>],</span><span class=rvts10>rax</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fdd</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>bl</span><span class=rvts21>,</span><span class=rvts20>7</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> l_pEstablisherFrame </span><span class=rvts30>是否对齐</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fe0</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x176</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fe6</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; cmp l_pEstablisherFrame, l_LowLimit</span></p>
<p><span class=rvts10>..</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891feb</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x184</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891ff4</span><span class=rvts21>)</span></p>
<p><span class=rvts10>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x17d</span><span class=rvts21>:</span></p>
<p><span class=rvts10>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891fed</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; cmp l_pEstablisherFrame, l_HighLimit</span></p>
<p><span class=rvts10>...</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891ff2</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1d3</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892043</span><span class=rvts21>)</span></p>
<p><span class=rvts10>....&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>....&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x184</span><span class=rvts21>:</span></p>
<p><span class=rvts10>....&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> l_pEstablisherFrame </span><span class=rvts30>是否合法</span></p>
<p><span class=rvts10>..</span><span class=rvts21>&gt;</span><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891ff4</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>cl</span><span class=rvts21>,byte</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts31>gs</span><span class=rvts21>:[</span><span class=rvts20>20DEh</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; cl = _KPCR-&gt;DpcRoutineActive</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891ffc</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>cl</span><span class=rvts21>,</span><span class=rvts31>cl</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>判断当前是否在执行</span><span class=rvts25> DPC</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00891ffe</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>如果是在执行</span><span class=rvts25> DPC </span><span class=rvts30>则失败？</span><span class=rvts25>??</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x194</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892004</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = l_HighLimit</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892009</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>-</span><span class=rvts20>28h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089200d</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> l_KernelStackCtrl-&gt;Previous.StackBase </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892010</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1a6</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892016</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>-</span><span class=rvts20>20h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rdx = l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089201a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = l_pEstablisherFrame</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892022</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_pEstablisherFrame, l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892025</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1bb</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089202b</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; cmp l_pEstablisherFrame, l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089202e</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1c4</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892034</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = l_pExceptionRoutine</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892039</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>],</span><span class=rvts10>rdx </span><span class=rvts25>; l_LowLimit = l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089203e</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; l_HighLimit = l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1d3</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892043</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rbp </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> pEstablisherFrame </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>.. </span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892046</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1e1</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892051</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1d8</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892048</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rbx </span><span class=rvts25>; cmp pEstablisherFrame, l_pEstablisherFrame</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089204b</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922a1</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>.. .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1e1</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.. </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892051</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>rcx </span><span class=rvts25>; </span><span class=rvts30>判断</span><span class=rvts25> l_pExceptionRoutine </span><span class=rvts30>是否为</span><span class=rvts25> NULL</span></p>
<p><span class=rvts10>..&nbsp; </span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892054</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x39b</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>0089220b</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x1ea</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089205a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>58h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r13 = l_pHandlerData</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089205f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>90h</span><span class=rvts21>],</span><span class=rvts10>r15 </span><span class=rvts25>; [rsp+90] = pJumpTargetIp</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892067</span><span class=rvts10> </span><span class=rvts22>xor</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15d</span><span class=rvts21>,</span><span class=rvts10>r15d</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089206a</span><span class=rvts10> </span><span class=rvts22>xchg</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ax</span><span class=rvts21>,</span><span class=rvts31>ax</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089206d</span><span class=rvts10> </span><span class=rvts22>xchg</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ax</span><span class=rvts21>,</span><span class=rvts31>ax</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x200</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> . fffff800`</span><span class=rvts20>00892070</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,</span><span class=rvts10>rbx </span><span class=rvts25>; cmp pEstablisherFrame, l_pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892073</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x208</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892078</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . </span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x205</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892075</span><span class=rvts10> </span><span class=rvts22>or</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>esi</span><span class=rvts21>,</span><span class=rvts20>20h</span><span class=rvts10> </span><span class=rvts25>; l_ExceptionFlags |= EXCEPTION_TARGET_UNWIND (0x20)</span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . </span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x208</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; .</span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892078</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r10</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>690h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r10 = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892080</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>698h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = ReturnValue</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892088</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0A0h</span><span class=rvts21>],</span><span class=rvts10>rcx </span><span class=rvts25>; l_DispatcherContext.LanguageHandler = l_pExceptionRoutine</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892090</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>r10</span><span class=rvts21>+</span><span class=rvts20>4</span><span class=rvts21>],</span><span class=rvts31>esi</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_ExceptionRecord.ExceptionFlags = l_ExceptionFlags</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892094</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>78h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; pOriginalContext-&gt;Rax = ReturnValue</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892098</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>68h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>0089209d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>70h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; l_DispatcherContext.ControlPc = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920a2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>60h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = l_pImageBase</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920a7</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r9</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>70h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r9 = &amp;l_DispatcherContext</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920ac</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>78h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; l_DispatcherContext.ImageBase = l_pImageBase</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920b1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = pHistoryTable</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920b9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,</span><span class=rvts10>rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r8 = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920bc</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rbx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdx = l_pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920bf</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>r10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rcx = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920c2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>80h</span><span class=rvts21>],</span><span class=rvts10>r14&nbsp;&nbsp; </span><span class=rvts25>; l_DispatcherContext.FunctionEntry = l_pFunctionEntry</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920ca</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0B0h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; l_DispatcherContext.HistoryTable = pHistoryTable</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920d2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>88h</span><span class=rvts21>],</span><span class=rvts10>rbx&nbsp;&nbsp; </span><span class=rvts25>; l_DispatcherContext.EstablisherFrame = l_pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920da</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>98h</span><span class=rvts21>],</span><span class=rvts10>rdi&nbsp;&nbsp; </span><span class=rvts25>; l_DispatcherContext.ContextRecord = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920e2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0A8h</span><span class=rvts21>],</span><span class=rvts10>r13&nbsp; </span><span class=rvts25>; l_DispatcherContext.HandlerData = l_pHandlerData</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920ea</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0B8h</span><span class=rvts21>],</span><span class=rvts10>r15d </span><span class=rvts25>; l_DispatcherContext.ScopeIndex = 0</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920f2</span><span class=rvts10> </span><span class=rvts22>and</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>esi</span><span class=rvts21>,</span><span class=rvts20>0FFFFFF9Fh</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_ExceptionFlags &amp;= ~(EXCEPTION_TARGET_UNWIND|EXCEPTION_COLLIDED_UNWIND)</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920f5</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlpExecuteHandlerForUnwind </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008bd9d0</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; RtlpExecuteHandlerForUnwind(&amp;l_ExceptionRecord,</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_pEstablisherFrame,</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pOriginalContext,</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_DispatcherContext);</span></p>
<p><span class=rvts10>..&nbsp; .&nbsp;&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920fa</span><span class=rvts10> </span><span class=rvts22>dec</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span></p>
<p><span class=rvts10>..&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>008920fc</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x368</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008921d8</span><span class=rvts21>)</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>如果返回</span><span class=rvts25> ExceptionContinueSearch </span><span class=rvts30>则跳转</span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . </span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x292</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; ..&nbsp;&nbsp; . . fffff800`</span><span class=rvts20>00892102</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>eax</span><span class=rvts21>,</span><span class=rvts20>2</span><span class=rvts10> </span><span class=rvts25>; cmp eax, ExceptionCollidedUnwind (3 - 1)</span></p>
<p><span class=rvts10>..&nbsp; ..</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp; . . fffff800`</span><span class=rvts20>00892105</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x426</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892296</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . </span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x29b</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . </span><span class=rvts25>; ExceptionCollidedUnwind </span><span class=rvts30>的情况</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089210b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>70h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; r8 = l_DispatcherContext.ControlPc</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892110</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r10</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>78h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; r10 = l_DispatcherContext.ImageBase</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892115</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>98h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rdx = l_DispatcherContext.ContextRecord</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089211d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A0h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892125</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r14</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>80h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; r14 = l_DispatcherContext.FunctionEntry</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089212d</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>68h</span><span class=rvts21>],</span><span class=rvts10>r8</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892132</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>60h</span><span class=rvts21>],</span><span class=rvts10>r10</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892137</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlpCopyContext </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891080</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RtlpCopyContext(pOriginalContext, l_DispatcherContext.ContextRecord);</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089213c</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rcx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdx = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089213f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,</span><span class=rvts10>rcx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdi = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892142</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>160h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089214a</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>160h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r12 = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892152</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlpCopyContext </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891080</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RtlpCopyContext(&amp;l_Context, pOriginalContext);</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892157</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>38h</span><span class=rvts21>],</span><span class=rvts20>0</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; _ARG_8 = NULL</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892160</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = &amp;l_pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892168</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>30h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_7 = &amp;l_pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089216d</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>58h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = &amp;l_pHandlerData</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892172</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r9</span><span class=rvts21>,</span><span class=rvts10>r14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r9 = l_DispatcherContext.FunctionEntry</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892175</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>28h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_6 = &amp;l_pHandlerData</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089217a</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>160h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892182</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>r10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdx = l_DispatcherContext.ImageBase</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892185</span><span class=rvts10> </span><span class=rvts22>xor</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts31>ecx</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; ecx = UNW_FLAG_NHANDLER (0)</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892187</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>20h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; _ARG_5 = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>0089218c</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlVirtualUnwind </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891380</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; RtlVirtualUnwind(UNW_FLAG_NHANDLER,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_DispatcherContext.ImageBase,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_DispatcherContext.ControlPc,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_DispatcherContext.FunctionEntry,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_Context,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_pHandlerData,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;l_pEstablisherFrame,</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL);</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892191</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>88h</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp; </span><span class=rvts25>; rbx = l_DispatcherContext.EstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>00892199</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0A0h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rcx = l_DispatcherContext.LanguageHandler</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921a1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0A8h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; r13 = l_DispatcherContext.HandlerData</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921a9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0B0h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = l_DispatcherContext.HistoryTable</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921b1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15d</span><span class=rvts21>,dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>0B8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r15d = l_DispatcherContext.ScopeIndex</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921b9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>],</span><span class=rvts10>rbx&nbsp; </span><span class=rvts25>; l_pEstablisherFrame = l_DispatcherContext.EstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921c1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>],</span><span class=rvts10>rcx&nbsp;&nbsp; </span><span class=rvts25>; l_pExceptionRoutine = l_DispatcherContext.LanguageHandler</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921c6</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>58h</span><span class=rvts21>],</span><span class=rvts10>r13&nbsp;&nbsp; </span><span class=rvts25>; l_pHandlerData = l_DispatcherContext.HandlerData</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921cb</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A8h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; pHistoryTable = l_DispatcherContext.HistoryTable</span></p>
<p><span class=rvts10>..&nbsp; ...&nbsp; . . fffff800`</span><span class=rvts20>008921d3</span><span class=rvts10> </span><span class=rvts22>or</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>esi</span><span class=rvts21>,</span><span class=rvts20>40h</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; l_ExceptionFlags |= EXCEPTION_COLLIDED_UNWIND (40)</span></p>
<p><span class=rvts10>..&nbsp; ...</span><span class=rvts21>&lt;</span><span class=rvts10> . . fffff800`</span><span class=rvts20>008921d6</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x382</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008921f2</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; .... . . </span></p>
<p><span class=rvts10>..&nbsp; .... . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x368</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; .</span><span class=rvts21>&gt;</span><span class=rvts10>.. . . fffff800`</span><span class=rvts20>008921d8</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rbp </span><span class=rvts25>; cmp l_DispatcherContext.EstablisherFrame, pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp; . ..</span><span class=rvts21>&lt;</span><span class=rvts10>. . fffff800`</span><span class=rvts20>008921db</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x37d</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008921ed</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; . .... . </span></p>
<p><span class=rvts10>..&nbsp; . .... . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x36d</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; . .... . fffff800`</span><span class=rvts20>008921dd</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = l_pExceptionRoutine</span></p>
<p><span class=rvts10>..&nbsp; . .... . fffff800`</span><span class=rvts20>008921e2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; . .... . fffff800`</span><span class=rvts20>008921e5</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,</span><span class=rvts10>r12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdi = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp; . .... . fffff800`</span><span class=rvts20>008921e8</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,</span><span class=rvts10>rax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r12 = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp; . .v.. . fffff800`</span><span class=rvts20>008921eb</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x382</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008921f2</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; . .... . </span></p>
<p><span class=rvts10>..&nbsp; . .... . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x37d</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; . ..</span><span class=rvts21>&gt;</span><span class=rvts10>. . fffff800`</span><span class=rvts20>008921ed</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>48h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = l_pExceptionRoutine</span></p>
<p><span class=rvts10>..&nbsp; . .. . . </span></p>
<p><span class=rvts10>..&nbsp; . .. . . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x382</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; . .</span><span class=rvts21>&gt;</span><span class=rvts10> . . fffff800`</span><span class=rvts20>008921f2</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; sil</span><span class=rvts21>,</span><span class=rvts20>40h</span><span class=rvts10>&nbsp; </span><span class=rvts25>; test sil, EXCEPTION_COLLIDED_UNWIND (40)</span></p>
<p><span class=rvts10>..&nbsp; . .&nbsp; </span><span class=rvts21>&lt;</span><span class=rvts10> . fffff800`</span><span class=rvts20>008921f6</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x200</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892070</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; . .&nbsp;&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp; . .&nbsp;&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x38c</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; . .&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>008921fc</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>68h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; r13 = pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10>..&nbsp; . .&nbsp;&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892201</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>688h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; r15 = pJumpTargetIp</span></p>
<p><span class=rvts10>..&nbsp; . .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892209</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3c7</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892237</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp; . ..&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp; . ..&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x39b</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089220b</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rbp&nbsp; </span><span class=rvts25>; cmp l_DispatcherContext.EstablisherFrame, pEstablisherFrame</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089220e</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3c7</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892237</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3a0</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892210</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rdi </span><span class=rvts25>; rax = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892213</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,</span><span class=rvts10>r12 </span><span class=rvts25>; rdi = pOriginalContext</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892216</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; r12 = &amp;l_Context</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892219</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3c7</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892237</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3ab</span><span class=rvts21>:</span></p>
<p><span class=rvts21>&gt;</span><span class=rvts10>.&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089221b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>98h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rcx = pOriginalContext-&gt;Rsp</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892222</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = pOriginalContext-&gt;Rsp[0]</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892225</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>0F8h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; pOriginalContext-&gt;Rip = pOriginalContext-&gt;Rsp[0]</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089222c</span><span class=rvts10> </span><span class=rvts22>lea</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,[</span><span class=rvts10>rcx</span><span class=rvts21>+</span><span class=rvts20>8</span><span class=rvts21>]</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rax = pOriginalContext-&gt;Rsp + 8</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892230</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>98h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp; </span><span class=rvts25>; pOriginalContext-&gt;Rsp = pOriginalContext-&gt;Rsp + 8 </span><span class=rvts30>（跳过返回值）</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; .</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3c7</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp; . fffff800`</span><span class=rvts20>00892237</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>bl</span><span class=rvts21>,</span><span class=rvts20>7</span><span class=rvts10> </span><span class=rvts25>; </span><span class=rvts30>检查</span><span class=rvts25> l_DispatcherContext.EstablisherFrame </span><span class=rvts30>是否对齐</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089223a</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x444</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922b4</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3cc</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..&nbsp;&nbsp; . fffff800`</span><span class=rvts20>0089223c</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; cmp l_DispatcherContext.EstablisherFrame, l_LowLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp; . fffff800`</span><span class=rvts20>00892241</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3da</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>0089224a</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ...&nbsp; . </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ...&nbsp; . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3d3</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ...&nbsp; . fffff800`</span><span class=rvts20>00892243</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; cmp l_DispatcherContext.EstablisherFrame, l_HighLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ...</span><span class=rvts21>&lt;</span><span class=rvts10> . fffff800`</span><span class=rvts20>00892248</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x414</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892284</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .... . </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .... . nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3da</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; ..</span><span class=rvts21>&gt;</span><span class=rvts10>. . fffff800`</span><span class=rvts20>0089224a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>al</span><span class=rvts21>,byte</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts31>gs</span><span class=rvts21>:[</span><span class=rvts20>20DEh</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; al = _KPCR-&gt;DpcRoutineActive</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. . . fffff800`</span><span class=rvts20>00892252</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; </span><span class=rvts31>al</span><span class=rvts21>,</span><span class=rvts31>al</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. .</span><span class=rvts21>&lt;</span><span class=rvts10>. fffff800`</span><span class=rvts20>00892254</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x43c</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922ac</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3e6</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892256</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = l_HighLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>0089225b</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>-</span><span class=rvts20>28h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>0089225f</span><span class=rvts10> </span><span class=rvts22>test</span><span class=rvts10>&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,</span><span class=rvts10>rax</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. .</span><span class=rvts21>&lt;</span><span class=rvts10>. fffff800`</span><span class=rvts20>00892262</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x43c</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922ac</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x3f4</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892264</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rcx</span><span class=rvts21>-</span><span class=rvts20>20h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rdx = l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892268</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = l_pEstablisherFrame</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892270</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; cmp l_pEstablisherFrame, l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10> ... fffff800`</span><span class=rvts20>00892273</span><span class=rvts10> </span><span class=rvts22>jb</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x444</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922b4</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x405</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892275</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rax </span><span class=rvts25>; cmp l_pEstablisherFrame, l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .</span><span class=rvts21>&lt;</span><span class=rvts10> ... fffff800`</span><span class=rvts20>00892278</span><span class=rvts10> </span><span class=rvts22>jae</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x444</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922b4</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x40a</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>0089227a</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>50h</span><span class=rvts21>],</span><span class=rvts10>rdx </span><span class=rvts25>; l_LowLimit = l_KernelStackCtrl-&gt;Previous.StackLimit</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>0089227f</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>40h</span><span class=rvts21>],</span><span class=rvts10>rax </span><span class=rvts25>; l_HighLimit = l_KernelStackCtrl-&gt;Previous.StackBase</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x414</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. </span><span class=rvts21>&gt;</span><span class=rvts10>.. fffff800`</span><span class=rvts20>00892284</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rbp </span><span class=rvts25>; cmp l_pEstablisherFrame, pEstablisherFrame</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. </span><span class=rvts21>&lt;</span><span class=rvts10>.. fffff800`</span><span class=rvts20>00892287</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x449</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922b9</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x419</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ... fffff800`</span><span class=rvts20>00892289</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>6A8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rax = pHistoryTable</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ..</span><span class=rvts21>^</span><span class=rvts10> fffff800`</span><span class=rvts20>00892291</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0xf0</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00891f60</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ..&nbsp; </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; .. ..&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x426</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10>. ..&nbsp; fffff800`</span><span class=rvts20>00892296</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>0C0000026h</span><span class=rvts10> </span><span class=rvts25>; ecx = STATUS_INVALID_DISPOSITION</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; fffff800`</span><span class=rvts20>0089229b</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlRaiseStatus </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00889df0</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; fffff800`</span><span class=rvts20>008922a0</span><span class=rvts10> </span><span class=rvts22>int</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts20>3</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x431</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; fffff800`</span><span class=rvts20>008922a1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>0C0000028h</span><span class=rvts10> </span><span class=rvts25>; ecx = STATUS_BAD_STACK</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; fffff800`</span><span class=rvts20>008922a6</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlRaiseStatus </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00889df0</span><span class=rvts21>)</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; fffff800`</span><span class=rvts20>008922ab</span><span class=rvts10> </span><span class=rvts22>int</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts20>3</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; </span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . ..&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x43c</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . .</span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp; fffff800`</span><span class=rvts20>008922ac</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>680h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rbx = l_pEstablisherFrame</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp; </span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . .&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x444</span><span class=rvts21>:</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10> .&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922b4</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,</span><span class=rvts10>rbp </span><span class=rvts25>; cmp l_pEstablisherFrame, pEstablisherFrame</span></p>
<p><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922b7</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x479</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922e9</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp; </span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x449</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922b9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rax</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>698h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rax = ReturnValue</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922c1</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>690h</span><span class=rvts21>]</span><span class=rvts10>&nbsp; </span><span class=rvts25>; rbx = pExceptionRecord</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922c9</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>78h</span><span class=rvts21>],</span><span class=rvts10>rax&nbsp;&nbsp; </span><span class=rvts25>; pOriginalContext-&gt;Rax, ReturnValue</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922cd</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>dword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rbx</span><span class=rvts21>],</span><span class=rvts20>80000029h</span><span class=rvts10> </span><span class=rvts25>; cmp pExceptionRecord-&gt;ExceptionCode, STATUS_UNWIND_CONSOLIDATE</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922d3</span><span class=rvts10> </span><span class=rvts22>je</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x46c</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922dc</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x465</span><span class=rvts21>:</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922d5</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>0F8h</span><span class=rvts21>],</span><span class=rvts10>r15 </span><span class=rvts25>; pOriginalContext-&gt;Rip, pJumpTargetIp</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x46c</span><span class=rvts21>:</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922dc</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rbx </span><span class=rvts25>; rdx = pExceptionRecord</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922df</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,</span><span class=rvts10>rdi </span><span class=rvts25>; rcx = pOriginalContext</span></p>
<p><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922e2</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlRestoreContext </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008bd290</span><span class=rvts21>)</span></p>
<p><span class=rvts10>.</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922e7</span><span class=rvts10> </span><span class=rvts22>jmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x4a0</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00892310</span><span class=rvts21>)</span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10>..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x479</span><span class=rvts21>:</span></p>
<p><span class=rvts21>&gt;</span><span class=rvts10>.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922e9</span><span class=rvts10> </span><span class=rvts22>cmp</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rdi</span><span class=rvts21>+</span><span class=rvts20>0F8h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; pOriginalContext-&gt;Rip</span></p>
<p><span class=rvts10> .</span><span class=rvts21>&lt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922f0</span><span class=rvts10> </span><span class=rvts22>jne</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x48d</span><span class=rvts10> </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008922fd</span><span class=rvts21>)</span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x482</span><span class=rvts21>:</span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922f2</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts31>ecx</span><span class=rvts21>,</span><span class=rvts20>0C00000FFh</span><span class=rvts10> </span><span class=rvts25>; ecx = STATUS_BAD_FUNCTION_TABLE</span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922f7</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!RtlRaiseStatus </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>00889df0</span><span class=rvts21>)</span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922fc</span><span class=rvts10> </span><span class=rvts22>int</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts20>3</span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> ..&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x48d</span><span class=rvts21>:</span></p>
<p><span class=rvts10> .</span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>008922fd</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rcx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>690h</span><span class=rvts21>]</span><span class=rvts10> </span><span class=rvts25>; rcx = pExceptionRecord</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892305</span><span class=rvts10> </span><span class=rvts22>xor</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r8d</span><span class=rvts21>,</span><span class=rvts10>r8d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; r8d = 0</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892308</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdx</span><span class=rvts21>,</span><span class=rvts10>rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; rdx = pOriginalContext</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>0089230b</span><span class=rvts10> </span><span class=rvts22>call</span><span class=rvts10>&nbsp;&nbsp;&nbsp; nt!ZwRaiseException </span><span class=rvts21>(</span><span class=rvts10>fffff800`</span><span class=rvts20>008b9b80</span><span class=rvts21>)</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts25>; ZwRaiseException(pExceptionRecord, pOriginalContext, FALSE);</span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts10> .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwindEx</span><span class=rvts21>+</span><span class=rvts20>0x4a0</span><span class=rvts21>:</span></p>
<p><span class=rvts10> </span><span class=rvts21>&gt;</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892310</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r15</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>638h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892318</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r14</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>640h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892320</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r13</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>648h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892328</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; r12</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>650h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892330</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rdi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>658h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892338</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsi</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>660h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892340</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbp</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>668h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892348</span><span class=rvts10> </span><span class=rvts22>mov</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rbx</span><span class=rvts21>,qword</span><span class=rvts10> </span><span class=rvts29>ptr</span><span class=rvts10> </span><span class=rvts21>[</span><span class=rvts10>rsp</span><span class=rvts21>+</span><span class=rvts20>670h</span><span class=rvts21>]</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892350</span><span class=rvts10> </span><span class=rvts22>add</span><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp; rsp</span><span class=rvts21>,</span><span class=rvts20>678h</span></p>
<p><span class=rvts10>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fffff800`</span><span class=rvts20>00892357</span><span class=rvts10> ret</span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18><br></span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts23>参考资料</span></p>
<p><span class=rvts34><br></span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>[1] wrk </span><span class=rvts11>源码</span></p>
<p><span class=rvts10> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>[2] Improving Automated Analysis of Windows x64 Binaries, skape</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>[3] Programming against the x64 exception handling support, Skywing</span></p>
<p><span class=rvts18> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>[4] Exceptional Behavior - x64 Structured Exception Handling, The NT Insider</span></p>
<p><br></p>
<p><br></p>
</body></html>
