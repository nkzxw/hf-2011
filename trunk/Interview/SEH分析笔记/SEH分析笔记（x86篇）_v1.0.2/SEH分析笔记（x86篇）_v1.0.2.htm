<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>SEH x86</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
body {
  margin: 5px 5px 5px 5px;
  background-color: #ffffff;
}
/* ========== Text Styles ========== */
hr { color: #000000}
body, table, span.rvts0 /* Normal text */
{
 font-size: 10pt;
 font-family: 'Arial', 'Helvetica', sans-serif;
 font-style: normal;
 font-weight: normal;
 color: #000000;
 text-decoration: none;
}
span.rvts1 /* Heading */
{
 font-size: 12pt;
 font-weight: bold;
 color: #000000;
}
span.rvts2 /* Subheading */
{
 font-weight: bold;
 color: #000080;
}
span.rvts3 /* Keywords */
{
 font-style: italic;
 color: #800000;
}
a.rvts4, span.rvts4 /* Jump 1 */
{
 color: #0000ff;
 text-decoration: underline;
}
a.rvts5, span.rvts5 /* Jump 2 */
{
 color: #008000;
 text-decoration: underline;
}
span.rvts6 /* Font Style */
{
 font-size: 8pt;
}
span.rvts7
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
}
span.rvts8
{
 font-family: 'Consolas';
 font-weight: bold;
 color: #000000;
}
span.rvts9
{
 font-family: 'Consolas';
 color: #000000;
}
span.rvts10
{
 font-family: 'Consolas';
 color: #000000;
}
a.rvts11, span.rvts11
{
 font-family: 'Consolas';
 color: #0000ff;
 text-decoration: underline;
}
span.rvts12
{
 font-family: 'Consolas';
}
span.rvts13
{
 font-family: 'Consolas';
}
span.rvts14
{
 font-family: 'Courier New', 'Courier', monospace;
}
span.rvts15
{
 font-family: 'Consolas';
 color: #000000;
 background-color: #ffffff;
}
span.rvts16
{
 font-family: 'Consolas';
 color: #804000;
 background-color: #ffffff;
}
span.rvts17
{
 font-family: 'Consolas';
 color: #0000ff;
 background-color: #ffffff;
}
span.rvts18
{
 font-family: 'Consolas';
 color: #8000ff;
 background-color: #ffffff;
}
span.rvts19
{
 font-family: 'Consolas';
 color: #000080;
 background-color: #ffffff;
}
span.rvts20
{
 font-family: 'Consolas';
 color: #000000;
 background-color: #ffffff;
}
span.rvts21
{
 font-family: 'Consolas';
 color: #008000;
 background-color: #ffffff;
}
span.rvts22
{
 font-family: 'Consolas';
 color: #008000;
 background-color: #ffffff;
}
span.rvts23
{
 font-family: 'Consolas';
 color: #0080ff;
 background-color: #ffffff;
}
span.rvts24
{
 font-family: 'Consolas';
 color: #ff8000;
 background-color: #ffffff;
}
span.rvts25
{
 font-family: 'Consolas';
 color: #000000;
}
span.rvts26
{
 font-family: 'Consolas';
 color: #000000;
}
span.rvts27
{
 font-family: 'Consolas';
 color: #8080ff;
 background-color: #ffffcc;
}
span.rvts28
{
 font-family: 'Courier New', 'Courier', monospace;
}
span.rvts29
{
 font-family: 'Consolas';
 color: #808080;
 background-color: #ffffff;
}
span.rvts30
{
 font-size: 3pt;
 font-family: 'Consolas';
}
/* ========== Para Styles ========== */
p,ul,ol /* Paragraph Style */
{
 text-align: left;
 text-indent: 0px;
 padding: 0px 0px 0px 0px;
 margin: 0px 0px 0px 0px;
}
.rvps1 /* Centered */
{
 text-align: center;
}
.rvps2
{
 border-color: #000000;
 border-style: solid;
 border-width: 1px;
 border-top: none;
 border-right: none;
 border-left: none;
}
--></style>
</head>
<body>
<p><br></p>
<p><span class=rvts7> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts7>SEH</span><span class=rvts8>分析笔记（</span><span class=rvts7>X86</span><span class=rvts8>篇）</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.2</span></p>
<p><span class=rvts7> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>boxcounter</span></p>
<p><span class=rvts9><br></span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>[</span><span class=rvts10>不介意转载，但请注明出处</span><span class=rvts9> </span><a class=rvts11 href="http://www.boxcounter.com/">www.boxcounter.com</a><span class=rvts9> </span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>附件里有本文的原始稿，一样的内容，更好的高亮和排版。分别是</span><span class=rvts9> html </span><span class=rvts10>和</span><span class=rvts9> rtl </span><span class=rvts10>格式。</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>本文的部分代码可能会因为论坛的自动换行变得很乱，需要的朋友手动复制到自己的代码编辑器就可以正常显示了</span><span class=rvts9>]</span></p>
<p><span class=rvts9><br></span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>这两天琢磨了下</span><span class=rvts9>SEH</span><span class=rvts10>，这里记录一下自己琢磨的一些心得。</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>SEH </span><span class=rvts10>这个概念我就不啰嗦了，任何一个介绍</span><span class=rvts9> SEH </span><span class=rvts10>的资料都有讲。我主要记录一些自己的理解。可能有一些概念理解的不够清晰，有一些说法比较狭隘，欢迎看到本文的朋友一起讨论、修正，非常感谢。</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts10>首先，</span><span class=rvts9>SEH </span><span class=rvts10>是针对于异常的一种处理机制，这个异常分为硬件异常和软件异常，这里所说的硬件异常是狭义的异常，也就是</span><span class=rvts9> CPU </span><span class=rvts10>产生的异常。比如除零操作，</span><span class=rvts9>CPU </span><span class=rvts10>执行除零操作时候，会自主启动异常处理机制。软件异常，就是程序模拟的异常，比如调用</span><span class=rvts9> </span><span class=rvts12>RaiseException </span><span class=rvts13>函数。软件异常是可以随意触发的，</span><span class=rvts12>windows </span><span class=rvts13>系统内部遇到问题会触发，开发人员高兴了也可以触发。</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>抛出了问题，就要有解决方案。那这么多问题和解决方案，如何管理呢？</span><span class=rvts12>windows </span><span class=rvts13>系统当仁不让的提供了它管理方案</span><span class=rvts12> </span><span class=rvts13>——</span><span class=rvts12> SEH</span><span class=rvts13>。我看一些资料有详细的讨论</span><span class=rvts12> SEH </span><span class=rvts13>的确切含义，这里我不参与讨论，而只是简单的理解为“系统提供的异常处理机制，以及编译器对其进行增强的部分”。</span></p>
<p><span class=rvts12><br></span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>来说说系统提供的异常处理机制。</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts12>windows </span><span class=rvts13>提供的异常处理机制实际上只是一个简单的框架，一般情况下开发人员都不会直接用到。咱通常所用的异常处理（比如</span><span class=rvts12> C++ </span><span class=rvts13>的</span><span class=rvts12> throw</span><span class=rvts13>、</span><span class=rvts12>try</span><span class=rvts13>、</span><span class=rvts12>catch</span><span class=rvts13>）都是编译器在系统提供的异常处理机制上进行加工了的增强版本。这里先抛开增强版的不提，继续说原始版本。</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>原始版本的机制很简单：谁都可以触发异常，谁都可以处理异常（只要它能看得见）。但是不管是触发还是处理都得先登记。系统把这些登记信息保存在一个链表里，并且这个链表保存在线程的数据结构里。也就是说，异常所涉及的一些行为都是线程相关的。比如，线程</span><span class=rvts12> T1 </span><span class=rvts13>触发的异常就只能由线程</span><span class=rvts12> T1 </span><span class=rvts13>来处理，其他线程根本就不知道</span><span class=rvts12> T1 </span><span class=rvts13>发生了什么事，更不会狗拿耗子。</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>等登记完毕后，线程就可以抛出或处理异常了，系统也可以做相应的管理工作了。（这里啰嗦一句，系统提供的</span><span class=rvts12> SEH </span><span class=rvts13>其实是一个针对于“触发异常</span><span class=rvts12>-</span><span class=rvts13>解决异常”的管理机制，系统自身是不提供任何具体异常的解决方案的。解决方案还是要由用户自身来提供（增强版里编译器也会来提供解决方案，来帮“不负责”的程序猿擦屁股，这是后话））</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>系统提供的管理工作简单来说包括（但不限于）：找到触发异常的线程的异常处理链表（前头登记的那个），然后按照规则（具体的规则后续再说）对该异常进行分发，根据分发后的处理结果再进行下一步的分发或者结束处理。</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts13>系统管理所使用的数据结构和宏：</span></p>
<p><span class=rvts14><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_CHAIN_END ((struct _EXCEPTION_REGISTRATION_RECORD * POINTER_32)-1)</span></p>
<p><span class=rvts16><br></span></p>
<p><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>enum</span><span class=rvts15> _EXCEPTION_DISPOSITION </span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueExecution</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueSearch</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionNestedException</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionCollidedUnwind</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>}</span><span class=rvts15> EXCEPTION_DISPOSITION</span><span class=rvts19>;</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_RECORD </span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; DWORD ExceptionCode</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; DWORD ExceptionFlags</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_RECORD </span><span class=rvts19>*</span><span class=rvts15>ExceptionRecord</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PVOID ExceptionAddress</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; DWORD NumberParameters</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ULONG_PTR ExceptionInformation</span><span class=rvts19>[</span><span class=rvts15>EXCEPTION_MAXIMUM_PARAMETERS</span><span class=rvts19>];</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>}</span><span class=rvts15> EXCEPTION_RECORD</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> EXCEPTION_RECORD </span><span class=rvts19>*</span><span class=rvts15>PEXCEPTION_RECORD</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>EXCEPTION_DISPOSITION</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>(*</span><span class=rvts15>PEXCEPTION_ROUTINE</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts19>(</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_RECORD </span><span class=rvts19>*</span><span class=rvts15>ExceptionRecord</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PVOID EstablisherFrame</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN OUT </span><span class=rvts18>struct</span><span class=rvts15> _CONTEXT </span><span class=rvts19>*</span><span class=rvts15>ContextRecord</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN OUT PVOID DispatcherContext</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>);</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION_RECORD </span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION_RECORD </span><span class=rvts19>*</span><span class=rvts15>Next</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_ROUTINE Handler</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>}</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD </span><span class=rvts19>*</span><span class=rvts15>PEXCEPTION_REGISTRATION_RECORD</span><span class=rvts19>;</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts19> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其中</span><span class=rvts19> </span><span class=rvts15>EXCEPTION_REGISTRATION_RECORD </span><span class=rvts20>结构就是登记信息。来介绍下它的成员：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. EXCEPTION_REGISTRATION_RECORD::Next </span><span class=rvts20>域指向下一个</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>，由此构成一个异常登记信息（从字面上说，应该叫做“异常注册记录”更恰当）链表。链表中的最后一个结点会将</span><span class=rvts15> Next </span><span class=rvts20>置为</span><span class=rvts15> EXCEPTION_CHAIN_END</span><span class=rvts20>，表示链表到此结束。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. EXCEPTION_REGISTRATION_RECORD::Handler </span><span class=rvts20>指向异常处理函数。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>前面有简单的说过原始版本</span><span class=rvts15> SEH </span><span class=rvts20>的管理工作，这里再根据以上列出的相关数据结构稍微详细一点说说。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>当接收到异常后，系统找到当前线程（还记不记得，前面有说过，异常是线程相关的。系统接收到的异常就是当前正在运行的线程触发的。其实这个说法还不准确，</span><span class=rvts15>DPC </span><span class=rvts20>也会触发异常，而它是线程无关的，这里为了方便理解，先只考虑线程）的异常链表，从链表中的第一个结点开始遍历，找到一个</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD </span><span class=rvts20>就调用它的</span><span class=rvts15> Handler</span><span class=rvts20>，并把该异常（由第一个类型为</span><span class=rvts15> EXCEPTION_RECORD </span><span class=rvts20>的参数表示）传递给该</span><span class=rvts15> Handler</span><span class=rvts20>，</span><span class=rvts15>Handler </span><span class=rvts20>处理并返回一个类型为</span><span class=rvts15> EXCEPTION_DISPOSITION </span><span class=rvts20>的枚举值。该返回值指示系统下一步该做什么：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionContinueExecution </span><span class=rvts20>表示：“我已修正了此异常的故障，请你从事发点重新执行，谢谢”。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionContinueSearch </span><span class=rvts20>表示：“我没有处理此异常，请你继续搜索其他的解决方案，抱歉”。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionNestedException </span><span class=rvts20>和</span><span class=rvts15> ExceptionCollidedUnwind </span><span class=rvts20>这里先不做解释，后面会细说。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这样系统根据不同的返回值来继续遍历异常链表或者回到触发点继续执行。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>需要说明一下，本文主要以内核模式下的异常来说，因为相比用户模式下的异常处理流程，内核模式少了模式切换、栈切换以及反向回调等步骤。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>我们现在来看看详细的内核异常流程。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>首先，</span><span class=rvts15>CPU </span><span class=rvts20>执行的指令触发了异常，</span><span class=rvts15>CPU </span><span class=rvts20>改执行</span><span class=rvts15> IDT </span><span class=rvts20>中</span><span class=rvts15> KiTrap??</span><span class=rvts20>，</span><span class=rvts15>KiTrap?? </span><span class=rvts20>会调用</span><span class=rvts15> KiDispatchException</span><span class=rvts20>。该函数原型如下：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>VOID</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>KiDispatchException (</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PKEXCEPTION_FRAME ExceptionFrame,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PKTRAP_FRAME TrapFrame,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN KPROCESSOR_MODE PreviousMode,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN BOOLEAN FirstChance</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其名称明白的说明了函数的主要功能：分派异常。其实现可以参考</span><span class=rvts15> $wrk-v1.2\base\ntos\ke\i386\exceptn.c:1033</span><span class=rvts20>。我的笔记：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在当前栈中分配一个</span><span class=rvts15> CONTEXT</span><span class=rvts20>，调用</span><span class=rvts15> KeContextFromKframes </span><span class=rvts20>初始化它。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>检查</span><span class=rvts15> ExceptionRecord-&gt;ExceptionCode</span><span class=rvts20>，如果：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>是</span><span class=rvts15> STATUS_BREAKPOINT</span><span class=rvts20>，那么将</span><span class=rvts15> CONTEXT::Eip </span><span class=rvts20>减一；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>是</span><span class=rvts15> KI_EXCEPTION_ACCESS_VIOLATION</span><span class=rvts20>，那么将检查是否是由</span><span class=rvts15> AtlThunk </span><span class=rvts20>触发（这个小环节没有深究），如果是触发</span><span class=rvts15> NX</span><span class=rvts20>（不可执行），那么将</span><span class=rvts15> ExceptionRecord-&gt;ExceptionInformation [0] </span><span class=rvts20>置为</span><span class=rvts15> 0</span><span class=rvts20>（貌似表示触发操作的类型，</span><span class=rvts15>0</span><span class=rvts20>表示读、</span><span class=rvts15>1</span><span class=rvts20>表示写）；</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts20>如果</span><span class=rvts15> PreviousMode </span><span class=rvts20>是</span><span class=rvts15> KernelMode</span><span class=rvts20>，那么，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果</span><span class=rvts15> FirstChance </span><span class=rvts20>为</span><span class=rvts15> TRUE</span><span class=rvts20>，那么将该异常传达给内核调试器，如果内核调试器没有处理，那么调用</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>进行处理。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果</span><span class=rvts15> FirstChance </span><span class=rvts20>为</span><span class=rvts15> FALSE</span><span class=rvts20>，那么再次将该异常传达给内核调试器，如果内核调试器没有处理，那么</span><span class=rvts15> BUGCHECK</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果</span><span class=rvts15> PreviousMode </span><span class=rvts20>是</span><span class=rvts15> UserMode</span><span class=rvts20>，那么，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果</span><span class=rvts15> FirstChance </span><span class=rvts20>为</span><span class=rvts15> TRUE</span><span class=rvts20>，那么将该异常传达给内核调试器，如果内核调试器没有处理，那么将异常传达给应用层调试器。如果仍然没有处理，那么将</span><span class=rvts15> KTRAP_FRAME </span><span class=rvts20>和</span><span class=rvts15> EXCEPTION_RECORD </span><span class=rvts20>拷贝到</span><span class=rvts15> UserMode </span><span class=rvts20>的栈中，并设置</span><span class=rvts15> KTRAP_FRAME::Eip </span><span class=rvts20>设置为</span><span class=rvts15> ntdll!KiUserExceptionDispatcher</span><span class=rvts20>，返回（将该异常交由应用层异常处理程序进行处理）。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果</span><span class=rvts15> FirstChance </span><span class=rvts20>为</span><span class=rvts15> FALSE</span><span class=rvts20>，那么再次将异常传达给应用层调试器，如果仍然没有处理，那么调用</span><span class=rvts15> ZwTerminateProcess </span><span class=rvts20>结束进程，并</span><span class=rvts15> BUGCHECK</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>抛开应用层异常不说，我们来看</span><span class=rvts15> PreviousMode </span><span class=rvts20>是</span><span class=rvts15> KernelMode </span><span class=rvts20>的情况，其重点是调用</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>的操作。我们来看一下这个函数：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>BOOLEAN</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlDispatchException (</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PCONTEXT ContextRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>);</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>它的实现可以参考</span><span class=rvts15> $wrk-v1.2\base\ntos\rtl\i386\exdsptch.c:126</span><span class=rvts20>。我的笔记：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>遍历当前线程的异常链表，挨个调用</span><span class=rvts15> RtlpExecuteHandlerForException</span><span class=rvts20>，</span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>会调用异常处理函数。再根据返回值做出不同的处理：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>对于</span><span class=rvts15> ExceptionContinueExecution</span><span class=rvts20>，结束遍历，返回。（对于标记为‘</span><span class=rvts15>EXCEPTION_NONCONTINUABLE</span><span class=rvts20>’的异常，会调用</span><span class=rvts15> RtlRaiseException</span><span class=rvts20>。）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>对于</span><span class=rvts15> ExceptionContinueSearch</span><span class=rvts20>，继续遍历下一个结点。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>对于</span><span class=rvts15> ExceptionNestedException</span><span class=rvts20>，则从指定的新异常继续遍历。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>只有正确处理</span><span class=rvts15> ExceptionContinueExecution </span><span class=rvts20>才会返回</span><span class=rvts15> TRUE</span><span class=rvts20>，其他情况都返回</span><span class=rvts15> FALSE</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在继续讲述异常处理机制之前，咱们需要先来认识一下异常链表。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>之前有提到过：系统将异常链表头保存在线程结构里。来看看具体的数据结构：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>线程的内核数据结构体现是</span><span class=rvts15> _ETHREAD</span><span class=rvts20>，从它开始进入，直到咱们关注的异常链表。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd&gt; dt _ETHREAD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ntdll!_ETHREAD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 Tcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : _KTHREAD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; ... </span><span class=rvts20>省略之后的成员</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd&gt; dt _KTHREAD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ntdll!_KTHREAD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; ... </span><span class=rvts20>省略的域成员</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x074 Teb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; ... </span><span class=rvts20>省略的域成员</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>Teb </span><span class=rvts20>成员的类型实际是</span><span class=rvts15> _TEB</span><span class=rvts20>，来看看</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd&gt; dt _TEB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ntdll!_TEB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 NtTib&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : _NT_TIB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; ... </span><span class=rvts20>省略的域成员</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd&gt; dt _NT_TIB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ntdll!_NT_TIB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 ExceptionList&nbsp;&nbsp;&nbsp; : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x004 StackBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x008 StackLimit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x00c SubSystemTib&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x010 FiberData&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x010 Version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Uint4B</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x014 ArbitraryUserPointer : Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x018 Self&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32 _NT_TIB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>_NT_TIB </span><span class=rvts20>的第一个域成员</span><span class=rvts15> ExceptionList </span><span class=rvts20>就是异常链表头。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>但是系统不是这么一步一步找的，而是借助</span><span class=rvts15> FS </span><span class=rvts20>寄存器来加速寻找。先来说说系统对</span><span class=rvts15> FS </span><span class=rvts20>的使用。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在应用层，</span><span class=rvts15>FS </span><span class=rvts20>寄存器“指向”当前执行线程的</span><span class=rvts15> _TEB </span><span class=rvts20>结构体。在内核层，</span><span class=rvts15>FS </span><span class=rvts20>寄存器“指向”另一个跟</span><span class=rvts15> CPU </span><span class=rvts20>相关的结构体：</span><span class=rvts15>_KPCR</span><span class=rvts20>，来看看它的结构，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>nt!_KPCR</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 NtTib&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : _NT_TIB</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 Used_ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; ... </span><span class=rvts20>省略的域成员</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>与</span><span class=rvts15> _TEB </span><span class=rvts20>一样，它的第一个域成员也是</span><span class=rvts15> _NT_TIB</span><span class=rvts20>，只不过此时是</span><span class=rvts15> nt!_NT_TIB</span><span class=rvts20>，而在应用层是</span><span class=rvts15> ntdll!_NT_TIB</span><span class=rvts20>，但它们的结构是一样的。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这样，不论在应用层还是在内核层，系统都可以使用</span><span class=rvts15> FS:[0] </span><span class=rvts20>找到异常链表。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到这里，咱们已经聊完了</span><span class=rvts15> CPU </span><span class=rvts20>触发的异常的处理流程，总结一下它的调用流程：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>CPU </span><span class=rvts20>检测到异常</span><span class=rvts15> -&gt; KiTrap?? -&gt; KiDispatchException -&gt; RtlDispatchException -&gt; RtlpExecuteHandlerForException</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这是硬件异常，咱们再来看看软件异常。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>软件异常跟硬件异常的处理流程非常接近，只有触发点的不同，调用流程是：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlRaiseException -&gt; RtlDispatchException -&gt; RtlpExecuteHandlerForException</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>后面两个被调用的函数咱已经聊过了，主要来看看</span><span class=rvts15> RtlRaiseException</span><span class=rvts20>。这个函数从其名字上就能看出是用来触发异常的。原型如下：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>VOID</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlRaiseException (</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; IN PEXCEPTION_RECORD ExceptionRecord</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>);</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其实现可以参考</span><span class=rvts15> $</span><span class=rvts12>wrk-v1.2\base\ntos\rtl\i386\raise.asm:71</span><span class=rvts13>。我的笔记：</span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlRaiseException </span><span class=rvts20>首先调用</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>分发异常，如果</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>成功分发（有处理函数处理了这个异常），那么结束本函数。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>如果没有成功分发，那么调用</span><span class=rvts15> </span><span class=rvts12>ZwRaiseException </span><span class=rvts13>再次触发该异常，这次传入的异常的</span><span class=rvts12> FirstChance </span><span class=rvts13>被置为</span><span class=rvts12> FALSE</span><span class=rvts13>。</span></p>
<p><span class=rvts12><br></span></p>
<p><span class=rvts12> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到这里，系统提供的</span><span class=rvts15> SEH </span><span class=rvts20>机制（本文又称之为原始版本）大致讲解完毕。咱可以回味一下：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts20>原始版本的实现较简单，代码量不大，而且</span><span class=rvts15> wrk </span><span class=rvts20>基本上有所有关键函数的实现代码。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts20>原始版本的功能过于简单，实际过程中很难直接使用。整个异常处理过程无非就是遍历异常链表，挨个调用异常注册信息的处理函数，如果其中有某个处理函数处理了该异常（返回值为</span><span class=rvts15> </span><span class=rvts12>ExceptionContinueExecution</span><span class=rvts13>）</span><span class=rvts20>，那么就从异常触发点（如果是断点异常，则要回退一个字节的指令（</span><span class=rvts15>int 3 </span><span class=rvts20>指令本身））重新执行。否则不管是整个链表中没有找到合适的处理函数（返回值为</span><span class=rvts15> </span><span class=rvts12>ExceptionContinueSearch</span><span class=rvts13>）</span><span class=rvts20>，或者遍历过程中出现问题（返回值为</span><span class=rvts15> </span><span class=rvts12>ExceptionNestedException</span><span class=rvts13>）</span><span class=rvts20>，系统都会简单粗暴的</span><span class=rvts15> BUGCHECK</span><span class=rvts20>。而这也带来一个问题：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts20>线程运行过程中会调用很多个函数，每个函数都有可能注册异常处理，它们提供的异常处理函数既可能处理该函数自身触发的异常，又可能需要处理其子孙函数触发的异常。前者还好说，自己出了问题，多少还有可能自己修复。而后者就很头疼了，它无法了解所有其调用的子孙函数内部的实现，要想修复子孙函数触发的异常，太困难了。而一旦没有正确处理，或者没人处理，系统就崩掉。这个后果太严重。于是实际上现实程序设计中，基本上没有直接使用原始版本的</span><span class=rvts15> SEH</span><span class=rvts20>，而是使用编译器提供的增强版本。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>下面咱们就来聊聊编译器提供的增强版本。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>首先要说明，增强版本有很多个，不同的编译器提供的的</span><span class=rvts15> SEH </span><span class=rvts20>增强版本或多或少都有不同处。但是，他们一般都是基于</span><span class=rvts15> windows </span><span class=rvts20>系统提供的原始版本进行完善的。一个典型的增强版就是微软的编译器（后面简称为</span><span class=rvts15> MSC</span><span class=rvts20>）里提供的</span><span class=rvts15> __try</span><span class=rvts20>、</span><span class=rvts15>__finally</span><span class=rvts20>，</span><span class=rvts15>__except</span><span class=rvts20>。咱们接下来就用这个增强版作为目标进行分析。我使用的</span><span class=rvts15> MSC </span><span class=rvts20>是</span><span class=rvts15> WDK 7600.16385.1</span><span class=rvts20>，内置的</span><span class=rvts15> cl </span><span class=rvts20>的版本是</span><span class=rvts15>15.00.30729.207</span><span class=rvts20>，</span><span class=rvts15>link </span><span class=rvts20>的版本是</span><span class=rvts15>9.00.30729.207</span><span class=rvts20>，测试虚拟机系统为</span><span class=rvts15> 32</span><span class=rvts20>位</span><span class=rvts15> Win2k3sp1 + wrk</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>咱们先看看增强版的数据结构，跟之前的原始版本有很多相似之处：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION PEXCEPTION_REGISTRATION</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION</span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION </span><span class=rvts19>*</span><span class=rvts15>prev</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>void</span><span class=rvts15> </span><span class=rvts19>(*</span><span class=rvts15>handler</span><span class=rvts19>)(</span><span class=rvts15>PEXCEPTION_RECORD</span><span class=rvts19>,</span><span class=rvts15> PEXCEPTION_REGISTRATION</span><span class=rvts19>,</span><span class=rvts15> PCONTEXT</span><span class=rvts19>,</span><span class=rvts15> PEXCEPTION_RECORD</span><span class=rvts19>);</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> scopetable_entry </span><span class=rvts19>*</span><span class=rvts15>scopetable</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> trylevel</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> _ebp</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_POINTERS xpointers</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>};</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这个</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>在增强版中就相当于原始版本中的</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>。可以这么理解它：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION</span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION_RECORD ExceptionRegistrationRecord</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> scopetable_entry </span><span class=rvts19>*</span><span class=rvts15>scopetable</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> trylevel</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> _ebp</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_POINTERS xpointers</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>};</span><span class=rvts15> </span><span class=rvts21>// </span><span class=rvts22>注：本结构体只用于理解原始版和增强版的区别，实际代码中并没有这种形式的定义</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>也就是说它沿用了老版本的注册信息结构，只是在域成员名称上做了些改动，把</span><span class=rvts15> Next </span><span class=rvts20>改名为</span><span class=rvts15> prev</span><span class=rvts20>，把</span><span class=rvts15> Handler </span><span class=rvts20>改为</span><span class=rvts15> handler</span><span class=rvts20>。除此之外，在原始版本基础上增加了</span><span class=rvts15>4</span><span class=rvts20>个域成员（</span><span class=rvts15>scopetable</span><span class=rvts20>、</span><span class=rvts15>trylevel</span><span class=rvts20>、</span><span class=rvts15>_ebp</span><span class=rvts20>、</span><span class=rvts15>xpointers</span><span class=rvts20>），用来支持它的增强功能。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>需要说明的是，这结构体来源于</span><span class=rvts15> MSC </span><span class=rvts20>的</span><span class=rvts15> crt </span><span class=rvts20>源码里的</span><span class=rvts15> exsup.inc</span><span class=rvts20>，这个文件使用的是汇编语法，该结构体定义是从该文件的注释中提取出来。在实际的分析过程中，发现它的定义有一些问题：最后一个域成员</span><span class=rvts15> xpointers </span><span class=rvts20>实际上存放在</span><span class=rvts15> prev </span><span class=rvts20>之前，也就是说，实际中</span><span class=rvts15> __try </span><span class=rvts20>增强版用的结构体是这样的：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION PEXCEPTION_REGISTRATION</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION</span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_POINTERS xpointers</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> _EXCEPTION_REGISTRATION </span><span class=rvts19>*</span><span class=rvts15>prev</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>void</span><span class=rvts15> </span><span class=rvts19>(*</span><span class=rvts15>handler</span><span class=rvts19>)(</span><span class=rvts15>PEXCEPTION_RECORD</span><span class=rvts19>,</span><span class=rvts15> PEXCEPTION_REGISTRATION</span><span class=rvts19>,</span><span class=rvts15> PCONTEXT</span><span class=rvts19>,</span><span class=rvts15> PEXCEPTION_RECORD</span><span class=rvts19>);</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>struct</span><span class=rvts15> scopetable_entry </span><span class=rvts19>*</span><span class=rvts15>scopetable</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> trylevel</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts18>int</span><span class=rvts15> _ebp</span><span class=rvts19>;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>};</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts19> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>相关的宏和结构</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>TRYLEVEL_NONE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts23>equ</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>-</span><span class=rvts24>1</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>TRYLEVEL_INVALID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts23>equ</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>-</span><span class=rvts24>2</span></p>
<p><span class=rvts24><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable_entry</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x000 previousTryLevel : Uint4B</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x004 lpfnFilter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32&nbsp;&nbsp;&nbsp;&nbsp; int </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; +0x008 lpfnHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Ptr32&nbsp;&nbsp;&nbsp;&nbsp; int </span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>咱们先来简单的看一下增强版中出现的几个新域成员。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>EXCEPTION_REGISTRATION::scopetable </span><span class=rvts20>是类型为</span><span class=rvts15> scopetable_entry </span><span class=rvts20>的数组。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>EXCEPTION_REGISTRATION::trylevel </span><span class=rvts20>是数组下标，用来索引</span><span class=rvts15> scopetable </span><span class=rvts20>中的数组成员。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>_ebp </span><span class=rvts20>是包含该</span><span class=rvts15> _EXCEPTION_REGISTRATION </span><span class=rvts20>结构体的函数的栈帧指针。对于没有</span><span class=rvts15> FPO </span><span class=rvts20>优化过的函数，一开头通常有个</span><span class=rvts15> push ebp </span><span class=rvts20>的操作，</span><span class=rvts15>_ebp </span><span class=rvts20>的值就是被压入的</span><span class=rvts15> ebp </span><span class=rvts20>的值，后续咱们通过代码就再看实际的应用。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>按照原始版本的设计，每一对“触发异常</span><span class=rvts15>-</span><span class=rvts20>处理异常”都会有一个注册信息即</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>。也就是说，如果按照原始的设计，每一个</span><span class=rvts15> __try/__except(__finally) </span><span class=rvts20>都应该对应一个</span><span class=rvts15> EXCEPTION_REGISTRATION</span><span class=rvts20>。但是实际的</span><span class=rvts15> MSC </span><span class=rvts20>实现不是这样的。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>真正的实现是：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>每个使用</span><span class=rvts15> __try/__except(__finally) </span><span class=rvts20>的函数，不管其内部嵌套或反复使用多少</span><span class=rvts15> __try/__except(__finally)</span><span class=rvts20>，都只注册一遍，即只将一个</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>挂入当前线程的异常链表中（对于递归函数，每一次调用都会创建一个</span><span class=rvts15> EXCEPTION_REGISTRATION</span><span class=rvts20>，并挂入线程的异常链表中，这是另外一回事）。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>那如何处理函数内部出现的多个</span><span class=rvts15> __try/__except(__finally) </span><span class=rvts20>呢？这多个</span><span class=rvts15> __except </span><span class=rvts20>代码块的功能可能大不相同，而注册信息</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>中只能提供一个处理函数</span><span class=rvts15> handler</span><span class=rvts20>，怎么办？</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>MSC </span><span class=rvts20>的做法是，</span><span class=rvts15>MSC </span><span class=rvts20>提供一个处理函数，即</span><span class=rvts15> EXCEPTION_REGISTRATION::handler </span><span class=rvts20>被设置为</span><span class=rvts15> MSC </span><span class=rvts20>的某个函数，而不是程序猿提供的</span><span class=rvts15> __except </span><span class=rvts20>代码块。程序猿提供的多个</span><span class=rvts15> __except </span><span class=rvts20>块被存储在</span><span class=rvts15> EXCEPTION_REGISTRATION::scopetable </span><span class=rvts20>数组中。我们看看上面的</span><span class=rvts15> scopetable_entry </span><span class=rvts20>定义，由于我没有找到它的定义代码，所以就贴了</span><span class=rvts15> windbg </span><span class=rvts20>中</span><span class=rvts15> dt </span><span class=rvts20>输出结果。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其中</span><span class=rvts15> scopetable_entry::lpfnHandler </span><span class=rvts20>就是程序猿提供的</span><span class=rvts15> __except </span><span class=rvts20>异常处理块代码。而</span><span class=rvts15> lpfnFilter </span><span class=rvts20>就是</span><span class=rvts15> __except </span><span class=rvts20>的过滤块代码。对于</span><span class=rvts15> __finally </span><span class=rvts20>代码块，其</span><span class=rvts15> lpfnFilter </span><span class=rvts20>被置为</span><span class=rvts15> NULL</span><span class=rvts20>，</span><span class=rvts15>lpfnHandler </span><span class=rvts20>就是其包含的代码块。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>下面，我们用一小段简单的伪代码来详细说明。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1&nbsp;&nbsp;&nbsp;&nbsp; VOID SimpleSeh()</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except(ExceptionFilter_0(...))</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExceptCodeBlock_0;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>10&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except(ExceptionFilter_1(...))</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExceptCodeBlock_1;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except(ExceptionFilter_2(...))</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExceptCodeBlock_2;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>25&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>编译时，编译器会为</span><span class=rvts15> SimpleSeh </span><span class=rvts20>分配一个</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>和一个拥有</span><span class=rvts15>3</span><span class=rvts20>个成员的</span><span class=rvts15> scopetable </span><span class=rvts20>数组，并将</span><span class=rvts15> EXCEPTION_REGISTRATION::scopetable </span><span class=rvts20>指向该数组（请留意：</span><span class=rvts15>EXCEPTION_REGISTRATION::scopetable </span><span class=rvts20>只是一个指针，不是数组）。然后按照</span><span class=rvts15> __try </span><span class=rvts20>关键字出现的顺序，将对应的</span><span class=rvts15>__except/__finally </span><span class=rvts20>都存入该数组，步骤如下：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[0].lpfnFilter = ExceptionFilter_0;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[0].lpfnHandler = ExceptCodeBlock_0;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[1].lpfnFilter = ExceptionFilter_1;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[1].lpfnHandler = ExceptCodeBlock_1;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[2].lpfnFilter = ExceptionFilter_2;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[2].lpfnHandler = ExceptCodeBlock_2;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>我们假象当前开始执行</span><span class=rvts15> SimpleSeh </span><span class=rvts20>函数，在行</span><span class=rvts15>14</span><span class=rvts20>和行</span><span class=rvts15>15</span><span class=rvts20>之间触发了异常。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>根据之前我们的讨论的流程：</span><span class=rvts15>RtlRaiseException -&gt; RtlDispatchException -&gt; RtlpExecuteHandlerForException</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>会调用注册信息中的处理函数，即</span><span class=rvts15> EXCEPTION_REGISTRATION::handler</span><span class=rvts20>。该函数是由</span><span class=rvts15> MSC </span><span class=rvts20>提供的，内部会依次调用</span><span class=rvts15> scopetable </span><span class=rvts20>中的</span><span class=rvts15> lpfnHandler</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>那咱们来模拟执行一下，在</span><span class=rvts15>14</span><span class=rvts20>和</span><span class=rvts15>15</span><span class=rvts20>行之前触发异常，那应该先从</span><span class=rvts15> scopetable[2] </span><span class=rvts20>的</span><span class=rvts15> ExceptionFilter_2 </span><span class=rvts20>开始执行，假设该函数返回</span><span class=rvts15> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts20>。那接下来应该是</span><span class=rvts15> scopetable[1]</span><span class=rvts20>，假设</span><span class=rvts15> ExceptionFilter_1 </span><span class=rvts20>也返回</span><span class=rvts15> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts20>。那么接下来是不是就应该轮到</span><span class=rvts15> scopetable[0] </span><span class=rvts20>了？不是。咱们再看看上面的伪代码，行</span><span class=rvts15>14</span><span class=rvts20>和行</span><span class=rvts15>15</span><span class=rvts20>之间的代码并没处于第一个</span><span class=rvts15> __try/__except </span><span class=rvts20>的范围中，该异常轮不到</span><span class=rvts15> scopetable[0] </span><span class=rvts20>来处理。那怎么办？</span><span class=rvts15>SimpleSeh </span><span class=rvts20>执行的过程中怎么知道到</span><span class=rvts15> scopetable[1] </span><span class=rvts20>就应该停止？</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>MSC </span><span class=rvts20>是通过</span><span class=rvts15> scopetable_entry::previousTryLevel </span><span class=rvts20>来解决这个问题的。上面数组的设置，完整的形式其实是这样：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[0].previousTryLevel = TRYLEVEL_NONE;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[0].lpfnFilter = ExceptionFilter_0;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[0].lpfnHandler = ExceptCodeBlock_0;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[1].previousTryLevel = TRYLEVEL_NONE;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[1].lpfnFilter = ExceptionFilter_1;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[1].lpfnHandler = ExceptCodeBlock_1;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[2].previousTryLevel = 1;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[2].lpfnFilter = ExceptionFilter_2;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable[2].lpfnHandler = ExceptCodeBlock_2;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>scopetable_entry::previousTryLevel </span><span class=rvts20>包含的意思是“下一个该轮到数组下标为</span><span class=rvts15> previousTryLevel </span><span class=rvts20>的单元了”。当</span><span class=rvts15> scopetable_entry::previousTryLevel </span><span class=rvts20>等于</span><span class=rvts15> TRYLEVEL_NONE(-1) </span><span class=rvts20>时，就会停止遍历</span><span class=rvts15> scopetable</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>咱再来模拟执行一遍，当</span><span class=rvts15>14</span><span class=rvts20>和</span><span class=rvts15>15</span><span class=rvts20>行之间触发异常时，首先遍历到</span><span class=rvts15> scopetable[2]</span><span class=rvts20>，处理完后，找到</span><span class=rvts15> scopetable[2].previousTryLevel</span><span class=rvts20>，发现其值为</span><span class=rvts15>1</span><span class=rvts20>，那么遍历到</span><span class=rvts15> scopetable[1]</span><span class=rvts20>，处理完后，找到</span><span class=rvts15> scopetable[1].previousTryLevel</span><span class=rvts20>，发现其值为</span><span class=rvts15> TRYLEVEL_NONE</span><span class=rvts20>，于是停止遍历。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>好像挺圆满的，是吧。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>咱们再假设下，如果行</span><span class=rvts15>4</span><span class=rvts20>和行</span><span class=rvts15>5</span><span class=rvts20>之间触发了同样的异常，执行流程应该如何。首先，执行</span><span class=rvts15> scopetable[2]</span><span class=rvts20>，然后在</span><span class=rvts15> scopetable[1]</span><span class=rvts20>，然后……（省略若干同上字）。停！这次的异常是在第一个</span><span class=rvts15> __try/__except </span><span class=rvts20>中触发的，轮不到</span><span class=rvts15> scopetable[2] </span><span class=rvts20>来处理，怎么办？</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这个时候就轮到</span><span class=rvts15> EXCEPTION_REGISTRATION::trylevel </span><span class=rvts20>出场了</span><span class=rvts15>~</span><span class=rvts20>。</span><span class=rvts15>EXCEPTION_REGISTRATION::trylevel </span><span class=rvts20>的作用就是标识从那个数组单元开始遍历。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>与</span><span class=rvts15> scopetable_entry::previousTryLevel </span><span class=rvts20>不同，</span><span class=rvts15>EXCEPTION_REGISTRATION::trylevel </span><span class=rvts20>是动态变化的，也就是说，这个值在</span><span class=rvts15> SimpleSeh </span><span class=rvts20>执行过程中是会经常改变的。比如，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>执行到行</span><span class=rvts15>4</span><span class=rvts20>和行</span><span class=rvts15>5</span><span class=rvts20>之间，该值就会被修改为</span><span class=rvts15>0</span><span class=rvts20>；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>执行到第</span><span class=rvts15>12</span><span class=rvts20>行，该值被修改为</span><span class=rvts15>1</span><span class=rvts20>；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>执行到</span><span class=rvts15>14</span><span class=rvts20>行，该值为</span><span class=rvts15>2</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这样，当异常触发时候，</span><span class=rvts15>MSC </span><span class=rvts20>就能正确的遍历</span><span class=rvts15> scopetable </span><span class=rvts20>了。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这里我画了一幅草图来帮助理解</span><span class=rvts15>:</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>图中下方是低地址端，上方是高地址端。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>（</span><span class=rvts15>boxcounter: </span><span class=rvts20>这幅图是我借助</span><span class=rvts15> vim </span><span class=rvts20>的列操作手绘的，哪位朋友知道有专门画这类文本图的工具吗（除了</span><span class=rvts15> emacs </span><span class=rvts20>的图操作模式，这玩意太臃肿了，我不太喜欢）？欢迎告知我</span><span class=rvts15> ns.boxcounter[a]gmail.com</span><span class=rvts20>。非常感谢。）</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4G&nbsp;&nbsp; |--------------------------|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt; |--------------------------|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp; | ret_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; func1&nbsp; | _EXCEPTION_REGISTRATION&nbsp; |&nbsp;&nbsp;&nbsp; _EXCEPTION_REGISTRATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp; previousTryLevel = TRYLEVEL_NONE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp; | ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; scopetable[0] |&nbsp; lpfnFilter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionFilter_0&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt; |--------------------------|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp; lpfnHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionCodeBlock_0 /</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp; | ret_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp; previousTryLevel = TRYLEVEL_NONE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp; &lt;-</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; func2&nbsp; | _EXCEPTION_REGISTRATION&nbsp; |&nbsp;&nbsp;&nbsp; _EXCEPTION_REGISTRATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scopetable[1] |&nbsp; lpfnFilter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionFilter_1&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp; | ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp; lpfnHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionCodeBlock_1 /&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt; |--------------------------|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp; previousTryLevel = 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp; -^</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp; | ret_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; scopetable[2] |&nbsp; lpfnFilter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionFilter_2&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; func3&nbsp; | _EXCEPTION_REGISTRATION&nbsp; |&nbsp;&nbsp;&nbsp; _EXCEPTION_REGISTRATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp; lpfnHandler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ExceptionCodeBlock_2 /</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp; | ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt; |--------------------------|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp; | ret_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; func4&nbsp; | _EXCEPTION_REGISTRATION&nbsp; |&nbsp;&nbsp;&nbsp; _EXCEPTION_REGISTRATION</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \&nbsp;&nbsp;&nbsp; | ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ^</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FS:[0]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 -&gt; |--------------------------|</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这幅图中的函数关系是：</span><span class=rvts15> func1 -&gt; func2 -&gt; func3 -&gt; func4</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到目前位置，咱们已经熟悉了增强版的概要流程。下面结合真实代码来分析。代码分为三块：</span><span class=rvts15>SEH </span><span class=rvts20>创建代码、</span><span class=rvts15>MSC </span><span class=rvts20>提供的</span><span class=rvts15> handler </span><span class=rvts20>函数，以及展开函数。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在开始看分析代码之前，先把后面分析过程中需要用的宏和结构体列出来：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_NONCONTINUABLE 0x1&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Noncontinuable exception</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_UNWINDING 0x2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Unwind is in progress</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_EXIT_UNWIND 0x4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Exit unwind is in progress</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_STACK_INVALID 0x8&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Stack out of limits or unaligned</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_NESTED_CALL 0x10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Nested exception handler call</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_TARGET_UNWIND 0x20&nbsp;&nbsp;&nbsp; </span><span class=rvts21>// Target unwind in progress</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_COLLIDED_UNWIND 0x40&nbsp; </span><span class=rvts21>// Collided exception handler call</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_UNWIND (EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND | \</span></p>
<p><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>&nbsp; EXCEPTION_TARGET_UNWIND | EXCEPTION_COLLIDED_UNWIND)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>nt</span><span class=rvts19>!</span><span class=rvts15>_EXCEPTION_RECORD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x000</span><span class=rvts15> ExceptionCode&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> Int4B</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x004</span><span class=rvts15> ExceptionFlags&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> Uint4B</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x008</span><span class=rvts15> ExceptionRecord&nbsp; </span><span class=rvts19>:</span><span class=rvts15> Ptr32 _EXCEPTION_RECORD</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x00c</span><span class=rvts15> ExceptionAddress </span><span class=rvts19>:</span><span class=rvts15> Ptr32 Void</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x010</span><span class=rvts15> NumberParameters </span><span class=rvts19>:</span><span class=rvts15> Uint4B</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>+</span><span class=rvts24>0x014</span><span class=rvts15> ExceptionInformation </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts24>15</span><span class=rvts19>]</span><span class=rvts15> Uint4B</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>enum</span><span class=rvts15> _EXCEPTION_DISPOSITION </span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueExecution</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueSearch</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionNestedException</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionCollidedUnwind</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>}</span><span class=rvts15> EXCEPTION_DISPOSITION</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts21>// scopetable_entry::lpfnFilter </span><span class=rvts22>的返回值，也就是</span><span class=rvts21> __except </span><span class=rvts22>过滤块的返回值</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_EXECUTE_HANDLER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_CONTINUE_SEARCH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts16>#define EXCEPTION_CONTINUE_EXECUTION&nbsp;&nbsp;&nbsp; -1</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>一、</span><span class=rvts15>SEH </span><span class=rvts20>创建代码</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这里我没有继续使用上面的</span><span class=rvts15> SimpleSeh </span><span class=rvts20>进行分析，而是新写了一个简单的</span><span class=rvts15> SehTest </span><span class=rvts20>函数。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID SehTest</span><span class=rvts19>()</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try </span><span class=rvts21>// </span><span class=rvts22>第一个</span><span class=rvts21> __try </span><span class=rvts22>域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x11111111</span><span class=rvts19>; </span><span class=rvts21>// </span><span class=rvts22>最后一位为</span><span class=rvts21>1</span><span class=rvts22>表示“在</span><span class=rvts21> __try </span><span class=rvts22>代码块中”</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts19>(</span><span class=rvts15>Filter_0</span><span class=rvts19>())</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x11111110</span><span class=rvts19>; </span><span class=rvts21>// </span><span class=rvts22>最后一位为</span><span class=rvts21>0</span><span class=rvts22>表示“在</span><span class=rvts21> __except/__finally </span><span class=rvts22>代码块中”</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try </span><span class=rvts21>// </span><span class=rvts22>第二个</span><span class=rvts21> __try </span><span class=rvts22>域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x22222222</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try </span><span class=rvts21>// </span><span class=rvts22>第三个</span><span class=rvts21> __try </span><span class=rvts22>域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x33333333</span><span class=rvts19>;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>*((</span><span class=rvts15>ULONG</span><span class=rvts19>*)</span><span class=rvts17>NULL</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts19>=</span><span class=rvts15> ulVal</span><span class=rvts19>;</span><span class=rvts15> </span><span class=rvts21>// </span><span class=rvts22>触发异常</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x33333330</span><span class=rvts19>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts19>(</span><span class=rvts15>Filter_2</span><span class=rvts19>())</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulVal </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts24>0x22222220</span><span class=rvts19>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts17>return</span><span class=rvts19>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts25> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>反汇编代码如下：</span></p>
<p><span class=rvts25> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts26>（需要说明一下我的命名习惯是，</span><span class=rvts25>"l_"</span><span class=rvts26>前缀的变量是函数的局部变量，没有任何前缀的变量是传入的参数）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf passthrough!SehTest</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;PassThrough!SehTest [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 604]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720040&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720042&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720043&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720045&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRegistration-&gt;trylevel = TRYLEVEL_INVALID (-2)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720047&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!__safe_se_handler_table</span><span class=rvts19>+</span><span class=rvts24>0x8</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8721468</span><span class=rvts19>)</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872004c&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!_except_handler4 </span><span class=rvts19>(</span><span class=rvts15>f8720390</span><span class=rvts19>)</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRegistration-&gt;handler</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720051&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>00000000h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720057&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; _EXCEPTION_REGISTRATION::prev</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720058&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFF4h</span><span class=rvts15>&nbsp; </span><span class=rvts21>; </span><span class=rvts22>这里分配了</span><span class=rvts21> 0xc </span><span class=rvts22>字节的栈空间，其中紧贴着</span><span class=rvts21> l_ExceptionRegistration-&gt;prev </span></p>
<p><span class=rvts21>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>的</span><span class=rvts21>4</span><span class=rvts22>个字节存放着</span><span class=rvts21> l_ExceptionRegistration-&gt;xpointers</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872005b&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872005c&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872005d&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872005e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>PassThrough!__security_cookie </span><span class=rvts19>(</span><span class=rvts15>f87220b0</span><span class=rvts19>)]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720063&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>对</span><span class=rvts21> scopetable </span><span class=rvts22>进行异或加密</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720066&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>ebp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>对</span><span class=rvts21> __security_cookie </span><span class=rvts22>进行加密</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720068&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>把加密了的</span><span class=rvts21> __security_cookie </span><span class=rvts22>也压入栈中，后面用来对</span><span class=rvts21> scopetable </span><span class=rvts22>进行解密</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720069&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>10h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872006c&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>00000000h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>将</span><span class=rvts21> l_ExceptionRegistration </span><span class=rvts22>挂入线程异常链表中</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720072&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>18h</span><span class=rvts19>],</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720075&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1Ch</span><span class=rvts19>],</span><span class=rvts24>0</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872007c&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>进入第一个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = 0</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720083&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1Ch</span><span class=rvts19>],</span><span class=rvts24>11111111h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872008a&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>离开第一个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = TRYLEVEL_NONE (-2)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720091&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest</span><span class=rvts19>+</span><span class=rvts24>0x6a</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87200aa</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>这里有个空洞，用</span><span class=rvts21> uf </span><span class=rvts22>命令是不会显示的。范围是</span><span class=rvts21> f8720093 </span><span class=rvts22>到</span><span class=rvts21> f87200a9</span><span class=rvts22>，汇编码如下</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; PassThrough!SehTest+0x53 [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 611]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f8720093&nbsp; call&nbsp;&nbsp;&nbsp; PassThrough!Filter_0 (f8720010)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f8720098&nbsp; ret</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f8720099&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; esp,dword ptr [ebp-18h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>第一个</span><span class=rvts21> __except </span><span class=rvts22>处理域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f872009c&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-1Ch],11111110h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200a3&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-4],0FFFFFFFEh&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>离开第一个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = TRYLEVEL_NONE (-2)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;PassThrough!SehTest+0x6a [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 616]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200aa&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>进入第二个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = 1 </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200b1&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1Ch</span><span class=rvts19>],</span><span class=rvts24>22222222h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200b8&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>2</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>进入第三个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = 2 </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200bf&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1Ch</span><span class=rvts19>],</span><span class=rvts24>33333333h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200c6&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200c9&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>ds</span><span class=rvts19>:[</span><span class=rvts24>00000000h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>触发异常</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200ce&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>离开第三个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = 1</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200d5&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!SehTest</span><span class=rvts19>+</span><span class=rvts24>0x9c</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87200dc</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200da&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest</span><span class=rvts19>+</span><span class=rvts24>0xa4</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87200e4</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>空洞，范围是</span><span class=rvts21> f87200dc </span><span class=rvts22>到</span><span class=rvts21> f87200e3</span><span class=rvts22>，汇编码如下</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; PassThrough!SehTest+0x9c [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 628]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200dc c745e430333333&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-1Ch],33333330h&nbsp;&nbsp;&nbsp; ; __finally </span><span class=rvts22>域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;PassThrough!SehTest+0xa4 [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 630]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200e4&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>离开第二个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = TRYLEVEL_NONE (-2)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87200eb&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!SehTest</span><span class=rvts19>+</span><span class=rvts24>0xc4</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720104</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>空洞，范围是</span><span class=rvts21> f87200ed </span><span class=rvts22>到</span><span class=rvts21> f8720103</span><span class=rvts22>，汇编码如下</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; PassThrough!SehTest+0xad [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 631]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200ed e83effffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; PassThrough!Filter_2 (f8720030)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200f2 c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200f3 8b65e8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; esp,dword ptr [ebp-18h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>第二个</span><span class=rvts21> __except </span><span class=rvts22>处理域</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200f6 c745e420222222&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-1Ch],22222220h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; f87200fd c745fcfeffffff&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-4],0FFFFFFFEh&nbsp;&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>离开第三个</span><span class=rvts21> __try </span><span class=rvts22>域，</span><span class=rvts21>l_ExceptionRegistration-&gt;trylevel = TRYLEVEL_NONE (-2)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ---------------------------------------------------------------------------------</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;PassThrough!SehTest+0xc4 [d:\workspace\code\mycode\r0\passthrough\passthrough.c @ 637]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720104&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>10h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720107&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>恢复旧的</span><span class=rvts21> EXCEPTION_REGISTRATION</span><span class=rvts22>。即从线程异常链表中摘除</span><span class=rvts21> l_ExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872010e&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872010f&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720110&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720111&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720112&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720114&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720115&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>来看看</span><span class=rvts15> scopetable </span><span class=rvts20>的内容：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd&gt; dd f8721468</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8721468&nbsp; fffffffe 00000000 ffffffd4 00000000&nbsp; &lt; 16</span><span class=rvts20>个字节的坑</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8721478&nbsp; [fffffffe f8720093 f8720099] [fffffffe</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8721488&nbsp; f87200ed f87200f3] [00000001 00000000</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8721498&nbsp; f87200dc] 00000000 00000000 00000000</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87214a8&nbsp; 00000000 00000000 00000000 00000000</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87214b8&nbsp; 00000000 00000000 00000000 00000000</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87214c8&nbsp; 00000000 00000000 00000000 00000000</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87214d8&nbsp; 00000000 00000000 00000000 00000000</span></p>
<p><span class=rvts24><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>前</span><span class=rvts15>16</span><span class=rvts20>个字节是坑，坑的作用晚点再说。之后就是三个</span><span class=rvts15> scopetable_entry</span><span class=rvts20>，被我用大括号扩起来了。对照前面的汇编码可以发现，</span><span class=rvts15>scopetable_entry::lpfnFilter </span><span class=rvts20>和</span><span class=rvts15> scopetable_entry::lpfnHandler </span><span class=rvts20>就是汇编码中的空洞处的代码。其中，第三个</span><span class=rvts15> scopetable_entry::lpfnFilter </span><span class=rvts20>是</span><span class=rvts15> NULL</span><span class=rvts20>，对照代码可以发现，是因为这是一个</span><span class=rvts15> __try &amp; __finally </span><span class=rvts20>块，没有</span><span class=rvts15> lpfnFilter</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>汇编代码很简单，注释里也有详细的分析过程了，我不再多啰嗦。只提两点：</span></p>
<p><span class=rvts25> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>1. </span><span class=rvts15>EXCEPTION_REGISTRATION::</span><span class=rvts25>scopetable </span><span class=rvts26>指针被用</span><span class=rvts25> __security_cookie </span><span class=rvts26>进行了异或加密。</span></p>
<p><span class=rvts25> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts25>2. </span><span class=rvts15>EXCEPTION_REGISTRATION::</span><span class=rvts25>scopetable </span><span class=rvts26>并不直接指向</span><span class=rvts25> scopetable_entry </span><span class=rvts26>数组，在第一个</span><span class=rvts25> scopetable_entry </span><span class=rvts26>之前有</span><span class=rvts25> 16 </span><span class=rvts26>个字节的坑。后续分析中会看到，它的主要作用是帮助验证</span><span class=rvts25> scopetable </span><span class=rvts26>是否被破坏。第三个</span><span class=rvts25> DWORD</span><span class=rvts26>，即上文中的</span><span class=rvts25> </span><span class=rvts15>ffffffd4 </span><span class=rvts20>是一个偏移量，后续的分析过程中会看得很清楚。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>二、</span><span class=rvts15>MSC </span><span class=rvts20>提供的</span><span class=rvts15> EXCEPTION_REGISTRATION::handler </span><span class=rvts20>函数</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>之前咱们有说过</span><span class=rvts15> EXCEPTION_REGISTRATION::handler </span><span class=rvts20>指向由</span><span class=rvts15> MSC </span><span class=rvts20>编译器提供的一个函数，这个函数内部负责调用</span><span class=rvts15> scopetable[?]-&gt;lpfnFilter/lpfnHandler</span><span class=rvts20>。这个函数通常为</span><span class=rvts15> module!_except_handler?</span><span class=rvts20>，其中</span><span class=rvts15>module</span><span class=rvts20>为模块名，</span><span class=rvts15>? </span><span class=rvts20>表示某数字。在分析过程中发现，有的模块完整实现了该函数，有的模块直接使用了系统提供的</span><span class=rvts15> nt!_except_handler?</span><span class=rvts20>。不知道是因为版本的问题，还是编译选项的问题。我没有深究。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>我继续以</span><span class=rvts15> passhThrough </span><span class=rvts20>模块为例，来说明这个函数。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>首先需要再次说明一下我的注释习惯：后续列出来的反汇编代码中，最左边的</span><span class=rvts15>:&lt;&gt;</span><span class=rvts20>符号表示跳转，是我在分析的过程中为了方便理解流程手写的。其中</span><span class=rvts15> &lt; </span><span class=rvts20>表示跳转源，</span><span class=rvts15>&gt; </span><span class=rvts20>是跳转目标，</span><span class=rvts15>: </span><span class=rvts20>用于组成连接线。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>为了方便对照，我把经过整理的</span><span class=rvts15> PassThrough!_except_handler4 </span><span class=rvts20>的原型列在这里：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>EXCEPTION_DISPOSITION _except_handler4 (</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_RECORD pExceptionRecord, </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PEXCEPTION_REGISTRATION pExceptionRegistration, </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PCONTEXT, </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PDISPATCHER_CONTEXT</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>);</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>反汇编代码：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_except_handler4</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4 </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>255</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720390&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720392&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720393&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720395&nbsp; </span><span class=rvts17>sub</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>14h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720398&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720399&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebx = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872039c&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872039d&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; esi = pExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203a0&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>PassThrough!__security_cookie </span><span class=rvts19>(</span><span class=rvts15>f87220b0</span><span class=rvts19>)]</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>用</span><span class=rvts21> __security_cookie </span><span class=rvts22>对</span><span class=rvts21> scopetable </span><span class=rvts22>解密</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203a6&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203a7&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203a9&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1</span><span class=rvts19>],</span><span class=rvts24>0&nbsp;&nbsp; </span><span class=rvts21>; ebp-1 </span><span class=rvts22>存放的是一个</span><span class=rvts21> BOOLEAN </span><span class=rvts22>值，用来表示是否执行过任何</span><span class=rvts21> scopetable_entry::lpfnFilter</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203ad&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts24>1&nbsp; </span><span class=rvts21>; ebp-8 </span><span class=rvts22>被用来存放本函数的返回值，这里初始化为</span><span class=rvts21> ExceptionContinueSearch (1)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203b4&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; edi = pExceptionRegistration-&gt;_ebp </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203b7&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>检查</span><span class=rvts21> scopetable </span><span class=rvts22>中坑的第一个</span><span class=rvts21> DWORD </span><span class=rvts22>值，后续来做相关的安全处理</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203ba&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x39</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87203c9</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x2c</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>315</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>1</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203bc&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203bf&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203c1&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203c4&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x39</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>315</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>2</span><span class=rvts22>）</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203c9&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203cc&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203cf&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203d1&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203d4&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>安全工作处理完毕，开始进入异常处理流程</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203d9&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; eax = pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203dc&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>66h</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRecord-&gt;ExceptionFlags &amp; EXCEPTION_UNWIND</span><span class=rvts22>，判断是异常处理过程还是展开过程</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203e0&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x138</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87204c8</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x56</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>331</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>异常处理过程</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203e6&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ecx = pContext</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203e9&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>14h</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203ec&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts27>edx</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; ebx-4 </span><span class=rvts22>是创建</span><span class=rvts21> EXCEPTION_REGISTRATION </span><span class=rvts22>时候预留的</span><span class=rvts21> xpointers </span><span class=rvts22>的空间，这里给它赋值</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203ef&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ebx = pExceptionRegistration-&gt;trylevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203f2&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>14h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; [ebp-14] = pExceptionRecord</span><span class=rvts22>，即</span><span class=rvts21> xpointers-&gt;ExceptionRecord = pExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203f5&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>10h</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; [ebp-10] = pContext</span><span class=rvts22>，即</span><span class=rvts21> xpointers-&gt;ContextRecord = pContext</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203f8&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel, TRYLEVEL_INVALID</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203fb&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xcc</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872045c</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x6d</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>341</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87203fd&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,[</span><span class=rvts27>ecx</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x70</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>343</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720400&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>ebx</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里</span><span class=rvts21> *3</span><span class=rvts22>，下面紧接着</span><span class=rvts21> *4</span><span class=rvts22>，即</span><span class=rvts21> *12</span><span class=rvts22>，实际上是为了跳过</span><span class=rvts21> x </span><span class=rvts22>个</span><span class=rvts21> scopetable_entry (</span><span class=rvts22>大小为</span><span class=rvts21>12</span><span class=rvts22>个字节</span><span class=rvts21>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720403&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>eax</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = scopetable[i].lpfnFilter, </span><span class=rvts22>这里</span><span class=rvts21>14h</span><span class=rvts22>是为了跳过</span><span class=rvts21>10h</span><span class=rvts22>大小的坑</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720407&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>eax</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = &amp;scopetable[i]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872040b&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; ebp-0Ch </span><span class=rvts22>存放的是</span><span class=rvts21> pCurrentScopeTableEntry</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872040e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = scopetable[i].previousTryLevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720410&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里是将</span><span class=rvts21> ebp+8 </span><span class=rvts22>当作局部变量使用</span><span class=rvts21>, [ebp+8] = scopetable[i].previousTryLevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720413&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>判断</span><span class=rvts21> scopetable[i].lpfnFilter </span><span class=rvts22>是否为</span><span class=rvts21> NULL</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720415&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x9b</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872042b</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x87</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>355</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; scopetable[i].lpfnFilter </span><span class=rvts22>不为</span><span class=rvts21> NULL</span><span class=rvts22>，调用它</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720417&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; edx = pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720419&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_EH4_CallFilterFunc </span><span class=rvts19>(</span><span class=rvts15>f87205d1</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872041e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15> </span><span class=rvts21>; [ebp-1] </span><span class=rvts22>表示是否执行过</span><span class=rvts21> lpfnFilter</span><span class=rvts22>，它是个</span><span class=rvts21> BOOLEAN </span><span class=rvts22>值</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720422&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720424&nbsp; </span><span class=rvts17>jl</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xd6</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720466</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>如果是</span><span class=rvts21> EXCEPTION_CONTINUE_EXECUTION (-1) </span><span class=rvts22>就跳</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x96</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>370</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720426&nbsp; </span><span class=rvts17>jg</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xdf</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872046f</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>如果是</span><span class=rvts21> EXCEPTION_EXECUTE_HANDLER (1) </span><span class=rvts22>就跳</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x98</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>370</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; lpfnFilter </span><span class=rvts22>返回</span><span class=rvts21> EXCEPTION_CONTINUE_SEARCH</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720428&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = scopetable[i].previousTryLevel </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x9b</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>341</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872042b&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872042d&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh </span><span class=rvts21>; cmp scopetable[i].previousTryLevel, TRYLEVEL_INVALID</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720430&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x70</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720400</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xa2</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>478</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720432&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>1</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>没有执行过</span><span class=rvts21> lpfnFilter</span><span class=rvts22>，无需进行安全检查</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720436&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xcc</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872045c</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xa8</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>486</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>执行过</span><span class=rvts21> lpfnFilter</span><span class=rvts22>，需要校验完整性</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp; f8720438&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>]</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872043a&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>根据</span><span class=rvts21> scopetable </span><span class=rvts22>坑的第一个</span><span class=rvts21> DWORD </span><span class=rvts22>值判断是否需要做进一步的安全检查</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872043d&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xbc</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872044c</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xaf</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>486</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>1</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872043f&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720442&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720444&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720447&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xbc</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>486</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>2</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872044c&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872044f&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720452&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720454&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edx</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>正常情况下</span><span class=rvts21> [edx+edi] </span><span class=rvts22>保存的是</span><span class=rvts21> __security_cookie </span><span class=rvts22>的值</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720457&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xcc</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>495</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872045c&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872045f&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720460&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720461&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720462&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts27>ebp</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720464&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720465&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xd6</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>367</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; lpfnFilter </span><span class=rvts22>返回</span><span class=rvts21> EXCEPTION_CONTINUE_EXECUTION</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720466&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15> </span><span class=rvts21>; [ebp-8] = ExceptionContinueExecution (0)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872046d&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xa8</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720438</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xdf</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>396</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; lpfnFilter </span><span class=rvts22>返回</span><span class=rvts21> EXCEPTION_EXECUTE_HANDLER</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872046f&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720472&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_EH4_GlobalUnwind </span><span class=rvts19>(</span><span class=rvts15>f87205fa</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720477&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872047a&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>ebx</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872047d&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x101</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720491</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xef</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>408</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872047f&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!__security_cookie </span><span class=rvts19>(</span><span class=rvts15>f87220b0</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720484&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720485&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720487&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; ecx = pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720489&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_EH4_LocalUnwind </span><span class=rvts19>(</span><span class=rvts15>f8720614</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872048e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x101</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>417</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720491&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ecx = scopetable[i].previousTryLevel </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720494&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel = scopetable[i].previousTryLevel </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720497&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720499&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872049c&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x11b</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87204ab</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x10e</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>431</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>1</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872049e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204a1&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204a3&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204a6&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x11b</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>431</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>校验</span><span class=rvts21> scopetable </span><span class=rvts22>完整性（</span><span class=rvts21>2</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204ab&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204ae&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204b1&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204b3&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edx</span><span class=rvts19>+</span><span class=rvts27>edi</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204b6&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>调用</span><span class=rvts21> lpfnHandler</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204bb&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = l_pCurrentScopeTableEntry</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204be&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ecx = l_pCurrentScopeTableEntry-&gt;lpfnHandler</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204c1&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; edx = pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204c3&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_EH4_TransferToHandler </span><span class=rvts19>(</span><span class=rvts15>f87205e8</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里不会返回！！</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x138</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>456</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204c8&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204cd&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>edx</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel, TRYLEVEL_INVALID</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204d0&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xcc</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872045c</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0x142</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\chandler4.c @ </span><span class=rvts24>467</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel </span><span class=rvts22>不等于</span><span class=rvts21> TRYLEVEL_INVALID</span><span class=rvts22>，开始局部展开</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204d2&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!__security_cookie </span><span class=rvts19>(</span><span class=rvts15>f87220b0</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204d7&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204d8&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>ebx</span><span class=rvts15>&nbsp; </span><span class=rvts21>; ecx = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f87204da&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_EH4_LocalUnwind </span><span class=rvts19>(</span><span class=rvts15>f8720614</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp; f87204df&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_except_handler4</span><span class=rvts19>+</span><span class=rvts24>0xa8</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720438</span><span class=rvts19>)</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts19> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这个函数代码不长。主要分为两个大分支，一个分支处理异常，一个分支处理展开</span><span class=rvts15>(</span><span class=rvts20>参考地址</span><span class=rvts15> f87203dc </span><span class=rvts20>处的</span><span class=rvts15> test </span><span class=rvts20>指令</span><span class=rvts15>)</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>处理异常的代码负责遍历</span><span class=rvts15> scopetable</span><span class=rvts20>，依次调用</span><span class=rvts15> scopetable_entry::lpfnFilter</span><span class=rvts20>（参考</span><span class=rvts15> f8720419 </span><span class=rvts20>处代码</span><span class=rvts15>)</span><span class=rvts20>，并针对不同的返回值做出不同的处理：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts20>返回</span><span class=rvts15> EXCEPTION_CONTINUE_EXECUTION</span><span class=rvts20>，则说明异常已经被刚刚调用的</span><span class=rvts15> lpfnFilter </span><span class=rvts20>修复。返回</span><span class=rvts15> ExceptionContinueExecution</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts20>返回</span><span class=rvts15> EXCEPTION_CONTINUE_SEARCH</span><span class=rvts20>，则继续遍历下一个</span><span class=rvts15> scopetable_entry</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>3. </span><span class=rvts20>返回</span><span class=rvts15> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts20>，则说明当前</span><span class=rvts15> scopetable_entry::lpfnHandler </span><span class=rvts20>负责处理该异常。于是调用它。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>对于展开的代码，则直接开始局部展开，即对</span><span class=rvts15> scopetable </span><span class=rvts20>进行展开。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>更具体的信息，请参考上面反汇编代码中我附的注释。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>有几个小点需要说一下：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts20>该函数多处使用</span><span class=rvts15> scopetable </span><span class=rvts20>中坑内的数据进行安全检查。这些操作对理解该函数流程没有帮助，可以忽略。如果觉得上面代码不纯净，可以参考我后续的附录</span><span class=rvts15>1</span><span class=rvts20>《</span><span class=rvts15>Ntfs!_except_handler3 </span><span class=rvts20>的反汇编代码》，这个函数流程更清晰简单。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts20>一旦有某</span><span class=rvts15> scopetable_entry::lpfnFilter </span><span class=rvts20>返回</span><span class=rvts15> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts20>，就会进行全局展开和局部展开。展开结束后会调用该</span><span class=rvts15> scopetable_entry::lpfnHandler</span><span class=rvts20>，该函数即为</span><span class=rvts15> _except </span><span class=rvts20>处理域，该函数形式是一个函数，实际上只是一段不返回的代码。即这段代码中没有</span><span class=rvts15> ret </span><span class=rvts20>指令。执行完整个</span><span class=rvts15> _except </span><span class=rvts20>处理域后，会接着执行其后的指令，并不会返回</span><span class=rvts15> _except_handler4</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>3. </span><span class=rvts20>该函数既启动展开，又负责展开，于是会出现类似于“重入”的现象。理解的过程中容易扰乱思路。</span></p>
<p><span class=rvts15> </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_except_handler4 </span><span class=rvts20>在执行过程中可能会调用这几个函数：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_CallFilterFunc</span><span class=rvts20>、</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_TransferToHandler</span><span class=rvts20>、</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_GlobalUnwind</span><span class=rvts20>、</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_LocalUnwind</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这几个函数名很明白的说明了它们的功能：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_CallFilterFunc </span><span class=rvts20>负责调用</span><span class=rvts15> scopetable_entry::lpfnFilter</span><span class=rvts20>；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_TransferToHandler </span><span class=rvts20>负责调用</span><span class=rvts15> scopetable_entry::lpfnHandler</span><span class=rvts20>；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_GlobalUnwind </span><span class=rvts20>负责全局展开；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_LocalUnwind </span><span class=rvts20>负责局部展开。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>来看看</span><span class=rvts15> _EH4_CallFilterFunc </span><span class=rvts20>和</span><span class=rvts15> _EH4_TransferToHandler </span><span class=rvts20>的反汇编代码，都很短。剩余两个展开相关的函数稍后咱们再来分析。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_EH4_CallFilterFunc</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_CallFilterFunc </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>408</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d1&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d2&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d3&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d4&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d5&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d7&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205d9&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205db&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205dd&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205df&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e1&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; lpfnFilter();</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e3&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e4&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e5&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e6&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e7&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_EH4_TransferToHandler</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_TransferToHandler </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>450</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205e8&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205ea&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; esi = lpfnHandler</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205ec&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>ecx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205ee&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205f0&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205f2&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>ecx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205f4&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205f6&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87205f8&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; jmp lpfnHandler</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到这里，咱们就以</span><span class=rvts15> PassThrough!_except_handler4 </span><span class=rvts20>为例分析完了</span><span class=rvts15> MSC </span><span class=rvts20>提供的</span><span class=rvts15> EXCEPTION_REGISTRATION::handler </span><span class=rvts20>函数。这个过程中多次接触到一个名为“展开”的概念，这就是咱们要讲的第三个部分。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>三、展开</span><span class=rvts15> </span><span class=rvts20>（</span><span class=rvts15>unwind</span><span class=rvts20>）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>为了说明这个概念，需要先回顾下异常发生后的处理流程。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>我们假设一系列使用</span><span class=rvts15> SEH </span><span class=rvts20>的函数调用流程：</span><span class=rvts15> </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>func1 -&gt; func2 -&gt; func3</span><span class=rvts20>。在</span><span class=rvts15> func3 </span><span class=rvts20>执行的过程中触发了异常。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>看看分发异常流程</span><span class=rvts15> RtlRaiseException -&gt; RtlDispatchException -&gt; RtlpExecuteHandlerForException</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlDispatchException </span><span class=rvts20>会遍历异常链表，对每个</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>都调用</span><span class=rvts15> RtlpExecuteHandlerForException</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>会调用</span><span class=rvts15> EXCEPTION_REGISTRATION::handler</span><span class=rvts20>，也就是</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts20>。如咱们上面分析，该函数内部遍历</span><span class=rvts15> EXCEPTION_REGISTRATION::scopetable</span><span class=rvts20>，如果遇到有</span><span class=rvts15> scopetable_entry::lpfnFilter </span><span class=rvts20>返回</span><span class=rvts15> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts20>，那么</span><span class=rvts15> scopetable_entry::lpfnHandler </span><span class=rvts20>就会被调用，来处理该异常。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>因为</span><span class=rvts15> lpfnHandler </span><span class=rvts20>不会返回到</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts20>，于是执行完</span><span class=rvts15> lpfnHandler </span><span class=rvts20>后，就会从</span><span class=rvts15> lpfnHandler </span><span class=rvts20>之后的代码继续执行下去。也就是说，假设</span><span class=rvts15> func3 </span><span class=rvts20>中触发了一个异常，该异常被</span><span class=rvts15> func1 </span><span class=rvts20>中的</span><span class=rvts15> __except </span><span class=rvts20>处理块处理了，那</span><span class=rvts15> __except </span><span class=rvts20>处理块执行完毕后，就从其后的指令继续执行下去，即异常处理完毕后，接着执行的就是</span><span class=rvts15> func1 </span><span class=rvts20>的代码。不会再回到</span><span class=rvts15> func2 </span><span class=rvts20>或者</span><span class=rvts15> func3</span><span class=rvts20>，这样就有个问题，</span><span class=rvts15>func2 </span><span class=rvts20>和</span><span class=rvts15> func3 </span><span class=rvts20>中占用的资源怎么办？这些资源比如申请的内存是不会自动释放的，岂不是会有资源泄漏问题？</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这就需要用到“展开”了。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>说白了，所谓“展开”就是进行清理。（注：这里的清理主要包含动态分配的资源的清理，栈空间是由</span><span class=rvts15> func1 </span><span class=rvts20>的“</span><span class=rvts15>mov esp,ebp</span><span class=rvts20>”</span><span class=rvts15> </span><span class=rvts20>这类操作顺手清理的。当时我被“谁来清理栈空间”这个问题困扰了很久……）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>那这个展开工作由谁来完成呢？由</span><span class=rvts15> func1 </span><span class=rvts20>来完成肯定不合适，毕竟</span><span class=rvts15> func2 </span><span class=rvts20>和</span><span class=rvts15> func3 </span><span class=rvts20>有没有申请资源、申请了哪些资源，</span><span class=rvts15>func1 </span><span class=rvts20>无从得知。于是这个展开工作还得要交给</span><span class=rvts15> func2 </span><span class=rvts20>和</span><span class=rvts15> func3 </span><span class=rvts20>自己来完成。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>展开分为两种：“全局展开”和“局部展开”。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>全局展开是指针对异常链表中的某一段，局部展开针对指定</span><span class=rvts15> EXCEPTION_REGISTRATION</span><span class=rvts20>。用上面的例子来讲，局部展开就是针对</span><span class=rvts15> func3 </span><span class=rvts20>或</span><span class=rvts15> func2 </span><span class=rvts20>（某一个函数）内部进行清理，全局展开就是</span><span class=rvts15> func2 </span><span class=rvts20>和</span><span class=rvts15> func3 </span><span class=rvts20>的局部清理的总和。再归纳一下，局部展开是指具体某一函数内部的清理，而全局展开是指，从异常触发点（</span><span class=rvts15>func3</span><span class=rvts20>）到异常处理点（</span><span class=rvts15>func1</span><span class=rvts20>）之间所有函数（包含异常触发点</span><span class=rvts15> func3</span><span class=rvts20>）的局部清理的总和。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>来看反汇编代码：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_EH4_GlobalUnwind</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_EH4_GlobalUnwind </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>485</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205fa&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205fb&nbsp;&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205fd&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205fe&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205ff&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720600&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>0</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pReturnValue</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720602&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>0</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720604&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!_EH4_GlobalUnwind</span><span class=rvts19>+</span><span class=rvts24>0x15</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872060f</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; pReturnEip</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720609&nbsp;&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872060a&nbsp;&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!RtlUnwind </span><span class=rvts19>(</span><span class=rvts15>f8720678</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872060f&nbsp;&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720610&nbsp;&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720611&nbsp;&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720612&nbsp;&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720613&nbsp;&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlUnwind </span><span class=rvts20>的原型：</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID RtlUnwind(</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PEXCEPTION_REGISTRATION pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID pReturnEip</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PEXCEPTION_RECORD pExceptionRecord,</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID pReturnValue</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!RtlUnwind </span><span class=rvts21>; </span><span class=rvts22>提示：此函数</span><span class=rvts21> wrk </span><span class=rvts22>提供了实现源码</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>423</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867358</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867359</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086735b</span><span class=rvts15>&nbsp; </span><span class=rvts17>sub</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>37Ch</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867361</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>nt!__security_cookie </span><span class=rvts19>(</span><span class=rvts24>80895388</span><span class=rvts19>)]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867366</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867367</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; esi = pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086736a</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086736d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086736e</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D8h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; [ebp-2D8h] = l_pHighLimit</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867374</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867375</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D4h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; [ebp-2D4h] = l_pLowLimit</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086737b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086737c</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlpGetStackLimits </span><span class=rvts19>(</span><span class=rvts24>80887cdc</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867381</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867383</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; pExceptionRecord </span><span class=rvts22>是否为</span><span class=rvts21> NULL</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867385</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x5a</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808673b2</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x2f</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>452</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867387</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086738a</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>37Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp-37Ch </span><span class=rvts22>是局部变量</span><span class=rvts21> l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867390</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>37Ch</span><span class=rvts19>],</span><span class=rvts24>0C0000027h</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionCode = STATUS_UNWIND</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086739a</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>378h</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags = 0</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673a0</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>374h</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionRecord = NULL</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673a6</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>370h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionAddress = ret_addr </span><span class=rvts22>（</span><span class=rvts21>PassThrough!RtlUnwind </span><span class=rvts22>执行完毕后的返回地址）</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673ac</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>36Ch</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionInformation[0] = 0;</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x5a</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>462</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673b2</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration </span><span class=rvts22>是否为</span><span class=rvts21> NULL</span></p>
<p><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673b5</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x65</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808673bd</span><span class=rvts19>)</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x5f</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>463</span><span class=rvts19>]:</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673b7</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>2</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags |= EXCEPTION_UNWINDING (0x2)</span></p>
<p><span class=rvts15> </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673bb</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x69</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808673c1</span><span class=rvts19>)</span></p>
<p><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x65</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>466</span><span class=rvts19>]:</span></p>
<p><span class=rvts15> </span><span class=rvts19>&gt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673bd</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags |= EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND (0x2 | 0x4)</span></p>
<p><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x69</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>466</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673c1</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673c2</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D0h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp-2D0 </span><span class=rvts22>是局部变量</span><span class=rvts21> l_Context</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673c8</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673c9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D0h</span><span class=rvts19>],</span><span class=rvts24>10007h</span><span class=rvts15> </span><span class=rvts21>; lContext.ContextFlags = CONTEXT_i386 | CONTEXT_CONTROL | CONTEXT_INTEGER | CONTEXT_SEGMENTS (0x10000 | 0x1 | 0x2 | 0x3)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673d3</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlpCaptureContext </span><span class=rvts19>(</span><span class=rvts24>80887c50</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673d8</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = ReturnValue</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673db</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>20Ch</span><span class=rvts19>],</span><span class=rvts24>10h</span><span class=rvts15> </span><span class=rvts21>; -20C = -2D0+C4, lContext.Esp += 0x10</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673e2</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>220h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; -220 = -2D0+B0, lContext.Eax = ReturnValue</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673e8</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlpGetRegistrationHead </span><span class=rvts19>(</span><span class=rvts24>80887d04</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673ed</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; ebx = </span><span class=rvts22>异常链表头，这里暂命名为</span><span class=rvts21> l_pExceptionRegistration</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673ef</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1d1</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80867529</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x9c</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>500</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673f4</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; cmp l_pExceptionRegistration,pExceptionRegistration </span></p>
<p><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673f7</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xb0</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80867408</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xa1</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>501</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration </span><span class=rvts22>等于</span><span class=rvts21> l_pExceptionRegistration</span><span class=rvts22>，说明展开完毕</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673f9</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; TestAlert = FALSE</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808673fa</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D0h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = &amp;l_Context</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867400</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867401</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!ZwContinue </span><span class=rvts19>(</span><span class=rvts24>8082c0b8</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>;&nbsp; </span><span class=rvts22>这里不会返回</span></p>
<p><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867406</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xe6</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>8086743e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xb0</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>509</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:&gt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867408</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration, NULL</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086740b</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xe6</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>8086743e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xb5</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>509</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086740d</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>ebx</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration,l_pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867410</span><span class=rvts15>&nbsp; </span><span class=rvts17>jae</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xe6</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>8086743e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xba</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>514</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration </span><span class=rvts22>在</span><span class=rvts21> l_pExceptionRegistration </span><span class=rvts22>之下，即</span><span class=rvts21> pExceptionRegistration </span><span class=rvts22>超出了异常链表的栈范围</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867412</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp-32Ch </span><span class=rvts22>是局部变量</span><span class=rvts21> l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867418</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867419</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>],</span><span class=rvts24>0C0000029h</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionCode = STATUS_INVALID_UNWIND_TARGET</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867423</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>328h</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags = EXCEPTION_NONCONTINUABLE (1)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086742d</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>324h</span><span class=rvts19>],</span><span class=rvts27>esi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionRecord = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867433</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>31Ch</span><span class=rvts19>],</span><span class=rvts27>edi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.NumberParameters = 0</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867439</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlRaiseException </span><span class=rvts19>(</span><span class=rvts24>80887a94</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xe6</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>530</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;&gt;&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086743e</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D4h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; cmp l_pExceptionRegistration, l_pLowLimit</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867444</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edi = l_pExceptionRegistration-&gt;scopetable_entry</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867447</span><span class=rvts15>&nbsp; </span><span class=rvts17>jb</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x162</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674ba</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration </span><span class=rvts22>低于线程栈底，跳到错误处理</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xf1</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>530</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867449</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D8h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; cmp l_pExceptionRegistration-&gt;scopetable_entry,l_pHighLimit</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086744f</span><span class=rvts15>&nbsp; </span><span class=rvts17>ja</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x162</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674ba</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration </span><span class=rvts22>高于线程栈顶，跳到错误处理</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0xf9</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>530</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_pExceptionRegistration </span><span class=rvts22>处于合法栈中，检查它是否正确对齐</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867451</span><span class=rvts15>&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>bl</span><span class=rvts19>,</span><span class=rvts24>3</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>检查</span><span class=rvts21> l_pExceptionRegistration </span><span class=rvts22>是否</span><span class=rvts21>4</span><span class=rvts22>字节对齐</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867454</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>没对齐，跳到错误处理</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x102</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>580</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>进行局部展开</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086745a</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration-&gt;Handler</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086745d</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2DCh</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里是局部变量</span><span class=rvts21> l_DispatchContext</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867463</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>;</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867464</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D0h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = &amp;l_Context</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086746a</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; l_Context</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086746b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086746c</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts15> </span><span class=rvts21>; &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086746d</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlpExecuteHandlerForUnwind </span><span class=rvts19>(</span><span class=rvts24>80887b54</span><span class=rvts19>) </span><span class=rvts21>; </span><span class=rvts22>内部调用</span><span class=rvts21> l_pExceptionRegistration-&gt;Handler</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867472</span><span class=rvts15>&nbsp; </span><span class=rvts17>dec</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867473</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x156</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674ae</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>如果返回</span><span class=rvts21> ExceptionContinueSearch </span><span class=rvts22>则跳转</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x11d</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>586</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867475</span><span class=rvts15>&nbsp; </span><span class=rvts17>dec</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867476</span><span class=rvts15>&nbsp; </span><span class=rvts17>dec</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867477</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x150</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674a8</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>如果返回</span><span class=rvts21> ExceptionCollidedUnwind </span><span class=rvts22>则跳转</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x121</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>621</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>返回</span><span class=rvts21> ExceptionContinueSearch </span><span class=rvts22>和</span><span class=rvts21> ExceptionCollidedUnwind </span><span class=rvts22>之外的非法值</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867479</span><span class=rvts15>&nbsp; </span><span class=rvts17>and</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>31Ch</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.NumberParameters = 0</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867480</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867486</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867487</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>],</span><span class=rvts24>0C0000026h</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionCode = STATUS_INVALID_DISPOSITION</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867491</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>328h</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags = EXCEPTION_NONCONTINUABLE (1)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086749b</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>324h</span><span class=rvts19>],</span><span class=rvts27>esi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionRecord = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674a1</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlRaiseException </span><span class=rvts19>(</span><span class=rvts24>80887a94</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::&lt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674a6</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x156</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674ae</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x150</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>608</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; RtlpExecuteHandlerForUnwind </span><span class=rvts22>返回</span><span class=rvts21> ExceptionCollidedUnwind</span><span class=rvts22>，从</span><span class=rvts21> l_DispatchContext.RegistrationPointer </span><span class=rvts22>继续处理</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674a8</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2DCh</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration = l_DispatchContext.RegistrationPointer</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x156</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>630</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>局部展开完毕，从异常链表中摘除</span><span class=rvts21> l_pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::&gt;&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674ae</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>ebx</span><span class=rvts15> </span><span class=rvts21>; eax = l_pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674b0</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; l_pExceptionRegistration = l_pExceptionRegistration.prev</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674b2</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674b3</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlpUnlinkHandler </span><span class=rvts19>(</span><span class=rvts24>80887c10</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>摘除</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674b8</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1cf</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80867527</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x162</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>540</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_pExceptionRegistration </span><span class=rvts22>并不处在当前线程栈中，这种情况不一定是出错，有可能当前正在执行</span><span class=rvts21> DPC</span><span class=rvts22>。</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>当时还需要检查是否对齐，不对齐就一定是出错</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;&gt;::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674ba</span><span class=rvts15>&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>bl</span><span class=rvts19>,</span><span class=rvts24>3</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>检查</span><span class=rvts21> l_pExceptionRegistration </span><span class=rvts22>是否</span><span class=rvts21>4</span><span class=rvts22>字节对齐</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674bd</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x167</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>540</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>如果当前正在执行</span><span class=rvts21> DPC</span><span class=rvts22>，那</span><span class=rvts21> IRQL </span><span class=rvts22>一定不得低于</span><span class=rvts21> DISPATCH_LEVEL</span><span class=rvts22>（难道不是应该一定等于</span><span class=rvts21> DISPATCH_LEVEL </span><span class=rvts22>？）</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674bf</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>nt!_imp__KeGetCurrentIrql </span><span class=rvts19>(</span><span class=rvts24>8080102c</span><span class=rvts19>)]</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674c5</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>al</span><span class=rvts19>,</span><span class=rvts24>2</span><span class=rvts15> </span><span class=rvts21>; DISPATCH_LEVEL (2)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674c7</span><span class=rvts15>&nbsp; </span><span class=rvts17>jb</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>低于</span><span class=rvts21> DISPATCH_LEVEL</span><span class=rvts22>，跳到错误处理点</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x171</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>542</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674c9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>00000020h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = </span><span class=rvts22>当前</span><span class=rvts21> CPU </span><span class=rvts22>的</span><span class=rvts21> KPCR::Prcb</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674cf</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>95Ah</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15> </span><span class=rvts21>; KPCR::Prcb-&gt;DpcRoutineActive (BOOLEAN </span><span class=rvts22>类型</span><span class=rvts21>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674d6</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>948h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = KPCR::Prcb-&gt;DpcStack</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::&lt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674dc</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>当前不是在执行</span><span class=rvts21> DPC</span><span class=rvts22>，跳到错误处理点</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x186</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>547</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; KPCR::Prcb-&gt;DpcRoutineActive </span><span class=rvts22>为</span><span class=rvts21> TRUE</span><span class=rvts22>，当前异常是由</span><span class=rvts21> DpcRoutine </span><span class=rvts22>触发</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674de</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>比较</span><span class=rvts21> l_pExceptionRegistration-&gt;scopetable_entry </span><span class=rvts22>和</span><span class=rvts21> DPC </span><span class=rvts22>栈顶</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::&lt;</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674e0</span><span class=rvts15>&nbsp; </span><span class=rvts17>ja</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>高出</span><span class=rvts21> DPC </span><span class=rvts22>栈顶，跳到错误处理点</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x18a</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>547</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674e2</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ecx</span><span class=rvts19>-</span><span class=rvts24>3000h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = KPCR::Prcb-&gt;DpcStack - KERNEL_STACK_SIZE, </span><span class=rvts22>即</span><span class=rvts21> DPC </span><span class=rvts22>栈底</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674e8</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>比较</span><span class=rvts21> l_pExceptionRegistration </span><span class=rvts22>和</span><span class=rvts21> DPC </span><span class=rvts22>栈底</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::::::&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674ea</span><span class=rvts15>&nbsp; </span><span class=rvts17>jb</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808674fa</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>低于</span><span class=rvts21> DPC </span><span class=rvts22>栈底，跳到错误处理点</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x194</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>555</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674ec</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D8h</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; l_pHighLimit = DPC </span><span class=rvts22>栈顶</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674f2</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D4h</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; l_pLowLimit = DPC </span><span class=rvts22>栈底</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::&lt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674f8</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1cf</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80867527</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::::</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1a2</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>564</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:::::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>栈错误</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;:&gt;&gt;&gt;&gt;&gt;::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808674fa</span><span class=rvts15>&nbsp; </span><span class=rvts17>and</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>31Ch</span><span class=rvts19>],</span><span class=rvts24>0</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867501</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; eax = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867507</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867508</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>32Ch</span><span class=rvts19>],</span><span class=rvts24>0C0000028h</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionCode = STATUS_BAD_STACK</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867512</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>328h</span><span class=rvts19>],</span><span class=rvts24>1</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags = EXCEPTION_NONCONTINUABLE (1)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086751c</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>324h</span><span class=rvts19>],</span><span class=rvts27>esi</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionRecord.ExceptionRecord = &amp;l_ExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867522</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!RtlRaiseException </span><span class=rvts19>(</span><span class=rvts24>80887a94</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1cf</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>493</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867527</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1d1</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>493</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867529</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFFh</span><span class=rvts15> </span><span class=rvts21>; cmp l_pExceptionRegistration, EXCEPTION_CHAIN_END</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086752c</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x9c</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808673f4</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1da</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>647</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867532</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts24>0FFFFFFFFh</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration, EXCEPTION_CHAIN_END</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867536</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867537</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>2D0h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = &amp;l_Context</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086753d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts15> </span><span class=rvts21>; bTestAlert = FALSE </span><span class=rvts22>或</span><span class=rvts21> bFirstChance = FALSE</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086753e</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086753f</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1f0</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80867548</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1e9</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>656</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>展开整个异常链表</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867541</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!ZwContinue </span><span class=rvts19>(</span><span class=rvts24>8082c0b8</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867546</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1f6</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>8086754e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1f0</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>667</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration </span><span class=rvts22>等于</span><span class=rvts21> EXCEPTION_CHAIN_END</span><span class=rvts22>。</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>没有理解这里触发异常是为什么，但是不妨碍分析异常处理流程。</span></p>
<p><span class=rvts19>&gt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867548</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts15> </span><span class=rvts21>; &amp;l_ExceptionRecord</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867549</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!ZwRaiseException </span><span class=rvts19>(</span><span class=rvts24>8082ccd4</span><span class=rvts19>)</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlUnwind</span><span class=rvts19>+</span><span class=rvts24>0x1f6</span><span class=rvts15> </span><span class=rvts19>[c:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\exdsptch.c @ </span><span class=rvts24>671</span><span class=rvts19>]:</span></p>
<p><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8086754e</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867551</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867552</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867553</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts24>80874e87</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867558</span><span class=rvts15>&nbsp; </span><span class=rvts17>leave</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80867559</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>10h</span></p>
<p><span class=rvts24><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf </span><span class=rvts24>80887be9</span><span class=rvts15> </span><span class=rvts21>; RtlpExecuteHandlerForUnwind </span><span class=rvts22>的异常处理函数</span><span class=rvts21> </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x61</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>329</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887be9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bed</span><span class=rvts15>&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; test pExceptionRecord-&gt;ExceptionFlags, EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bf4</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>1</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionContinueSearch</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bf9</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x85</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80887c0d</span><span class=rvts19>)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x73</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>341</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>展开过程中</span><span class=rvts21> Handler </span><span class=rvts22>触发异常</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bfb</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ecx = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bff</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edx = pDispatcherContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887c03</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; eax = pExceptionRegistration-&gt;prev</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887c06</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edx</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pDispatcherContext-&gt;RegistrationPointer = pExceptionRegistration-&gt;prev</span><span class=rvts22>，</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>然后</span><span class=rvts21> pDispatcherContext-&gt;RegistrationPointer </span><span class=rvts22>就是展开过程中正在被展开的</span></p>
<p><span class=rvts21>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; </span><span class=rvts22>那个</span><span class=rvts21> EXCEPTION_REGISTRATION_RECORD</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887c08</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>3</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionCollidedUnwind</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x85</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>349</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887c0d</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>10h</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf RtlpExecuteHandlerForUnwind</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlpExecuteHandlerForUnwind </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>142</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b54</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts23>offset</span><span class=rvts15> nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x61</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80887be9</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b59</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,[</span><span class=rvts27>ecx</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5c</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5e</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5f</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b61</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b63</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b65</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b67</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRoutine</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b6b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pDispatcherContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b6f</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b73</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b77</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b7b</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2 </span><span class=rvts19>(</span><span class=rvts24>80887b88</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b80</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b81</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b82</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b83</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>14h</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf nt!ExecuteHandler2</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2 </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>188</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b88</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b89</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8e</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; _EXCEPTION_REGISTRATION_RECORD::Handler (nt!ExecuteHandler2+0x61 (80887be9))</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8f</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; _EXCEPTION_REGISTRATION_RECORD::Next</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b96</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>],</span><span class=rvts27>esp</span><span class=rvts21>; </span><span class=rvts22>注意：这里使用的是原始版本的异常处理</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b9d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pDispatcherContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba0</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba3</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba6</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>18h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = pExceptionRoutine</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bac</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; pExceptionRoutine(...)</span><span class=rvts22>，即</span><span class=rvts21> pExceptionRegistration-&gt;handler(...)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bae</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bb5</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>摘掉当前</span><span class=rvts21> _EXCEPTION_REGISTRATION_RECORD</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbc</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbe</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbf</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>14h</span></p>
<p><span class=rvts24><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>代码虽长，主要功能却不复杂：从异常链表头开始遍历，一直遍历到指定</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>，对每个遍历到的</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>，执行</span><span class=rvts15> RtlpExecuteHandlerForUnwind </span><span class=rvts20>进行局部展开。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>这段代码里有一个细节我没想明白，或者我想复杂了。在</span><span class=rvts15> nt!RtlUnwind </span><span class=rvts20>地址</span><span class=rvts15> 80867401 </span><span class=rvts20>处，当展开到指定</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>后，</span><span class=rvts15>RtlUnwind </span><span class=rvts20>通过</span><span class=rvts15> ZwContinue </span><span class=rvts20>返回，而不是使用</span><span class=rvts15> ret </span><span class=rvts20>指令。通过静态分析和动态分析我都没有找到用</span><span class=rvts15> ZwContinue </span><span class=rvts20>的好处，或者不可替代的原因。如果有朋友有不同的结论，请分享一下。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在分析全局展开时发生一件很囧的事，我反汇编完成，梳理流程的时候，总感觉“这个逻辑怎么这么熟悉，貌似在哪见过</span><span class=rvts15>~ </span><span class=rvts20>难道</span><span class=rvts15> wrk </span><span class=rvts20>里有源码？”，翻开</span><span class=rvts15> wrk</span><span class=rvts20>，果然有……</span><span class=rvts15> </span><span class=rvts20>不过话说回来，在反汇编分析过程让我对一些细节理解的更深刻了（也只能这么安慰自己了……）。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>下面我们来看看局部展开。</span></p>
<p><span class=rvts24> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在前面讲</span><span class=rvts15> PassThrough!_except_handler4 </span><span class=rvts20>时，有提到该函数既负责处理异常也负责局部展开。其区分功能的标志就是判断</span><span class=rvts15> EXCEPTION_RECORD::ExceptionFlags </span><span class=rvts20>是否包含</span><span class=rvts15> EXCEPTION_UNWIND </span><span class=rvts20>标志位。可以参考</span><span class=rvts15> PassThrough!_except_handler4 </span><span class=rvts20>中地址为</span><span class=rvts15> f87203dc </span><span class=rvts20>的指令：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>f87203dc&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>byte</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>66h</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRecord-&gt;ExceptionFlags &amp; EXCEPTION_UNWIND</span><span class=rvts22>，判断是异常处理过程还是展开过程</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>该标志是在</span><span class=rvts15> RtlUnwind </span><span class=rvts20>中被设置的，可以参考</span><span class=rvts15> RtlUnwind </span><span class=rvts20>中地址为</span><span class=rvts15> 808673b7 </span><span class=rvts20>和</span><span class=rvts15> 808673bd </span><span class=rvts20>出的指令：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts24>808673b7</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>2</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags |= EXCEPTION_UNWINDING (0x2)</span></p>
<p><span class=rvts24> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts24>808673bd</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span><span class=rvts15> </span><span class=rvts21>; l_ExceptionRecord.ExceptionFlags |= EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND (0x2 | 0x4)</span></p>
<p><span class=rvts21><br></span></p>
<p><span class=rvts21> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>反汇编代码：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>首先是我整理的</span><span class=rvts15> _EH4_LocalUnwind </span><span class=rvts20>的原型：</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID fastcall _EH4_LocalUnwind(</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PEXCEPTION_REGISTRATION pExceptionRegistartion,</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_EH4_LocalUnwind</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_EH4_LocalUnwind </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>529</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720614&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720615&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp = pExceptionRegistartion-&gt;_ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720619&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts15> </span><span class=rvts21>; ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872061a&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistartion</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872061b&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; push __security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872061f&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4 </span><span class=rvts19>(</span><span class=rvts15>f87204ec</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720624&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>0Ch</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720627&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720628&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_LocalUnwind </span><span class=rvts20>的原型：</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID local_unwind4(</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PEXCEPTION_REGSTRATION pExceptionRegstration,</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ULONG ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_local_unwind4</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4 </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>177</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204ec&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204ed&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204ee&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204ef&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edx = __security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204f3&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistartion</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204f7&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>18h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204fb&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204fc&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts15> </span><span class=rvts21>; __security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204fd&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistartion</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204fe&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87204ff&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里压入的值后续被</span><span class=rvts21> f8720513 </span><span class=rvts22>处的指令修改</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720500&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> PassThrough!_unwind_handler4 </span><span class=rvts19>(</span><span class=rvts15>f872056f</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; _EXCEPTION_REGISTRATION_RECORD::handler</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720505&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; _EXCEPTION_REGISTRATION_RECORD::prev, </span><span class=rvts22>注意这里使用的是原始版本</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872050c&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>PassThrough!__security_cookie </span><span class=rvts19>(</span><span class=rvts15>f87220b0</span><span class=rvts19>)]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720511&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>esp</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里是用</span><span class=rvts21> esp </span><span class=rvts22>来异或，而</span><span class=rvts21> esp </span><span class=rvts22>此时指向新</span><span class=rvts21> _EXCEPTION_REGISTRATION_RECORD</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720513&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; [esp+8] </span><span class=rvts22>被赋予加密后的</span><span class=rvts21> __security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720517&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>],</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x32</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>209</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>&gt;&gt;</span><span class=rvts15>&nbsp;&nbsp; f872051e&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>30h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistartion</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720522&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ebx = pExceptionRegistration-&gt;scopetable, </span><span class=rvts22>将</span><span class=rvts21> ebx </span><span class=rvts22>假称为</span><span class=rvts21> l_pCurScopeEntry</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720525&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>2Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = &amp;__security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720529&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>解密</span><span class=rvts21> scopetable</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f872052b&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; esi = pExceptionRegistration-&gt;trylevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f872052e&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel,TRYLEVEL_NONE</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720531&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x75</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720561</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel </span><span class=rvts22>等于</span><span class=rvts21> TRYLEVEL_NONE</span><span class=rvts22>，无需遍历，返回</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15> PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x47</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>216</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720533&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>34h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edx = ulUntilTryLevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f8720537&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFEh</span><span class=rvts15> </span><span class=rvts21>; cmp ulUntilTryLevel, TRYLEVEL_NONE</span></p>
<p><span class=rvts19>:&lt;</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f872053a&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x54</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720540</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> </span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x50</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>219</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; f872053c&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>edx</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel, ulUntilTryLevel</span></p>
<p><span class=rvts19>::&lt;::</span><span class=rvts15>&nbsp;&nbsp; f872053e&nbsp; </span><span class=rvts17>jbe</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x75</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f8720561</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>已经遍历到指定</span><span class=rvts21> scopetable_entry </span><span class=rvts22>了，返回</span></p>
<p><span class=rvts19>:::::</span><span class=rvts15> </span></p>
<p><span class=rvts19>:::::</span><span class=rvts15> PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x54</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>221</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:&gt;:::</span><span class=rvts15>&nbsp;&nbsp; f8720540&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; f8720543&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebx - pExceptionRegistration-&gt;scopetable[pExceptionRegistration-&gt;trylevel]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; f8720547&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = l_pCurScopeEntry-&gt;previousTryLevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; f8720549&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel = ebx-&gt;l_pCurScopeEntry-&gt;previousTryLevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; f872054c&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15> </span><span class=rvts21>; cmp pExceptionRegistration-&gt;lpfnFilter,NULL</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:&lt;:</span><span class=rvts15>&nbsp;&nbsp; f8720550&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x32</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872051e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x66</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>240</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720552&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts24>1</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f8720557&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration-&gt;lpfnHandler</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; f872055a&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_NLG_Call </span><span class=rvts19>(</span><span class=rvts15>f8720630</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>调用</span><span class=rvts21> pExceptionRegistration-&gt;lpfnHandler</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp; f872055f&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x32</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f872051e</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; PassThrough!_local_unwind4</span><span class=rvts19>+</span><span class=rvts24>0x75</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>248</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; f8720561&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720568&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>18h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872056b&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872056c&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872056d&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872056e&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_NLG_Call</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_NLG_Call </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\nlgsupp.asm @ </span><span class=rvts24>120</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720630&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720632&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_EH4_LocalUnwind </span><span class=rvts20>中</span><span class=rvts15> f8720500 </span><span class=rvts20>处的指令用到的异常处理函数</span><span class=rvts15> PassThrough!_unwind_handler4 </span><span class=rvts20>的反汇编代码：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf PassThrough!_unwind_handler4</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_unwind_handler4 </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>294</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872056f&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720573&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; test pExceptionRecord-&gt;ExceptionFlags, EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872057a&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>1</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionContinueSearch (1)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872057f&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_unwind_handler4</span><span class=rvts19>+</span><span class=rvts24>0x45</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts15>f87205b4</span><span class=rvts19>)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_unwind_handler4</span><span class=rvts19>+</span><span class=rvts24>0x12</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>307</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>在展开过程中又触发了异常，那么处理该新异常（实际操作只是做展开，即清理掉该异常占用的资源，并没有真正处理该异常）</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720581&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720585&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ecx = __security_cookie, </span><span class=rvts22>注意这里不是</span><span class=rvts21> __pExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720588&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>这里用</span><span class=rvts21> pExceptionRegistration </span><span class=rvts22>解密，</span><span class=rvts21>PassThrough!_local_unwind4 </span><span class=rvts22>中也正是用它进行加密的</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>参考</span><span class=rvts21> f8720511 </span><span class=rvts22>处的指令</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872058a&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!__security_check_cookie </span><span class=rvts19>(</span><span class=rvts15>f8720638</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872058f&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720590&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>18h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax+18h </span><span class=rvts22>是被</span><span class=rvts21> PassThrough!_local_unwind4 </span><span class=rvts22>压入栈的</span><span class=rvts21> ebp</span><span class=rvts22>，</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>参考</span><span class=rvts21> f87204fb </span><span class=rvts22>处的指令</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720593&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; push ulUntilTryLevel</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720596&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistartion</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f8720599&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; __security_cookie</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f872059c&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; PassThrough!_local_unwind4 </span><span class=rvts19>(</span><span class=rvts15>f87204ec</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205a1&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>0Ch</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205a4&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205a5&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205a9&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edx = pDispatcherContext </span><span class=rvts22>（调整</span><span class=rvts21> pDispatcherContext</span><span class=rvts22>，改变遍历顺序）</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205ad&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edx</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pDispatcherContext-&gt;RegistrationPointer = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205af&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>3</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionCollidedUnwind (3)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PassThrough!_unwind_handler4</span><span class=rvts19>+</span><span class=rvts24>0x45</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\</span><span class=rvts24>5359</span><span class=rvts15>\minkernel\crts\crtw32\misc\i386\exsup4.asm @ </span><span class=rvts24>336</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f87205b4&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts17><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到这里概要流程就讲完了。在处理异常和展开过程中多处涉及到遍历操作，咱们来总结一下这些遍历操作。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts20>在异常处理过程中，每个被</span><span class=rvts15>"</span><span class=rvts20>卷入是非</span><span class=rvts15>"</span><span class=rvts20>的异常都至少会遍历异常链表两次（如果发生嵌套异常，比如在展开过程中</span></p>
<p><span class=rvts15>EXCEPTION_REGISTRATION_RECORD::Handler </span><span class=rvts20>又触发异常，则会遍历更多次。不过这也可以算作是一个新异常了。看如何理解。）。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>一次是在</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>中，遍历的目的是找到愿意处理该异常的</span><span class=rvts15> _EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>另一次是在展开过程中、</span><span class=rvts15>RtlUnwind </span><span class=rvts20>函数内，遍历的目录是为了对每个遍历到的</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD </span><span class=rvts20>进行局部展开。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts20>同样的，每个被</span><span class=rvts15>"</span><span class=rvts20>卷入是非</span><span class=rvts15>"</span><span class=rvts20>的异常的</span><span class=rvts15> scopetable </span><span class=rvts20>也会被遍历至少两次，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>一次是在</span><span class=rvts15> modulename!_except_handler? </span><span class=rvts20>中，遍历目的也是找到愿意处理该异常的</span><span class=rvts15> scopetable_entry</span><span class=rvts20>。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>另一次是在展开过程中、</span><span class=rvts15>_local_unwind4 </span><span class=rvts20>函数内，遍历的目的是找到所有指定范围内的</span><span class=rvts15> scopetable_entry::lpfnFilter </span><span class=rvts20>为</span><span class=rvts15> NULL </span><span class=rvts20>的</span><span class=rvts15> scopetable_entry</span><span class=rvts20>，调用它们的</span><span class=rvts15> lpfnHandler </span><span class=rvts20>（即</span><span class=rvts15> __finally </span><span class=rvts20>处理块）。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在展开过程中，</span><span class=rvts15>__finally </span><span class=rvts20>代码块会被执行，在执行过程中有可能触发新的异常，增强版通过返回</span><span class=rvts15> ExceptionCollidedUnwind (3) </span><span class=rvts20>来标识这种情况（参考</span><span class=rvts15> PassThrough!_unwind_handler4 </span><span class=rvts20>中</span><span class=rvts15> f87205af </span><span class=rvts20>处的指令）。咱来回顾下这类返回值：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts17> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts17>typedef</span><span class=rvts15> </span><span class=rvts18>enum</span><span class=rvts15> _EXCEPTION_DISPOSITION </span><span class=rvts19>{</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueExecution</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionContinueSearch</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionNestedException</span><span class=rvts19>,</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; ExceptionCollidedUnwind</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts19>}</span><span class=rvts15> EXCEPTION_DISPOSITION</span><span class=rvts19>;</span></p>
<p><span class=rvts19><br></span></p>
<p><span class=rvts19> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>前面的代码中已经展示了上述</span><span class=rvts15>4</span><span class=rvts20>中的三种：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionContinueExecution </span><span class=rvts20>表示继续执行（异常已经被修复）；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionContinueSearch </span><span class=rvts20>表示继续搜索（当前搜索到的异常注册信息不处理）；</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionCollidedUnwind </span><span class=rvts20>表示在展开过程中再次触发异常。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>ExceptionNestedException </span><span class=rvts20>呢？到目前咱们还没有遇到过，什么情况会用到它？</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>从字面上看</span><span class=rvts15> ExceptionNestedException </span><span class=rvts20>大概意思是“嵌套的异常”，是不是可以理解为“处理异常过程中再次触发的异常”？比如类似于</span><span class=rvts15> ExceptionCollidedUnwind</span><span class=rvts20>，只不过</span><span class=rvts15> ExceptionCollidedUnwind </span><span class=rvts20>是在展开过程。而</span><span class=rvts15> ExceptionNestedException </span><span class=rvts20>是在处理异常过程中？</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>咱们顺着这个思路去寻找，首先来看</span><span class=rvts15> PassThrough!_except_handler4</span><span class=rvts20>，它是异常处理的入口了。处理和展开都是它负责的。可是翻遍了它和它的工具函数的反汇编码也没有找到它直接返回或者通过注册异常处理信息来间接返回。于是我决定继续向上层即调用者方向搜寻，于是找到了如下汇编码：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf RtlpExecuteHandlerForException</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!RtlpExecuteHandlerForException </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>87</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b4c</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts23>offset</span><span class=rvts15> nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x3a</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80887bc2</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b51</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler </span><span class=rvts19>(</span><span class=rvts24>80887b5c</span><span class=rvts19>)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>160</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5c</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5e</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b5f</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b61</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b63</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b65</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b67</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b6b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b6f</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b73</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b77</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>20h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b7b</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2 </span><span class=rvts19>(</span><span class=rvts24>80887b88</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b80</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b81</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b82</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b83</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>14h</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf ExecuteHandler2</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2 </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>188</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b88</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b89</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8e</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b8f</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b96</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>],</span><span class=rvts27>esp</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>注册新的异常处理结构</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887b9d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>14h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba0</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba3</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba6</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887ba9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>18h</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bac</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bae</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bb5</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbc</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbe</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bbf</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>14h</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf </span><span class=rvts24>80887bc2</span><span class=rvts15> </span><span class=rvts21>; ExecuteHandler2 </span><span class=rvts22>使用的异常处理函数</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x3a</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>268</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bc2</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bc6</span><span class=rvts15>&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bcd</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>1</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionContinueSearch (1)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bd2</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x5e</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80887be6</span><span class=rvts19>)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x4c</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>279</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bd4</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]&nbsp;&nbsp; </span><span class=rvts21>; ecx = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bd8</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edx = pContext</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bdc</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ecx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; eax = pExceptionRegistration-&gt;prev</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887bdf</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edx</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pDispatcherContext-&gt;RegistrationPointer = pExceptionRegistration-&gt;prev</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887be1</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>2</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionNestedException (2)</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!ExecuteHandler2</span><span class=rvts19>+</span><span class=rvts24>0x5e</span><span class=rvts15> </span><span class=rvts19>[C:</span><span class=rvts15>\wrk\wrk</span><span class=rvts19>-</span><span class=rvts15>v1.2\base\ntos\rtl\i386\xcptmisc.asm @ </span><span class=rvts24>287</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80887be6</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>10h</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>函数是在</span><span class=rvts15> </span><span class=rvts14>RtlDispatchException </span><span class=rvts28>中被调用。</span><span class=rvts14>RtlDispatchException </span><span class=rvts28>在遍历异常链过程中并不直接调用</span><span class=rvts14> EXCEPTION_REGISTRATION_RECORD::Handler</span><span class=rvts28>，而是通过</span><span class=rvts14> </span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>来间接调用。</span><span class=rvts15>RtlpExecuteHandlerForException </span><span class=rvts20>通过</span><span class=rvts15> ExecuteHandler2 </span><span class=rvts20>建立一个异常处理块。</span><span class=rvts15> </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>PassThrough!_except_handler4 </span><span class=rvts20>处理异常的过程中，如果在调用</span><span class=rvts15> lpfnFilter </span><span class=rvts20>时再次触发异常，则会由地址为</span><span class=rvts15> 80887bc2 </span><span class=rvts20>的异常处理函数返回</span><span class=rvts15> ExceptionNestedException</span><span class=rvts20>。因为这几个函数都很简单，而且跟之前分析的函数很类似，不再赘述。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>需要注意的是，只有</span><span class=rvts15> lpfnFilter </span><span class=rvts20>中触发异常才会返回</span><span class=rvts15> ExceptionNestedException</span><span class=rvts20>。在</span><span class=rvts15> lpfnHandler </span><span class=rvts20>中触发异常是不会的，原因是，在调用</span><span class=rvts15> lpfnHandler </span><span class=rvts20>之前，</span><span class=rvts15>_except_handler4 </span><span class=rvts20>会调用</span><span class=rvts15> RtlUnwind </span><span class=rvts20>进行全局展开，这个展开过程中会清理无用的</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD</span><span class=rvts20>，于是</span><span class=rvts15> ExecuteHandler2 </span><span class=rvts20>注册的地址为</span><span class=rvts15> 80887bc2 </span><span class=rvts20>异常处理函数也被摘掉了，于是也就不会返回</span><span class=rvts15> ExceptionNestedException</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>用一段代码和我画了一副草图来帮助理解，图中的</span><span class=rvts15> E.R.R. </span><span class=rvts20>是</span><span class=rvts15> EXCEPTION_REGISTRATION_RECORD </span><span class=rvts20>的简写。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>1</span><span class=rvts15>&nbsp; VOID SehTest</span><span class=rvts19>()</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>2</span><span class=rvts15>&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>3</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>4</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>5</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>6</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>7</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>*((</span><span class=rvts15>PULONG</span><span class=rvts19>)</span><span class=rvts24>0</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts17>NULL</span><span class=rvts19>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>9</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts19>(*((</span><span class=rvts15>PULONG</span><span class=rvts19>)</span><span class=rvts24>1</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts17>NULL</span><span class=rvts19>,</span><span class=rvts15> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>10</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>11</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>*((</span><span class=rvts15>PULONG</span><span class=rvts19>)</span><span class=rvts24>2</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts19>=</span><span class=rvts15> </span><span class=rvts17>NULL</span><span class=rvts19>;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>12</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>13</span><span class=rvts15> </span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>14</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts19>(</span><span class=rvts29>"__try[%u]\n"</span><span class=rvts19>,</span><span class=rvts15> __LINE__</span><span class=rvts19>);</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>15</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>16</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; __except</span><span class=rvts19>(</span><span class=rvts15>EXCEPTION_EXECUTE_HANDLER</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>17</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>{</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>18</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DbgPrint</span><span class=rvts19>(</span><span class=rvts29>"__finally[%u]\n"</span><span class=rvts19>,</span><span class=rvts15> __LINE__</span><span class=rvts19>);</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>19</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>}</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>20</span><span class=rvts15> </span><span class=rvts19>}</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>第</span><span class=rvts15>9</span><span class=rvts20>行</span><span class=rvts15> lpfnFilter </span><span class=rvts20>触发新异常的情况：</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PassThrough!SehTest </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | KiDispatchException @1 </span><span class=rvts20>的</span><span class=rvts15> E.R.R |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ExecuteHandler2 @1 </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp;&nbsp; | &lt;</span><span class=rvts20>这个</span><span class=rvts15> E.R.R. </span><span class=rvts20>返回</span><span class=rvts15> ExceptionNestedException&gt;</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+ &lt;- fs:[0]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>第</span><span class=rvts15>11</span><span class=rvts20>行</span><span class=rvts15> lpfnHandler </span><span class=rvts20>触发异常的情况（假设第</span><span class=rvts15>9</span><span class=rvts20>行没有触发异常）</span><span class=rvts15>:</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>1. </span><span class=rvts20>在调用</span><span class=rvts15> lpfnFilter </span><span class=rvts20>之后，调用</span><span class=rvts15> RtlUnwind </span><span class=rvts20>之前</span><span class=rvts15> </span><span class=rvts20>（自然也在</span><span class=rvts15> lpfnHandler </span><span class=rvts20>之前）的异常链</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PassThrough!SehTest </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | KiDispatchException @1 </span><span class=rvts20>的</span><span class=rvts15> E.R.R |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ExecuteHandler2 @1 </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+&nbsp; &lt;- fs:[0]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>2. </span><span class=rvts20>调用</span><span class=rvts15> RtlUnwind </span><span class=rvts20>之后，调用</span><span class=rvts15> lpfnHandler </span><span class=rvts20>之前</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +--------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PassThrough!SehTest </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +--------------------------------+&nbsp; &lt;- fs:[0]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | </span><span class=rvts20>被</span><span class=rvts15> RtlUnwind </span><span class=rvts20>清理掉的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>3. </span><span class=rvts20>调用</span><span class=rvts15> lpfnHandler </span><span class=rvts20>，触发异常，处理这个新异常</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PassThrough!SehTest </span><span class=rvts20>的</span><span class=rvts15> E.R.R&nbsp;&nbsp;&nbsp; |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | KiDispatchException @2 </span><span class=rvts20>的</span><span class=rvts15> E.R.R |</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +---------------------------------+&nbsp; &lt;- fs:[0]</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>（注：</span><span class=rvts15>x86 wrk </span><span class=rvts20>中，对于</span><span class=rvts15> nt!ExecuteHandler2+0x3a</span><span class=rvts20>，</span><span class=rvts15>nt!RtlIsValidHandler </span><span class=rvts20>总会返回</span><span class=rvts15> FALSE</span><span class=rvts20>，导致</span><span class=rvts15> RtlDispatchException </span><span class=rvts20>返回</span><span class=rvts15> FALSE</span><span class=rvts20>。我在原版</span><span class=rvts15> win2k3 </span><span class=rvts20>系统中调试是没这个问题的。于是，我在调试</span><span class=rvts15> wrk </span><span class=rvts20>的过程中把</span><span class=rvts15> nt!RtlIsValidHandler </span><span class=rvts20>修改为总是返回</span><span class=rvts15> TRUE</span><span class=rvts20>。由于对这个不是很关注，所以具体的原因我没有细分析。）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>小结：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>lpfnFilter </span><span class=rvts20>中触发异常会导致返回</span><span class=rvts15> ExceptionNestedException</span><span class=rvts20>。（派发异常过程中会找到自身所在的</span><span class=rvts15> EXCEPTION_REGISTRATION</span><span class=rvts20>，而其中的</span><span class=rvts15> trylevel </span><span class=rvts20>指向的</span><span class=rvts15> scopetable_entry </span><span class=rvts20>的</span><span class=rvts15> lpfnFilter </span><span class=rvts20>就是自身，于是导致递归异常，最终栈溢出）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>lpfnHandler </span><span class=rvts20>中触发的异常的处理流程跟普通的异常一样。（在示例代码中，这个新异常最终会被</span><span class=rvts15>16</span><span class=rvts20>行的</span><span class=rvts15> lpfnFilter </span><span class=rvts20>和</span><span class=rvts15>17-19</span><span class=rvts20>行的</span><span class=rvts15> lpHandler </span><span class=rvts20>处理）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>分析完这些，我有个疑问还是没有解开，我个人一直很奇怪增强版的使用方式为何不能这样：</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except()</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __finally</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其中</span><span class=rvts15> __except </span><span class=rvts20>过滤块和处理块可以省略。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>但是很遗憾，</span><span class=rvts15>MSC </span><span class=rvts20>中</span><span class=rvts15> __except </span><span class=rvts20>和</span><span class=rvts15> __finally </span><span class=rvts20>只能选其一。（当然，咱们可以用双层</span><span class=rvts15> __try </span><span class=rvts20>来实现同样的效果，但是总感觉不太爽，特别是会导致代码块被迫缩进两次）</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>在分析的过程中我也发现我希望的这种方式更合理一些，</span><span class=rvts15>__except </span><span class=rvts20>负责处理异常，在处理异常代码中被执行。如果没有处理异常，那么在展开过程中</span><span class=rvts15> __finally </span><span class=rvts20>代码块被执行，做一些清理操作。这样两者都存在，各负责各的，不是更好吗？不知道是不是什么历史原因。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>还有一个地方我也觉得不太完美。我们分析原始版本的时候发现，原始版本自身并没有直接使用展开，</span><span class=rvts15>RtlDispatchException </span><span class=rvts20>等异常处理函数并没有直接调用</span><span class=rvts15> RtlUnwind</span><span class=rvts20>。后者实际上是在增强版中才用到。我个人感觉这种模型并不完美，原始版本并没有自成体系，而是与增强版纠结在一起，没有很好的分层。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>另外，在实际应用中</span><span class=rvts15> SEH </span><span class=rvts20>机制可能会导致很难分析的内存泄漏。我们来看一个例子，</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>调用流程：</span><span class=rvts15>func1 -&gt; func2</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其中，</span><span class=rvts15>func1 </span><span class=rvts20>的代码如下：</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VOID Func1()</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __try</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Func2();</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __except(EXCEPTION_EXECUTE_HANDLER)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span class=rvts20>一些善后处理</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>Func2 </span><span class=rvts20>没有应用</span><span class=rvts15> SEH</span><span class=rvts20>，它申请了一块内存，对这块内存进行操作，然后释放该内存。但是在操作内存时候触发异常，异常被</span><span class=rvts15> Func1 </span><span class=rvts20>处理了，但是因为</span><span class=rvts15> Func2 </span><span class=rvts20>没有</span><span class=rvts15> __finally </span><span class=rvts20>处理块，于是展开过程中</span><span class=rvts15> Func2 </span><span class=rvts20>并没有机会去释放这块内存。结果就是：程序依然“正常”的在运行，但是实际上已经造成内存泄漏。随着程序执行，泄漏的资源可能越来越多，最后导致严重的系统故障。</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts20>遇到这种问题，程序猿通过静态分析是很难找到泄漏的原因的。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>到这里差不多就啰嗦完了。最后，来一段总结。</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>本文只是我分析</span><span class=rvts15> x86 </span><span class=rvts20>下</span><span class=rvts15> windows </span><span class=rvts20>异常处理机制过程的一些笔记的集合。因为兴趣的原因，我只分析了内核部分，应用层</span><span class=rvts15> SEH </span><span class=rvts20>我没有琢磨。感兴趣的朋友可以参考《软件调试》中的相关内容，貌似挺详细的。</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>后续我会抽时间再琢磨琢磨</span><span class=rvts15> x64 </span><span class=rvts20>下</span><span class=rvts15> windows </span><span class=rvts20>的异常处理机制，前段时间查阅</span><span class=rvts15> x64 </span><span class=rvts20>资料的时候看到其异常处理机制调整了很多，比如</span><span class=rvts15> EXCEPTION_REGISTRATION </span><span class=rvts20>不在是放在栈上，而是做成表。如果内部实现改变的较多，我会再写一份笔记来分享。</span><span class=rvts15>sinister </span><span class=rvts20>师傅有过这么一段话，我很认同：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>“交流都是建立在平等的基础上，在抱怨氛围和环境不好的同时应该先想一想自己究竟付出了多少？只知索取不愿付出的人也就不用抱怨了，要怪也只能怪自己。发自己心得的人无非是两种目的，一是引发一些讨论，好纠正自己错误的认识，以便从中获取更多的知识使自己进步的更快。二是做一份备忘，当自己遗忘的时候能够马上找到相关资料。”</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>其中提到的两种目的我都有</span><span class=rvts15> :-)</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>还是那句老话，</span><span class=rvts15>FIXME</span><span class=rvts20>。</span></p>
<p><span class=rvts15><br></span></p>
<p class=rvps2><span class=rvts30><br></span></p>
<p><span class=rvts30><br></span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>附录</span><span class=rvts15>1 </span><span class=rvts20>《</span><span class=rvts15>Ntfs!_except_handler3 </span><span class=rvts20>的反汇编代码》</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf Ntfs!_except_handler3</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;nt!_except_handler3 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 172]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c00</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c01</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,</span><span class=rvts27>esp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c03</span><span class=rvts15>&nbsp; </span><span class=rvts17>sub</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>8</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c06</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c07</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c08</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c09</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c0a</span><span class=rvts15>&nbsp; </span><span class=rvts17>cld</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c0b</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c0e</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRecord</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c11</span><span class=rvts15>&nbsp; </span><span class=rvts17>test</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>6</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; test pExceptionRecord-&gt;ExceptionFlags, (EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND)</span></p>
<p><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c18</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xc9</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cc9</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x1e [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 202]:</span></p>
<p><span class=rvts21>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; ebp-8 </span><span class=rvts22>和</span><span class=rvts21> ebp-4 </span><span class=rvts22>是一个类型为</span><span class=rvts21> PEXCEPTION_POINTERS </span><span class=rvts22>的结构体，称之为</span><span class=rvts21> l_ExceptionPointers</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c1e</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionPointers-&gt;ExceptionRecord = pExceptionRecord</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c21</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pContext</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c24</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; l_ExceptionPointers-&gt;ContextRecord = pContext</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c27</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,[</span><span class=rvts27>ebp</span><span class=rvts19>-</span><span class=rvts24>8</span><span class=rvts19>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; eax = lException</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c2a</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>-</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ebx-4 </span><span class=rvts22>指向</span><span class=rvts21> pExceptionRegistration </span><span class=rvts22>所在栈上类型为</span><span class=rvts21> PEXCEPTION_POINTERS </span><span class=rvts22>的变量</span></p>
<p><span class=rvts15>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>具体栈的构造形式请参考当时建立</span><span class=rvts21> pExceptionRegistration </span><span class=rvts22>的代码</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>这里是赋值给该</span><span class=rvts21> PEXCEPTION_POINTERS </span><span class=rvts22>变量，以提供给</span><span class=rvts21> GetExceptionInformation </span><span class=rvts22>和</span><span class=rvts21> GetExceptionCode </span><span class=rvts22>使用</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c2d</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; esi = pExceptionRegistration-&gt;trylevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c30</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; edi = pExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c33</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c34</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!_ValidateEH3RN </span><span class=rvts19>(</span><span class=rvts24>8087cde8</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c39</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>4</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c3c</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c3e</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xbb</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cbb</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x40 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 218]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c40</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFFh</span><span class=rvts15>&nbsp; </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel, TRYLEVEL_NONE</span></p>
<p><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c43</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xc2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cc2</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x45 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 220]:</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c45</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; esi *= 3; </span><span class=rvts22>下面要将</span><span class=rvts21> eis*4</span><span class=rvts22>，总共</span><span class=rvts21> esi*12</span><span class=rvts22>，这是因为</span><span class=rvts21> scopetable_entry </span><span class=rvts22>大小是</span><span class=rvts21>12</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c48</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edi</span><span class=rvts19>+</span><span class=rvts27>ecx</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; eax = pExceptionRegistration-&gt;scopetable[i].lpfnFilter</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c4c</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts19>:::&lt;</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c4e</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xa9</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872ca9</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; lpfnFilter </span><span class=rvts22>为</span><span class=rvts21> NULL </span><span class=rvts22>则跳转</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x50 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 226]:</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c50</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c51</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c52</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp = pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c55</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c57</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>ecx</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c59</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c5b</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>esi</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c5d</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c5f</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;scopetable[i].lpfnFilter()</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c61</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c62</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c63</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebx = pExceptionRegistration</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c66</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts27>eax</span></p>
<p><span class=rvts19>::::&lt;</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c68</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xa9</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872ca9</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; EXCEPTION_CONTINUE_SEARCH</span></p>
<p><span class=rvts19>:::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x6a [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 245]:</span></p>
<p><span class=rvts19>:::::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>如果</span><span class=rvts21> lpfnFilter </span><span class=rvts22>返回</span><span class=rvts21> EXCEPTION_CONTINUE_EXECUTION</span><span class=rvts22>，跳过下面的展开操作</span></p>
<p><span class=rvts19>:::::&lt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c6a</span><span class=rvts15>&nbsp; </span><span class=rvts17>js</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xb4</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cb4</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; EXCEPTION_CONTINUE_EXECUTION</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0x6c [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 249]:</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; lpfnFilter </span><span class=rvts22>返回</span><span class=rvts21> EXCEPTION_EXECUTE_HANDLER</span><span class=rvts22>，开始展开</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c6c</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; edi = pExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c6f</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c70</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!__global_unwind2 </span><span class=rvts19>(</span><span class=rvts24>80872520</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c75</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>4</span></p>
<p><span class=rvts19>:::::::</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c78</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; ebp = pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c7b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>展开到当前</span><span class=rvts21> trylevel </span><span class=rvts22>为止（不包含本</span><span class=rvts21> scopetable_entry</span><span class=rvts22>）</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c7c</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c7d</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!__local_unwind2 </span><span class=rvts19>(</span><span class=rvts24>8087257b</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c82</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>8</span></p>
<p><span class=rvts19>:::::::</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c85</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c88</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>1</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c8a</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edi</span><span class=rvts19>+</span><span class=rvts27>ecx</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;scopetable[i].lpfnHandler</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c8e</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!_NLG_Notify </span><span class=rvts19>(</span><span class=rvts24>80872617</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c93</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edi</span><span class=rvts19>+</span><span class=rvts27>ecx</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; </span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c96</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>eax</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel = RegistrationPointer-&gt;scopetable[i].previousTryLevel</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c99</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edi</span><span class=rvts19>+</span><span class=rvts27>ecx</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;scopetable[i].lpfnHandler </span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c9d</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,</span><span class=rvts27>ebx</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872c9f</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,</span><span class=rvts27>ecx</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ca1</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edx</span><span class=rvts19>,</span><span class=rvts27>edx</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ca3</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts27>esi</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ca5</span><span class=rvts15>&nbsp; </span><span class=rvts17>xor</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,</span><span class=rvts27>edi</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ca7</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts15> </span><span class=rvts21>; pExceptionRegistration-&gt;scopetable[i].lpfnHandler(); </span><span class=rvts22>这里不会返回的！！</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0xa9 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 285]:</span></p>
<p><span class=rvts19>:::::::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>找到</span><span class=rvts21> scopetable </span><span class=rvts22>中的下一个</span><span class=rvts21> scopetable_entry</span><span class=rvts22>，继续循环</span></p>
<p><span class=rvts19>:::&gt;&gt;::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ca9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cac</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872caf</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>edi</span><span class=rvts19>+</span><span class=rvts27>ecx</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15> </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cb2</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0x40</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872c40</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>;nt!_except_handler3+0xb4 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 291]:</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp; </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cb4</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>0</span><span class=rvts15> </span><span class=rvts21>; eax = ExceptionContinueExecution (0)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cb9</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xde</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cde</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0xbb [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 295]:</span></p>
<p><span class=rvts19>:&gt;:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cbb</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cbe</span><span class=rvts15>&nbsp; </span><span class=rvts17>or</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>8</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp; </span><span class=rvts21>;nt!_except_handler3+0xc2 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 298]:</span></p>
<p><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cc2</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>1 </span><span class=rvts21>; eax = ExceptionContinueSearch (1)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cc7</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_except_handler3</span><span class=rvts19>+</span><span class=rvts24>0xde</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872cde</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts21>;nt!_except_handler3+0xc9 [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 302]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>设置了</span><span class=rvts21>(EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND)</span><span class=rvts22>，开始展开</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cc9</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cca</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span><span class=rvts19>,[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>;ebp = pExceptionRegistration-&gt;_ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872ccd</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>0FFFFFFFFh</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872ccf</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cd0</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!__local_unwind2 </span><span class=rvts19>(</span><span class=rvts24>8087257b</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cd5</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>8</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cd8</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cd9</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,</span><span class=rvts24>1 </span><span class=rvts21>eax = ExceptionContinueSearch (1)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts21>;nt!_except_handler3+0xde [d:\dnsrv\base\crts\crtw32\misc\i386\exsup3.asm @ 313]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>&gt;&gt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>80872cde</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872cdf</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ce0</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ce1</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ce2</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ce4</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872ce5</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>附录</span><span class=rvts15>2 </span><span class=rvts20>《</span><span class=rvts15>nt!__local_unwind2 </span><span class=rvts20>的反汇编代码》</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kd</span><span class=rvts19>&gt;</span><span class=rvts15> uf __local_unwind2</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__local_unwind2 </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>205</span><span class=rvts19>]:</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087257b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087257c</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087257d</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087257e</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>10h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872582</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebp</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872583</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872584</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>0FFFFFFFEh</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872586</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts23>offset</span><span class=rvts15> nt!__unwind_handler </span><span class=rvts19>(</span><span class=rvts24>80872540</span><span class=rvts19>)</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087258b</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872592</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>],</span><span class=rvts27>esp</span><span class=rvts15> </span><span class=rvts21>; __local_unwind2 </span><span class=rvts22>自身也会构建</span><span class=rvts21> _EXCEPTION_REGISTRATION</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x1e</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>222</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>80872599</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>24h</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; eax = pExceptionRegistration</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>8087259d</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; ebx = pExceptionRegistration-&gt;scopetable</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725a0</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>]</span><span class=rvts15> </span><span class=rvts21>; esi = pExceptionRegistration-&gt;trylevel</span></p>
<p><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725a3</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,</span><span class=rvts24>0FFFFFFFFh</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; cmp pExceptionRegistration-&gt;trylevel, TRYLEVEL_NONE</span></p>
<p><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725a6</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!_NLG_Return2</span><span class=rvts19>+</span><span class=rvts24>0x2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808725dd</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x2d</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>228</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725a8</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>28h</span><span class=rvts19>],</span><span class=rvts24>0FFFFFFFFh</span></p>
<p><span class=rvts19>::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725ad</span><span class=rvts15>&nbsp; </span><span class=rvts17>je</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x3a</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808725b5</span><span class=rvts19>)</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; </span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x34</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>230</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>:::</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725af</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>28h</span><span class=rvts19>]</span></p>
<p><span class=rvts19>:::&lt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725b3</span><span class=rvts15>&nbsp; </span><span class=rvts17>jbe</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_NLG_Return2</span><span class=rvts19>+</span><span class=rvts24>0x2</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>808725dd</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; </span></p>
<p><span class=rvts19>::::</span><span class=rvts15>&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x3a</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>234</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::&gt;:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725b5</span><span class=rvts15>&nbsp; </span><span class=rvts17>lea</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span><span class=rvts19>,[</span><span class=rvts27>esi</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>2</span><span class=rvts19>]</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725b8</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ecx</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>]</span><span class=rvts15>&nbsp; </span><span class=rvts21>; move ecx, [pExceptionRegistration-&gt;scopetable[i].previousTryLevel]</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725bb</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>esp</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; </span><span class=rvts22>这个</span><span class=rvts21> esp+8 </span><span class=rvts22>只写没读，什么情况？</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725bf</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>eax</span><span class=rvts19>+</span><span class=rvts24>0Ch</span><span class=rvts19>],</span><span class=rvts27>ecx</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;trylevel = ecx</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725c2</span><span class=rvts15>&nbsp; </span><span class=rvts17>cmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>4</span><span class=rvts19>],</span><span class=rvts24>0</span><span class=rvts15>&nbsp; </span><span class=rvts21>; cmp pExceptionRegistration-&gt;scopetable-&gt;lpfnFilter, NULL</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>:&lt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725c7</span><span class=rvts15>&nbsp; </span><span class=rvts17>jne</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!_NLG_Return2 </span><span class=rvts19>(</span><span class=rvts24>808725db</span><span class=rvts19>)</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> </span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x4e</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>243</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts21>; RegistrationPointer-&gt;scopetable-&gt;lpfnFilter </span><span class=rvts22>等于</span><span class=rvts21> NULL</span><span class=rvts22>，即这里是</span><span class=rvts21> __try &amp; __finally </span><span class=rvts22>的组合</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725c9</span><span class=rvts15>&nbsp; </span><span class=rvts17>push</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>101h</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725ce</span><span class=rvts15>&nbsp; </span><span class=rvts17>mov</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>eax</span><span class=rvts19>,dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725d2</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; nt!_NLG_Notify </span><span class=rvts19>(</span><span class=rvts24>80872617</span><span class=rvts19>)</span><span class=rvts15>&nbsp; </span><span class=rvts21>; </span><span class=rvts22>这个函数对理解</span><span class=rvts21> SEH </span><span class=rvts22>不重要，可以暂时忽略</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725d7</span><span class=rvts15>&nbsp; </span><span class=rvts17>call</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts27>ebx</span><span class=rvts19>+</span><span class=rvts27>esi</span><span class=rvts19>*</span><span class=rvts24>4</span><span class=rvts19>+</span><span class=rvts24>8</span><span class=rvts19>]</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts21>; pExceptionRegistration-&gt;scopetable-&gt;lpfnHandler()</span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> </span></p>
<p><span class=rvts19>::</span><span class=rvts15> </span><span class=rvts19>::</span><span class=rvts15> nt!_NLG_Return2 </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>251</span><span class=rvts19>]:</span></p>
<p><span class=rvts19>&lt;:</span><span class=rvts15> </span><span class=rvts19>:&gt;</span><span class=rvts15>&nbsp;&nbsp; </span><span class=rvts24>808725db</span><span class=rvts15>&nbsp; </span><span class=rvts17>jmp</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; nt!__local_unwind2</span><span class=rvts19>+</span><span class=rvts24>0x1e</span><span class=rvts15> </span><span class=rvts19>(</span><span class=rvts24>80872599</span><span class=rvts19>)</span><span class=rvts15> </span><span class=rvts21>; </span><span class=rvts22>循环</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span></p>
<p><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15> </span><span class=rvts19>:</span><span class=rvts15>&nbsp; nt!_NLG_Return2</span><span class=rvts19>+</span><span class=rvts24>0x2</span><span class=rvts15> </span><span class=rvts19>[</span><span class=rvts15>d</span><span class=rvts19>:</span><span class=rvts15>\dnsrv\base\crts\crtw32\misc\i386\exsup.asm @ </span><span class=rvts24>253</span><span class=rvts19>]:</span></p>
<p><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15> </span><span class=rvts19>&gt;</span><span class=rvts15>&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725dd</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts19>dword</span><span class=rvts15> </span><span class=rvts23>ptr</span><span class=rvts15> </span><span class=rvts27>fs</span><span class=rvts19>:[</span><span class=rvts24>0</span><span class=rvts19>]</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725e4</span><span class=rvts15>&nbsp; </span><span class=rvts17>add</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esp</span><span class=rvts19>,</span><span class=rvts24>10h</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725e7</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>edi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725e8</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>esi</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725e9</span><span class=rvts15>&nbsp; </span><span class=rvts17>pop</span><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts27>ebx</span></p>
<p><span class=rvts15>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=rvts24>808725ea</span><span class=rvts15>&nbsp; </span><span class=rvts17>ret</span></p>
<p><span class=rvts17><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>参考资料：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>[1] wrk </span><span class=rvts20>源码</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>[2] A Crash Course on the Depths of Win32</span><span class=rvts20>™</span><span class=rvts15> Structured Exception Handling, Matt Pietrek</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>[3] </span><span class=rvts20>《</span><span class=rvts15>Windows </span><span class=rvts20>内核原理与实现》潘爱民</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts15>[4] </span><span class=rvts20>《软件调试》张银奎</span></p>
<p><span class=rvts15><br></span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts20>历史：</span></p>
<p><span class=rvts15> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.0, 2011-10-05</span><span class=rvts10>，最初版本</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.1, 2011-10-06</span><span class=rvts10>，补充总结之前的资源泄漏示例</span></p>
<p><span class=rvts9> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class=rvts9>v1.0.2, 2011-10-19</span><span class=rvts10>，修正一处笔误；增加</span><span class=rvts9> </span><span class=rvts15>ExceptionNestedException </span><span class=rvts20>返回值的补充说明。</span></p>
<p><br></p>
<p><br></p>
</body></html>
